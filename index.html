<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Perchel - Premium Gastronomy Journal</title>
    
    <meta name="referrer" content="no-referrer">
    
    <meta name="color-scheme" content="light only">
    <meta name="theme-color" content="#FF5A20" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#FF5A20" media="(prefers-color-scheme: dark)">
    
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/images/logo.png">
    
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=1bf29ed9131417186b665259385414f8&libraries=services&autoload=false"></script>
    
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        /* =========================================================
           [1] ê¸€ë¡œë²Œ í…Œë§ˆ: ì‹œì•ˆê³¼ ë™ì¼í•œ í´ë¦° í™”ì´íŠ¸ & ì˜¤ë Œì§€ í¬ì¸íŠ¸
           ========================================================= */
        :root {
            --bg-main: #F7F7F9;            
            --bg-card: #FFFFFF;            
            
            --brand-primary: #1C1E21;      
            --brand-fab: #FF5A20;          
            --brand-yellow: #FFC107;       
            
            --text-main: #111111;          
            --text-sub: #7A7C80;           
            --border-color: #EAEAEA;       
            
            --tag-pink-bg: rgba(255, 90, 32, 0.15); 
            --tag-pink-txt: #FF7E5F; 
            --tag-green-bg: rgba(74, 99, 78, 0.15); 
            --tag-green-txt: #4A634E;
            --tag-orange-bg: rgba(221, 167, 123, 0.15); 
            --tag-orange-txt: #A67046; 
            --tag-blue-bg: rgba(28, 30, 33, 0.1); 
            --tag-blue-txt: #1C1E21;
            
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.05); 
            --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.08);
            --shadow-fab: 0 8px 24px rgba(255, 90, 32, 0.35);
            
            --radius-xl: 24px; 
            --radius-lg: 16px; 
            --radius-md: 12px;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
        }

        /* ğŸš¨ [ìˆ˜ì • 2] ë‹¤í¬ëª¨ë“œ ë°©ì§€ë¥¼ ìœ„í•œ ë°°ê²½/ê¸€ììƒ‰ ê°•ì œ(!important) ì ìš© */
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: var(--bg-main) !important; 
            color: var(--text-main) !important; 
            line-height: 1.6; 
            overflow-x: hidden; 
            -webkit-font-smoothing: antialiased; 
            color-scheme: light !important;
        }

        .s-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--brand-yellow);
            color: #000;
            font-size: 10px;
            font-weight: 900;
            padding: 4px 8px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(255, 193, 7, 0.3);
            border: 2px solid #FFF;
            z-index: 10;
            letter-spacing: -0.5px;
        }

        /* =========================================================
           [2] ìŠ¤í”Œë˜ì‹œ ì¸íŠ¸ë¡œ
           ========================================================= */
        #splash-screen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: #FFFFFF !important; 
            z-index: 9999; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            transition: opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1), transform 0.6s cubic-bezier(0.16, 1, 0.3, 1); 
        }

        .splash-content { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }

        .splash-logo-wrapper {
            overflow: hidden; 
            padding-bottom: 5px;
        }

        .splash-logo { 
            font-size: 52px; 
            font-weight: 900; 
            color: var(--brand-primary); 
            font-style: italic; 
            letter-spacing: -2px; 
            transform: translateY(100%); 
            opacity: 0;
            filter: blur(8px); 
            animation: slideUpReveal 0.9s cubic-bezier(0.16, 1, 0.3, 1) forwards; 
        }

        .splash-logo .dot {
            color: var(--brand-fab); 
        }

        .splash-line {
            width: 0px;
            height: 3px;
            background: var(--brand-fab);
            margin: 10px 0;
            border-radius: 2px;
            animation: expandLine 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.4s forwards;
        }

        .splash-sub { 
            font-size: 11px; 
            color: var(--text-sub); 
            text-transform: uppercase; 
            font-weight: 700;
            letter-spacing: 0px; 
            opacity: 0; 
            transform: translateY(10px);
            animation: fadeExpand 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.5s forwards; 
        }

        @keyframes slideUpReveal { 
            to { transform: translateY(0); opacity: 1; filter: blur(0); } 
        }
        @keyframes expandLine {
            to { width: 30px; } 
        }
        @keyframes fadeExpand { 
            to { opacity: 1; letter-spacing: 4px; transform: translateY(0); } 
        }

        /* ğŸš¨ [ìˆ˜ì • 4] PWA ì•± ì„¤ì¹˜ ìœ ë„ íŒì—… CSS */
        #pwa-install-banner {
            display: none;
            position: fixed;
            bottom: 85px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: var(--brand-primary);
            color: white;
            padding: 12px 20px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 9998;
            align-items: center;
            justify-content: space-between;
            animation: slideUp 0.5s ease forwards;
        }
        .pwa-btn {
            background: var(--brand-fab);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 12px;
            cursor: pointer;
        }

        /* =========================================================
           [3] ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜
           ========================================================= */
        .top-bar { 
            width: 100%; 
            background: rgba(247, 247, 249, 0.9) !important; 
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            display: flex; 
            justify-content: center; 
            position: fixed; 
            top: 0; 
            left: 0; 
            z-index: 1000; 
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .top-bar.transparent {
            background: transparent !important;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-bottom: none;
        }
        
        .top-bar-content { 
            width: 100%; 
            max-width: 600px; 
            height: 70px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 24px; 
        }

        .top-logo { 
            font-size: 32px; 
            font-weight: 900; 
            color: var(--brand-primary); 
            cursor: pointer; 
            letter-spacing: -1.5px; 
            font-style: italic; 
            transition: color 0.3s ease;
        }

        .top-bar.transparent .top-logo { color: #FFFFFF; text-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        .top-bar.transparent .svg-icon { stroke: #FFFFFF; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4)); }
        .top-bar.transparent #global-region-select { color: #FFFFFF; text-shadow: 0 2px 4px rgba(0,0,0,0.4); }
        .top-bar.transparent .lang-toggle { color: #FFFFFF; border-color: rgba(255,255,255,0.6); }
        .top-bar.transparent .mentor-btn { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); color:#FFF;}

        #global-region-select {
            background: transparent; 
            border: none; 
            font-family: 'Pretendard', sans-serif; 
            font-weight: 700; 
            font-size: 14px; 
            color: var(--brand-primary); 
            outline: none; 
            cursor: pointer;
            padding-right: 5px;
            transition: color 0.3s ease;
        }

        #global-region-select option {
            background-color: #FFFFFF;
            color: #111111;
            text-shadow: none;
        }

        .mentor-btn { 
            background: var(--brand-primary); 
            color: #FFFFFF; 
            padding: 8px 14px; 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 4px; 
            cursor: pointer; 
            transition: all 0.3s ease;
        }

        .lang-toggle { 
            background: transparent; 
            padding: 4px 8px; 
            border-radius: 8px; 
            font-size: 11px; 
            font-weight: 600; 
            color: var(--text-sub); 
            border: 1px solid var(--border-color); 
            cursor: pointer; 
            transition: all 0.3s ease;
        }

        /* =========================================================
           [4] í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ & ì˜¤ë Œì§€ FAB
           ========================================================= */
        .bottom-nav { 
            display: flex; 
            position: fixed; 
            bottom: 0; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 100%; 
            max-width: 600px; 
            height: 70px; 
            background: rgba(255,255,255,0.95) !important; 
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color); 
            z-index: 1000; 
            padding: 0 10px env(safe-area-inset-bottom); 
        }

        .nav-item { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: var(--text-sub); 
            cursor: pointer; 
            font-size: 10px; 
            font-weight: 600; 
        }

        .nav-item.active { color: var(--brand-fab); }
        .nav-icon { width: 22px; height: 22px; margin-bottom: 4px; opacity: 0.8; transition: all 0.2s; }
        .nav-item.active .nav-icon { opacity: 1; stroke-width: 2.5; stroke: var(--brand-fab); }

        .nav-fab-wrapper { position: relative; width: 60px; display: flex; justify-content: center; }
        .nav-fab { 
            position: absolute; 
            top: -25px; 
            width: 56px; 
            height: 56px; 
            background: var(--brand-fab); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            box-shadow: var(--shadow-fab); 
            border: 4px solid var(--bg-main); 
            cursor: pointer; 
            z-index: 1001; 
        }
        .nav-fab svg { width: 24px; height: 24px; stroke: white; stroke-width: 2.5; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        
        /* =========================================================
           [5] ë©”ì¸ ë ˆì´ì•„ì›ƒ ë° ë²”ìš© ì¹´ë“œ
           ========================================================= */
        #main-content { 
            display: none; 
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto 100px; 
            padding: 0; 
        }
        
        .tab-view {
            padding-top: 70px; 
            padding-left: 24px;
            padding-right: 24px;
        }

        #home-view {
            padding: 0 !important; 
        }

        .home-section-container {
            padding: 0 24px; 
        }

        .home-top-banner {
            width: 100%;
            height: 480px; 
            border-radius: 0 0 32px 32px; 
            background-image: linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.1) 40%, rgba(0,0,0,0.85) 100%), url('https://images.unsplash.com/photo-1512621776951-a57141f2eefd?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80'); 
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 40px 24px 60px; 
            color: white !important;
            margin-bottom: 30px;
            box-shadow: var(--shadow-card);
        }

        .home-top-banner-title {
            font-size: 36px; 
            font-weight: 900;
            line-height: 1.3;
            margin-bottom: 12px;
            letter-spacing: -1px;
            text-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .home-top-banner-sub {
            font-size: 15px;
            font-weight: 500;
            opacity: 0.9;
            letter-spacing: -0.5px;
        }

        .section-title { 
            font-size: 18px; 
            font-weight: 800; 
            color: var(--text-main); 
            margin: 40px 0 20px; 
            display: flex;
            align-items: center;
        }

        .editor-row { 
            display: flex; 
            gap: 16px; 
            overflow-x: auto; 
            padding-bottom: 20px; 
            scrollbar-width: none; 
            scroll-snap-type: x mandatory; 
        }

        .editor-row::-webkit-scrollbar { 
            display: none; 
        }

        .editor-card { 
            background: linear-gradient(160deg, rgba(255, 255, 255, 0.9) 0%, rgba(224, 242, 241, 0.5) 100%);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            padding: 24px 16px; 
            border-radius: 20px; 
            min-width: 130px; 
            flex-shrink: 0; 
            text-align: center; 
            cursor: pointer; 
            box-shadow: 0 10px 30px rgba(0, 40, 60, 0.08); 
            border: 1px solid rgba(255, 255, 255, 0.8); 
            scroll-snap-align: start; 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .editor-card:active {
            transform: scale(0.96);
        }

        .editor-img-container { 
            width: 64px; 
            height: 64px; 
            margin: 0 auto 12px; 
            position: relative; 
            border-radius: 50%;
            background: linear-gradient(45deg, var(--brand-primary), #FF8C60);
            padding: 3px;
        }

        .avatar-circle { 
            width: 100%; 
            height: 100%; 
            border-radius: 50%; 
            overflow: hidden; 
            background: #FFFFFF; 
            border: 2px solid #FFFFFF; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .editor-follow-btn {
            background: var(--brand-fab) !important;
            color: #FFFFFF !important;
            border: none !important;
            font-weight: 800;
            padding: 10px 0 !important; 
            font-size: 12px !important;
            border-radius: 20px !important;
            margin-top: 14px !important;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 12px rgba(255, 90, 32, 0.3);
            transition: transform 0.2s;
        }

        .editor-follow-btn:active {
            transform: scale(0.95);
        }

        .card-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 16px; 
        }

        .rest-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-lg); 
            overflow: hidden; 
            padding: 12px; 
            box-shadow: var(--shadow-soft); 
            border: 1px solid var(--border-color);
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            transition: transform 0.2s;
        }

        .rest-card:active {
            transform: scale(0.98);
        }

        .rest-img-wrapper { 
            position: relative; 
            border-radius: var(--radius-md); 
            overflow: hidden; 
            aspect-ratio: 4/3; 
            margin-bottom: 12px; 
            background: #eee; 
        }

        .rest-img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }

        .rest-name { 
            font-weight: 800; 
            font-size: 15px; 
            margin-bottom: 4px; 
            color: var(--text-main); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }

        /* =========================================================
           [6] í•˜ì´ì—”ë“œ í”„ë¡œí•„ ë‹¤í¬ ì¹´ë“œ
           ========================================================= */
        .profile-dash { 
            background: linear-gradient(135deg, #0B1C1D, #162C2D) !important; 
            border-radius: var(--radius-xl); 
            padding: 40px 24px; 
            color: white !important; 
            margin-bottom: 30px; 
            text-align: center; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); 
            position: relative; 
            overflow: hidden;
        }

        .dash-pic-container { 
            width: 90px; 
            height: 90px; 
            border-radius: 50%; 
            margin: 0 auto 16px; 
            border: 3px solid rgba(255,255,255,0.2); 
            padding: 3px; 
            position: relative; 
            cursor: pointer;
        }

        .profile-philosophy { 
            font-size: 14px; 
            font-style: italic; 
            color: rgba(255,255,255,0.7) !important; 
            margin: 12px 0 20px; 
            line-height: 1.5; 
            font-weight: 500; 
        }

        .profile-dna-tags {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .dna-tag { 
            background: rgba(255,255,255,0.1); 
            color: #FFF !important; 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: 600; 
            display: inline-block; 
        }

        .dash-stats { 
            display: flex; 
            justify-content: space-around; 
            background: rgba(0,0,0,0.3); 
            padding: 20px; 
            border-radius: var(--radius-lg); 
            margin-top: 20px;
        }

        /* =========================================================
           [7] ì„œì—´í‘œ ë­í‚¹ UI
           ========================================================= */
        .tier-header-title { 
            font-size: 18px; 
            font-weight: 900; 
            color: var(--text-main); 
            margin: 40px 0 15px; 
            text-transform: uppercase; 
            letter-spacing: -0.5px; 
            border-bottom: 2px solid var(--border-color); 
            padding-bottom: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end; 
        }

        .guide-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
        }

        .guide-card { 
            position: relative; 
            width: 100%; 
            aspect-ratio: 1; 
            border-radius: 16px; 
            overflow: hidden; 
            box-shadow: var(--shadow-soft); 
            cursor: pointer; 
            background: #eee; 
        }

        .guide-card-bg { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: transform 0.4s ease; 
        }

        .guide-card:hover .guide-card-bg { 
            transform: scale(1.05); 
        }

        .guide-card-overlay { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%); 
            padding: 30px 12px 12px; 
            text-align: left; 
            color: white !important; 
            pointer-events: none; 
        }

        .guide-tier-text { 
            font-size: 10px; 
            font-weight: 900; 
            margin-bottom: 2px; 
            color: var(--brand-yellow) !important; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .guide-name-text { 
            font-size: 13px; 
            font-weight: 800; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }

        /* =========================================================
           [8] íŒì—… ëª¨ë‹¬ì°½ ë° ì¶”ê°€ ì†Œì…œ ë¡œê·¸ì¸ CSS
           ========================================================= */
        .bottom-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 2000; 
            align-items: flex-end; 
            justify-content: center; 
            backdrop-filter: blur(4px);
        }

        .modal-body { 
            background: var(--bg-card); 
            width: 100%; 
            max-width: 600px; 
            border-radius: 24px 24px 0 0; 
            display: flex; 
            flex-direction: column; 
            height: 88vh; 
            padding: 24px; 
            animation: slideUp 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }

        @keyframes slideUp { 
            from { transform: translateY(100%); } 
            to { transform: translateY(0); } 
        }

        .input-field { 
            width: 100%; 
            padding: 16px; 
            margin-bottom: 16px; 
            border-radius: 12px; 
            border: 1px solid var(--border-color); 
            background: var(--bg-main); 
            font-size: 14px; 
            outline: none; 
            transition: all 0.2s;
            color: var(--text-main);
        }

        .input-field:focus { 
            border-color: var(--brand-primary); 
            box-shadow: 0 0 0 3px rgba(255, 90, 32, 0.1);
        }

        .btn-primary { 
            width: 100%; 
            padding: 16px; 
            border-radius: 12px; 
            border: none; 
            background: var(--brand-primary); 
            color: white !important; 
            font-weight: 700; 
            font-size: 15px; 
            cursor: pointer; 
            transition: transform 0.2s;
        }

        .btn-primary:active { 
            transform: scale(0.98); 
        }
        
        .noti-badge { 
            position: absolute; 
            top: 0px; 
            right: 0px; 
            background: red; 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            display: none; 
            border: 1px solid white;
        }

        .svg-icon { 
            width: 24px; 
            height: 24px; 
            stroke: currentColor; 
            stroke-width: 2; 
            fill: none; 
            stroke-linecap: round; 
            stroke-linejoin: round; 
        }
        
        ::-webkit-scrollbar { 
            display: none; 
        }

        .multi-image-slider { 
            width: 100%; 
            display: flex; 
            overflow-x: auto; 
            scroll-snap-type: x mandatory; 
            gap: 10px; 
            padding-bottom: 10px; 
            scrollbar-width: none; 
            margin-bottom: 20px; 
        }
        
        .multi-image-slide { 
            flex: 0 0 100%; 
            height: 300px; 
            scroll-snap-align: center; 
            border-radius: var(--radius-lg); 
            object-fit: cover; 
            background: #111; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
        }

        .social-login-container {
            width: 100%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-kakao {
            width: 100%;
            height: 52px;
            background: #FEE500 !important;
            color: #191919 !important;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(254, 229, 0, 0.2);
        }

        /* ğŸš¨ [ìˆ˜ì • 2] ëª¨ë°”ì¼ ë°˜ì‘í˜• ì™„ë²½ ë³´ì • (Media Queries) */
        @media screen and (max-width: 600px) {
            .home-top-banner {
                height: 400px; 
                padding: 30px 20px 50px;
            }
            .home-top-banner-title {
                font-size: 30px;
            }
            .card-grid {
                grid-template-columns: repeat(2, 1fr); 
                gap: 12px;
            }
            .guide-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            .top-logo {
                font-size: 28px;
            }
            .top-bar-content {
                padding: 0 16px;
            }
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-content">
            <div class="splash-logo-wrapper">
                <div class="splash-logo">perchel<span class="dot">.</span></div>
            </div>
            <div class="splash-line"></div>
            <div class="splash-sub">Premium Gastronomy Journal</div>
        </div>
    </div>

    <div id="pwa-install-banner">
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="width:36px; height:36px; background:white; border-radius:10px; display:flex; justify-content:center; align-items:center; font-weight:900; color:var(--brand-primary);">P.</div>
            <div>
                <div style="font-size:13px; font-weight:800;">í¼ìŠ ì•± ì„¤ì¹˜í•˜ê¸°</div>
                <div style="font-size:11px; color:rgba(255,255,255,0.8);">ë°”íƒ•í™”ë©´ì—ì„œ í„°ì¹˜ í•œ ë²ˆì— ì ‘ì†í•˜ì„¸ìš”</div>
            </div>
        </div>
        <button class="pwa-btn" id="pwa-install-btn">ì„¤ì¹˜</button>
    </div>

    <div id="login-section" style="display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; padding: 20px; position: relative; z-index: 99999;">
        <div style="width: 80px; height: 80px; background: var(--brand-primary); border-radius: 24px; display: flex; justify-content: center; align-items: center; color: white; font-size: 42px; font-weight: 900; font-style: italic; margin-bottom: 40px; box-shadow: var(--shadow-soft);">
            p.
        </div>
        
        <h1 data-ko="í¼ìŠ ì…ì¥" data-en="Enter Perchel" style="color: var(--text-main); font-size: 28px; font-weight: 800; margin-bottom: 12px; letter-spacing: -0.5px;">
            í¼ìŠ ì…ì¥
        </h1>
        
        <p data-ko="ì†Œì…œ ê³„ì •ìœ¼ë¡œ ê°„í¸í•˜ê²Œ ì‹œì‘í•˜ì„¸ìš”" data-en="Start easily with your social account" style="color: var(--text-sub); font-size: 14px; margin-bottom: 40px; font-weight: 500;">
            ì†Œì…œ ê³„ì •ìœ¼ë¡œ ê°„í¸í•˜ê²Œ ì‹œì‘í•˜ì„¸ìš”
        </p>

        <div class="social-login-container">
            <button class="btn-kakao" onclick="loginWithKakao()">
                <svg viewBox="0 0 24 24" width="20" height="20" style="margin-right: 8px; fill: #191919;">
                    <path d="M12 3c-5.523 0-10 3.535-10 7.896 0 2.825 1.83 5.3 4.632 6.703-.306 1.135-1.11 4.148-1.14 4.31-.035.195.14.19.223.136.068-.044 3.593-2.457 5.044-3.486.41.037.828.058 1.25.058 5.523 0 10-3.535 10-7.896C22 6.535 17.523 3 12 3z"/>
                </svg>
                <span data-ko="ì¹´ì¹´ì˜¤ë¡œ 1ì´ˆ ë¡œê·¸ì¸" data-en="Continue with Kakao">ì¹´ì¹´ì˜¤ë¡œ 1ì´ˆ ë¡œê·¸ì¸</span>
            </button>

            <div style="margin-top: 10px; width: 100%; display: flex; justify-content: center;">
                <div id="g_id_onload"
                     data-client_id="725138598590-gjhd8dduh3ag3922il5pcrf15q1rjvvn.apps.googleusercontent.com"
                     data-context="signin"
                     data-ux_mode="popup"
                     data-callback="handleGoogleLogin"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-shape="rectangular"
                     data-theme="outline"
                     data-text="signin_with"
                     data-size="large"
                     data-logo_alignment="left"
                     data-width="320">
                </div>
            </div>
        </div>

        <p style="margin-top: 50px; color: var(--text-placeholder); font-size: 12px; text-align: center; line-height: 1.6;">
            ë¡œê·¸ì¸ ì‹œ í¼ìŠì˜ <span style="text-decoration: underline;">ì´ìš©ì•½ê´€</span> ë° <br>
            <span style="text-decoration: underline;">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</span>ì— ë™ì˜í•˜ê²Œ ë©ë‹ˆë‹¤.
        </p>
    </div>

    <div id="main-content">
        <header class="top-bar transparent" id="main-top-bar">
            <div class="top-bar-content">
                <div class="top-logo" onclick="switchTab('home')">perchel</div>
                <div style="display:flex; align-items:center; gap: 14px;">
                    
                    <select id="global-region-select" onchange="changeGlobalRegion()">
                        <option value="national" data-ko="ì „êµ­" data-en="National">ì „êµ­</option>
                        <option value="ì„œìš¸">ì„œìš¸</option>
                        <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                        <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
                        <option value="ì¸ì²œ">ì¸ì²œ</option>
                        <option value="ê´‘ì£¼">ê´‘ì£¼</option>
                        <option value="ëŒ€ì „">ëŒ€ì „</option>
                        <option value="ìš¸ì‚°">ìš¸ì‚°</option>
                        <option value="ì„¸ì¢…">ì„¸ì¢…</option>
                        <option value="ê²½ê¸°">ê²½ê¸°</option>
                        <option value="ê°•ì›">ê°•ì›</option>
                        <option value="ì¶©ë¶">ì¶©ë¶</option>
                        <option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
                        <option value="ì „ë¶">ì „ë¶</option>
                        <option value="ì „ë‚¨">ì „ë‚¨</option>
                        <option value="ê²½ë¶">ê²½ë¶</option>
                        <option value="ê²½ë‚¨">ê²½ë‚¨</option>
                        <option value="ì œì£¼">ì œì£¼</option>
                    </select>

                    <div class="mentor-btn" onclick="switchTab('network')" title="ë‚˜ì˜ ë¯¸ì‹ë©˜í† ">
                        ğŸ‘‘ <span data-ko="ë¯¸ì‹ë©˜í† " data-en="Mentors">ë¯¸ì‹ë©˜í† </span>
                    </div>

                    <div onclick="openGlobalSearchModal()" style="cursor:pointer; display:flex; align-items:center; justify-content:center;" title="ë©”ë‰´/ì‹ë‹¹ ê²€ìƒ‰">
                        <svg class="svg-icon" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>

                    <div style="position:relative; cursor:pointer; display:flex; align-items:center; justify-content:center;" onclick="openNotificationModal()" title="ë‚´ ì†Œì‹">
                        <svg class="svg-icon" viewBox="0 0 24 24">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <div id="noti-badge" class="noti-badge"></div>
                    </div>

                    <div id="lang-toggle" class="lang-toggle" onclick="toggleLanguage()">EN</div>

                    <div onclick="handleLogout()" style="cursor:pointer; display:flex; align-items:center; justify-content:center;" title="ë¡œê·¸ì•„ì›ƒ">
                        <svg class="svg-icon" viewBox="0 0 24 24">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </div>
                </div>
            </div>
        </header>

        <div id="home-view" class="tab-view" style="display:block;">
            <div class="home-top-banner">
                <div class="home-top-banner-title" data-ko="ì˜¤ëŠ˜ì˜ ë¯¸ì‹<br>íë ˆì´ì…˜" data-en="Today's<br>Curation">ì˜¤ëŠ˜ì˜ ë¯¸ì‹<br>íë ˆì´ì…˜</div>
                <div class="home-top-banner-sub" data-ko="ê°€ì¥ íŠ¸ë Œë””í•œ ë‹¤ì´ë‹ ê²½í—˜ì„ í™•ì¸í•˜ì„¸ìš”" data-en="Discover trendy dining experiences">ê°€ì¥ íŠ¸ë Œë””í•œ ë‹¤ì´ë‹ ê²½í—˜ì„ í™•ì¸í•˜ì„¸ìš”</div>
            </div>

            <div class="home-section-container">
                <div class="section-title" id="home-editor-title" data-ko="ì¸ê¸° ë¯¸ì‹ê°€" data-en="Featured Gourmets">
                    ì¸ê¸° ë¯¸ì‹ê°€
                </div>
                <div class="editor-row" id="editor-list-container"></div>
                
                <div class="section-title" style="margin-top:40px;" data-ko="ì¸ê¸° ë§›ì§‘ í¬íŠ¸í´ë¦¬ì˜¤" data-en="Popular Places">
                    ì¸ê¸° ë§›ì§‘ í¬íŠ¸í´ë¦¬ì˜¤
                </div>
                <div class="card-grid" id="popular-list-container"></div>
                
                <div class="section-title" style="margin-top:40px;" data-ko="ìµœê·¼ ë“±ë¡ëœ ì‹ë‹¹" data-en="Recently Added">
                    ìµœê·¼ ë“±ë¡ëœ ì‹ë‹¹
                </div>
                <div class="card-grid" id="new-list-container"></div>
            </div>
        </div>

        <div id="network-view" class="tab-view" style="display:none; padding-top:80px;">
            <div style="padding: 10px 0;">
                <h2 style="font-size: 26px; font-weight: 900; margin-bottom: 5px; color: var(--text-main);" data-ko="ë‚˜ì˜ ë¯¸ì‹ë©˜í† " data-en="My Mentors">
                    ë‚˜ì˜ ë¯¸ì‹ë©˜í† 
                </h2>
                <div style="font-size:13px; color:var(--text-sub); margin-bottom:30px;" data-ko="ìµœê³ ì˜ ë¯¸ì‹ê°€ë“¤ì„ íŒ”ë¡œìš°í•˜ê³  ì„œì—´í‘œë¥¼ í™•ì¸í•˜ì„¸ìš”." data-en="Follow top gourmets and check their tier lists.">
                    ìµœê³ ì˜ ë¯¸ì‹ê°€ë“¤ì„ íŒ”ë¡œìš°í•˜ê³  ì„œì—´í‘œë¥¼ í™•ì¸í•˜ì„¸ìš”.
                </div>
                
                <div class="section-title" data-ko="íŒ”ë¡œì‰" data-en="Following">íŒ”ë¡œì‰</div>
                <div id="following-list-container"></div>
                
                <div class="section-title" style="margin-top:40px;" data-ko="ì¶”ì²œ ë¯¸ì‹ê°€" data-en="Recommended Gourmets">ì¶”ì²œ ë¯¸ì‹ê°€</div>
                <div id="recommended-list-container"></div>
            </div>
        </div>

        <div id="explore-view" class="tab-view" style="display:none; padding-top:80px;">
            <div style="display:flex; gap:10px; margin-bottom:20px; justify-content:center;">
                <button id="tab-explore-ranking" onclick="switchExploreTab('ranking')" class="btn-primary" style="flex:1; background:var(--brand-primary);">ë§›ì§‘ ì¸ê¸°ìˆœ</button>
                <button id="tab-explore-feed" onclick="switchExploreTab('feed')" class="btn-primary" style="flex:1; background:#EAEAEA; color:#111;">ì‹¤ì‹œê°„ í”¼ë“œ</button>
            </div>

            <div id="explore-ranking-area">
                <input type="text" id="ranking-search-input" class="input-field" placeholder="ë©”ë‰´ë‚˜ ì‹ë‹¹ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš” ğŸ”" onkeyup="if(event.keyCode==13) fetchRankingData()">
                <div style="font-size:12px; color:var(--text-sub); margin-bottom:16px; text-align:center;">
                    ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•Šê³  ë‹ë³´ê¸°ë¥¼ ëˆ„ë¥´ë©´ 'ì „ì²´ ë­í‚¹'ì´ í‘œì‹œë©ë‹ˆë‹¤.
                </div>
                <button class="btn-primary" style="margin-bottom:24px; padding:16px;" onclick="fetchRankingData()">ê²€ìƒ‰ ë° ë­í‚¹ í™•ì¸</button>
                <div id="ranking-list-container"></div>
            </div>

            <div id="explore-feed-area" style="display:none;">
                <div id="feed-scroll-area"></div>
            </div>
        </div>
        
        <div id="map-view" class="tab-view" style="display:none; height: 100vh; padding: 60px 0 0 0;">
            <div id="global-map" style="width:100%; height:100%; background:#eee;"></div>
            <div class="my-location-btn" style="position: absolute; bottom: 100px; right: 20px; width: 44px; height: 44px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10; cursor: pointer; border: 1px solid var(--border-color);" onclick="moveToMyLocation()" title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">
                <svg class="svg-icon" viewBox="0 0 24 24" style="stroke:var(--brand-fab);">
                    <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
                </svg>
            </div>
        </div>

        <div id="profile-view" class="tab-view" style="display:none; padding-top:60px; padding-left:0; padding-right:0;">
            <div id="profile-header-target"></div>
            
            <div style="padding: 0 24px;">
                <div id="registration-trigger" style="background:var(--bg-card); border: 1px dashed var(--border-color); border-radius:var(--radius-xl); padding:24px; margin-bottom:24px; text-align:center; cursor: pointer; transition: 0.3s; box-shadow:var(--shadow-soft);" onclick="openSearchModal()">
                    <div style="font-size: 28px; color: var(--brand-fab); margin-bottom: 8px;">+</div>
                    <div data-ko="ìƒˆë¡œìš´ ë¯¸ì‹ ê²½í—˜ ê¸°ë¡í•˜ê¸°" data-en="Log new experience" style="font-size: 14px; font-weight: 800; color: var(--brand-primary);">
                        ìƒˆë¡œìš´ ë¯¸ì‹ ê²½í—˜ ê¸°ë¡í•˜ê¸°
                    </div>
                </div>
                
                <div id="guide-controls-target" class="guide-controls" style="display:none; margin-bottom:20px;">
                    <input type="text" id="guide-search-input" class="input-field" data-ph-ko="ì„œì—´í‘œ ë‚´ ì‹ë‹¹ ê²€ìƒ‰..." data-ph-en="Search in guide..." placeholder="ì„œì—´í‘œ ë‚´ ì‹ë‹¹ ê²€ìƒ‰..." onkeyup="renderGuideSheet()">
                </div>
                
                <div id="michelin-tables-target"></div>
            </div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item active" id="m-home" onclick="switchTab('home')">
                <svg class="nav-icon svg-icon" viewBox="0 0 24 24">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2-2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span data-ko="í™ˆ" data-en="Home">í™ˆ</span>
            </div>
            <div class="nav-item" id="m-map" onclick="switchTab('map')">
                <svg class="nav-icon svg-icon" viewBox="0 0 24 24">
                    <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
                    <line x1="8" y1="2" x2="8" y2="18"></line>
                    <line x1="16" y1="6" x2="16" y2="22"></line>
                </svg>
                <span data-ko="ë‚´ì£¼ë³€" data-en="Map">ë‚´ì£¼ë³€</span>
            </div>
            
            <div class="nav-fab-wrapper">
                <div class="nav-fab" onclick="openSearchModal()">
                    <svg viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </div>
            </div>
            
            <div class="nav-item" id="m-explore" onclick="switchTab('explore')">
                <svg class="nav-icon svg-icon" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <span data-ko="íƒìƒ‰" data-en="Explore">íƒìƒ‰</span>
            </div>
            <div class="nav-item" id="m-profile" onclick="switchTab('profile')">
                <svg class="nav-icon svg-icon" viewBox="0 0 24 24">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <span data-ko="ë‚´ í”„ë¡œí•„" data-en="Profile">ë‚´ í”„ë¡œí•„</span>
            </div>
        </nav>
    </div>

    <div id="search-modal" class="bottom-modal">
        <div class="modal-body" style="height: 85vh;">
            <div style="padding:24px 24px 16px; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-weight:800; font-size:20px; color:var(--brand-primary);" data-ko="ì¥ì†Œ ì°¾ê¸°" data-en="Search Place">ì¥ì†Œ ì°¾ê¸°</h2>
                <div onclick="closeSearchModal()" style="cursor:pointer; color:var(--text-sub);">
                    <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div style="padding:0 24px 24px; flex:1; overflow-y:auto; display:flex; flex-direction:column; position: relative;">
                <input type="text" id="search-keyword" class="input-field" data-ph-ko="ì‹ë‹¹ ì´ë¦„ ì…ë ¥ í›„ Enter" data-ph-en="Search name and Enter" placeholder="ì‹ë‹¹ ì´ë¦„ ì…ë ¥ í›„ Enter" onkeypress="if(event.keyCode==13) executeKakaoSearch()">
                <div id="search-results-target" style="flex:1; margin-top:10px;"></div>
            </div>
        </div>
    </div>

    <div id="global-search-modal" class="bottom-modal" style="z-index: 2100;">
        <div class="modal-body" style="height: 90vh;">
            <div style="padding:24px 24px 16px; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-weight:800; font-size:20px; color:var(--brand-primary);">ğŸ” ë©”ë‰´ & ë­í‚¹ ê²€ìƒ‰</h2>
                <div onclick="closeGlobalSearchModal()" style="cursor:pointer; color:var(--text-sub);">
                    <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div style="padding:0 24px 24px; flex:1; overflow-y:auto; display:flex; flex-direction:column;">
                <input type="text" id="global-ranking-input" class="input-field" style="border:1px solid var(--brand-primary);" placeholder="ì˜ˆ: íŒŒìŠ¤íƒ€, ë¼ì§€ê°ˆë¹„, ì˜¤ë§ˆì¹´ì„¸..." onkeyup="if(event.keyCode==13) executeGlobalSearch()">
                <button class="btn-primary" style="margin-bottom:20px; padding:16px;" onclick="executeGlobalSearch()">ê²€ìƒ‰í•˜ê¸°</button>
                <div id="global-search-results" style="flex:1;">
                    <div style="text-align:center; padding:40px 20px; color:var(--text-sub); font-size:13px;">
                        ì›í•˜ì‹œëŠ” ë©”ë‰´ë‚˜ ì‹ë‹¹ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì‹œë©´<br>ê°€ì¥ ë§ì´ ë“±ë¡ëœ ìˆœì„œëŒ€ë¡œ ë­í‚¹ì„ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification-modal" class="bottom-modal" style="z-index: 2200;">
        <div class="modal-body" style="height: 75vh;">
            <div style="padding:24px 24px 16px; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-weight:800; font-size:20px; color:var(--brand-primary);">ğŸ”” ë‚´ ì†Œì‹</h2>
                <div onclick="closeNotificationModal()" style="cursor:pointer; color:var(--text-sub);">
                    <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div style="padding:0; flex:1; overflow-y:auto;" id="notification-list-target">
                <div style="text-align:center; padding:40px 20px; color:var(--text-sub); font-size:13px;">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>
        </div>
    </div>

    <div id="post-detail-modal" class="bottom-modal" style="z-index: 2300;">
        <div class="modal-body" style="height: 90vh; padding: 30px 24px; overflow-y: auto;">
            <div style="font-weight: 800; font-size: 20px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; color: var(--brand-primary);">
                <span data-ko="ìƒˆë¡œìš´ ë“±ê¸°" data-en="New Entry">ìƒˆë¡œìš´ ë“±ê¸°</span>
                <div onclick="cancelPosting()" style="cursor:pointer; color:var(--text-sub);">
                    <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            
            <div class="preview-container">
                <div id="selected-rest-photo" style="width:100%; height:200px; background-size:cover; background-position:center; border-radius:16px; margin-bottom:12px; position:relative; overflow:hidden; border: 1px solid var(--border-color);"></div>
                <div id="map-preview-area" style="width:100%; height:150px; border-radius:16px; margin-bottom:12px; border: 1px solid var(--border-color);"></div>
            </div>
            
            <div id="selected-info-text" style="background:var(--bg-main); padding:18px; border-radius:12px; margin-bottom:20px; border: 1px solid var(--border-color);"></div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                <div style="font-size: 12px; font-weight: 700; color: var(--text-sub); text-transform:uppercase;" data-ko="ë¯¸ì‹í‰" data-en="Description">ë¯¸ì‹í‰</div>
                <button onclick="recommendAIComment()" style="background:rgba(255,90,32,0.1); border:1px solid var(--brand-fab); color:var(--brand-fab); border-radius:12px; padding:6px 12px; font-size:10px; font-weight:800; cursor:pointer; transition:0.2s;">
                    âœ¨ AI íë ˆì´ì…˜
                </button>
            </div>
            
            <input type="text" id="post-comment" class="input-field" data-ph-ko="ì´ ê³³ì—ì„œì˜ ê²½í—˜ì„ í•œ ì¤„ë¡œ ì ì–´ì£¼ì„¸ìš”." data-ph-en="Write your experience..." placeholder="ì´ ê³³ì—ì„œì˜ ê²½í—˜ì„ í•œ ì¤„ë¡œ ì ì–´ì£¼ì„¸ìš”.">
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; padding-bottom: 40px;">
                <div style="flex:1;">
                    <div style="font-size: 11px; font-weight: 600; color: var(--text-sub); margin-bottom: 8px;" data-ko="ì‚¬ì§„ ì—…ë¡œë“œ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)" data-en="Upload Photos (Multiple)">ì‚¬ì§„ ì—…ë¡œë“œ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</div>
                    <input type="file" id="post-image" accept="image/*" multiple style="font-size:12px; color:var(--text-sub);" onchange="handleImagePreview(this)">
                </div>
                <button onclick="executeAddRestaurant()" class="btn-primary" style="width: auto; padding: 14px 28px;" data-ko="ì €ì¥" data-en="Save">ì €ì¥</button>
            </div>
            
            <input type="hidden" id="h-name">
            <input type="hidden" id="h-cat">
            <input type="hidden" id="h-addr">
            <input type="hidden" id="h-id">
            <input type="hidden" id="h-x">
            <input type="hidden" id="h-y">
            <input type="hidden" id="h-phone">
        </div>
    </div>

    <div id="restaurant-detail-modal" class="bottom-modal" style="z-index: 2400;">
        <div class="modal-body" style="height: 90vh; padding: 0; overflow-y:auto;">
            <div id="detail-view-card" style="padding: 30px 24px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 24px;">
                    <span class="tag-pill" id="detail-tier" style="font-size:13px; padding:6px 14px; background:var(--brand-yellow); color:#000;"></span>
                    <div style="display:flex; gap: 15px; align-items:center;">
                        
                        <div id="delete-rest-btn" onclick="executeDeleteRestaurant()" style="display:none; cursor:pointer; color:#FF4757;" title="ê¸°ë¡ ì‚­ì œ">
                            <svg class="svg-icon" viewBox="0 0 24 24" style="stroke:#FF4757; width:24px; height:24px;">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </div>
                        
                        <div onclick="closeRestDetail()" style="cursor:pointer; color:var(--text-sub);">
                            <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px; stroke:var(--brand-primary);"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </div>
                    </div>
                </div>
                
                <div id="detail-img" class="detail-main-img" style="background-position:center; background-size:cover; background-color:#eee; position:relative; overflow:hidden; border: 1px solid var(--border-color); border-radius: 16px; aspect-ratio: 4/3;">
                    <button id="ai-sync-btn" style="position:absolute; bottom:12px; right:12px; background:rgba(0,0,0,0.8); color:var(--brand-fab); border:1px solid var(--brand-fab); padding:8px 14px; border-radius:20px; font-size:11px; font-weight:800; cursor:pointer; backdrop-filter:blur(4px); display:none; transition:0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index:20;">
                        âœ¨ AI ì‚¬ì§„ ë³€ê²½
                    </button>
                </div>

                <h2 id="detail-name" style="font-size:28px; font-weight:900; margin-bottom:12px; margin-top: 20px; color:var(--brand-primary); letter-spacing:-0.5px;"></h2>
                
                <div style="display:flex; gap:8px; margin-bottom:24px; flex-wrap:wrap;">
                    <span class="tag-pill tag-orange" id="detail-category" style="padding: 4px 10px; border-radius: 12px; font-size: 11px;"></span>
                    <span class="tag-pill tag-green" id="detail-address" style="padding: 4px 10px; border-radius: 12px; font-size: 11px;"></span>
                    <span class="tag-pill tag-pink" id="detail-phone" style="display:none; padding: 4px 10px; border-radius: 12px; font-size: 11px;"></span>
                </div>
                
                <div style="background:var(--bg-main); padding:24px; border-radius:20px; margin-bottom:30px; border: 1px solid var(--border-color);">
                    <div style="font-size:11px; color:var(--text-sub); font-weight:800; margin-bottom:12px; text-transform:uppercase; letter-spacing:1px;" data-ko="ë¯¸ì‹ê°€ ì½”ë©˜íŠ¸" data-en="Editor's Comment">ë¯¸ì‹ê°€ ì½”ë©˜íŠ¸</div>
                    <div id="detail-comment" style="font-size:16px; font-weight:500; color:var(--text-main); line-height: 1.6; font-style: italic;"></div>
                    
                    <div style="display:flex; align-items:center; gap:10px; margin-top:20px;">
                        <div id="detail-owner" style="display:inline-block; padding:8px 14px; background:white; border-radius:12px; font-size:12px; font-weight:700; color:var(--brand-primary); cursor:pointer; border: 1px solid var(--border-color);"></div>
                        <button id="detail-follow-btn" style="display:none; padding:8px 16px; background:var(--brand-fab); color:white; border-radius:12px; border:none; font-size:12px; font-weight:800; cursor:pointer; box-shadow: 0 4px 15px rgba(255,90,32,0.3); transition:0.2s;"></button>
                    </div>
                </div>
                
                <div style="font-size: 12px; font-weight: 800; margin-bottom: 12px; color: var(--text-sub); text-transform:uppercase; letter-spacing:1px;" data-ko="ìœ„ì¹˜ ì •ë³´" data-en="Location Info">ìœ„ì¹˜ ì •ë³´</div>
                <div id="detail-map-area" style="width:100%; height:250px; border-radius:20px; margin-bottom:30px; border: 1px solid var(--border-color); background: #eee;"></div>
                
                <button id="detail-kakao-btn" class="btn-primary" style="background:var(--brand-primary); color:#FFF; display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom: 50px; box-shadow:none;" data-ko="ìƒì„¸ ì •ë³´ ë° ë©”ë‰´ ë³´ê¸°" data-en="View Info & Menu">ìƒì„¸ ì •ë³´ ë° ë©”ë‰´ ë³´ê¸°</button>
            </div>
        </div>
    </div>

    <div id="edit-profile-modal" class="bottom-modal" style="z-index: 2500;">
        <div class="modal-body" style="height: auto; min-height: 50vh; padding: 30px 24px; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 24px;">
                <h2 style="font-weight:800; font-size:20px; color:var(--brand-primary);">í”„ë¡œí•„ ìˆ˜ì •</h2>
                <div onclick="closeEditProfileModal()" style="cursor:pointer; color:var(--text-sub);">
                    <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            
            <div style="font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px;">ìƒˆë¡œìš´ í”„ë¡œí•„ ì´ë¦„ (ë‹‰ë„¤ì„)</div>
            <input type="text" id="edit-nickname-input" class="input-field" placeholder="ë³€ê²½í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.">
            
            <div style="font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; margin-top: 10px;">ë‚˜ë§Œì˜ ë¯¸ì‹ ì² í•™ (Quote)</div>
            <input type="text" id="edit-philosophy-input" class="input-field" placeholder="ì˜ˆ: ìŒì‹ì€ í˜€ê°€ ì•„ë‹ˆë¼ ë¶„ìœ„ê¸°ë¡œ ë¨¹ëŠ” ê²ƒì´ë‹¤">

            <div style="font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; margin-top: 10px;">ë¯¸ì‹ DNA íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</div>
            <input type="text" id="edit-dna-input" class="input-field" placeholder="ì˜ˆ: íŒŒì¸ë‹¤ì´ë‹, ë…¸í¬ë§¤ë‹ˆì•„, ì™€ì¸ëŸ¬ë²„">

            <div style="font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; margin-top: 10px;">ê¸°íƒ€ ê°œì¸ì •ë³´</div>
            <textarea id="edit-personal-info" class="input-field" placeholder="ìê¸°ì†Œê°œë‚˜ ì¶”ê°€ ê°œì¸ì •ë³´ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆëŠ” ê³µê°„ì…ë‹ˆë‹¤." style="height: 80px; resize: none;"></textarea>
            
            <button onclick="submitProfileEdit()" class="btn-primary" style="margin-top: 20px;">ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="ai-image-modal" class="bottom-modal" style="z-index: 2600;">
        <div class="modal-body" style="height: auto; min-height: 50vh; padding: 30px 24px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                <h2 style="font-weight:800; font-size:20px; color:var(--brand-primary);">âœ¨ AI ì‚¬ì§„ íë ˆì´ì…˜</h2>
                <div onclick="document.getElementById('ai-image-modal').style.display='none'" style="cursor:pointer; color:var(--text-sub);">
                    <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div style="font-size:13px; color:var(--text-sub); margin-bottom:20px;">ì„œë²„ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì§‘í•œ ê³ í™”ì§ˆ ì´ë¯¸ì§€ ì¤‘<br>ëŒ€í‘œ ì‚¬ì§„ìœ¼ë¡œ ì‚¬ìš©í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
            <div id="ai-image-target" class="ai-image-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;"></div>
        </div>
    </div>
    <script>
        // =========================================================
        // [PWA] Service Worker ë“±ë¡ ë° ì•± ì„¤ì¹˜ ìœ ë„(ì„¤ì¹˜ íŒì—…) ë¡œì§
        // =========================================================
        let deferredPrompt;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(reg) { console.log('Service Worker ë“±ë¡ ì„±ê³µ:', reg.scope); })
                    .catch(function(err) { console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨:', err); });
            });
        }

        // ğŸš¨ [ìˆ˜ì • 4] ìŠ¤ë§ˆíŠ¸í° ë°”íƒ•í™”ë©´ ì„¤ì¹˜ ìœ ë„ (PWA)
        window.addEventListener('beforeinstallprompt', (e) => {
            // ë¸Œë¼ìš°ì €ì˜ ê¸°ë³¸ ì„¤ì¹˜ íŒì—…ì„ ë§‰ê³ , ìš°ë¦¬ê°€ ë§Œë“  ë°°ë„ˆë¥¼ ë„ì›ë‹ˆë‹¤.
            e.preventDefault();
            deferredPrompt = e;
            const installBanner = document.getElementById('pwa-install-banner');
            if(installBanner) {
                installBanner.style.display = 'flex';
            }
        });

        // ì„¤ì¹˜ ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘
        document.addEventListener('DOMContentLoaded', () => {
            const installBtn = document.getElementById('pwa-install-btn');
            if(installBtn) {
                installBtn.addEventListener('click', async () => {
                    const installBanner = document.getElementById('pwa-install-banner');
                    if (installBanner) installBanner.style.display = 'none';
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        } else {
                            console.log('User dismissed the install prompt');
                        }
                        deferredPrompt = null;
                    }
                });
            }
        });

        // =========================================================
        // [1] ê¸€ë¡œë²Œ ë³€ìˆ˜ ë° í™˜ê²½ ì„¤ì •
        // =========================================================
        const API_URL = `https://perchel-backend.onrender.com`; 
        
        let followingList = [];
        let currentLang = 'ko'; 
        let globalRegion = 'national';
        let currentProfileGuideData = {};
        let currentProfileOwner = '';
        let currentProfileIsMe = false;
        let currentProfileLocalRegion = '';
        let activeGuideTab = 'national';
        let currentOpenRestId = null; 
        let userProfiles = {}; 
        
        let currentProfilePhilosophy = '';
        let currentProfileTags = [];
        let currentProfilePersonalInfo = '';
        
        let globalMap = null; 
        let previewMap = null; 
        let previewMarker = null;

        let nationalTop50 = [];
        let regionalTop10 = {};
        
        // =========================================================
        // [1.5] ì†Œì…œ ë¡œê·¸ì¸ ì—”ì§„ (ì¹´ì¹´ì˜¤/êµ¬ê¸€)
        // =========================================================
        
        // 1. ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
        if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
            Kakao.init('cdf28be42d7f14e86fdbe2901a84398a');
        }

        // 2. ì†Œì…œ ë¡œê·¸ì¸ ë°±ì—”ë“œ ê²€ì¦ ë° ì²˜ë¦¬ (ğŸš¨ ì—ëŸ¬ ë°©ì–´ ì¶”ê°€)
        window.handleSocialLoginServer = async function(provider, token) {
            try {
                const res = await fetch(`${API_URL}/login/social`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: provider, token: token })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    localStorage.setItem('currentUser', data.username);
                    followingList = data.following || [];
                    
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    initApp();
                } else {
                    alert(data.detail || "ì†Œì…œ ë¡œê·¸ì¸ ì„œë²„ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch(e) {
                console.error("ë¡œê·¸ì¸ ì„œë²„ ì—ëŸ¬:", e);
                alert("ì„œë²„ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (CORS ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬)\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        };

        // 3. êµ¬ê¸€ ë¡œê·¸ì¸ ì½œë°±
        window.handleGoogleLogin = function(response) {
            window.handleSocialLoginServer('google', response.credential);
        };

        // 4. ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹¤í–‰ í•¨ìˆ˜
        window.loginWithKakao = function() {
            if (typeof Kakao === 'undefined') {
                alert("ì¹´ì¹´ì˜¤ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                return;
            }
            Kakao.Auth.login({
                success: function(authObj) {
                    window.handleSocialLoginServer('kakao', authObj.access_token);
                },
                fail: function(err) {
                    console.error("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì·¨ì†Œ ë˜ëŠ” ì—ëŸ¬ ë°œìƒ:", err);
                    alert("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        };

        // 5. ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        window.handleLogout = function() { 
            localStorage.removeItem('currentUser'); 
            location.reload(); 
        };
        
        // =========================================================
        // [2] ê³µí†µ ìœ í‹¸ë¦¬í‹° (ë°°ì§€, ì•„ë°”íƒ€, ì‹ë‹¹ ìë™ ì‚¬ì§„ ë§¤ì¹­)
        // =========================================================
        function getBadgeHtml(username) {
            if (nationalTop50.includes(username)) {
                return `<div class="s-badge">ì „êµ­S</div>`;
            }
            for (let reg in regionalTop10) {
                if (regionalTop10[reg] && regionalTop10[reg].includes(username)) {
                    return `<div class="s-badge regional">${reg}S</div>`;
                }
            }
            return '';
        }

        function getAvatar(username) {
            let badge = getBadgeHtml(username);
            let imgHtml = '';
            
            if (userProfiles[username]) {
                imgHtml = `<img src="${userProfiles[username]}" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                const initial = username ? username.charAt(0).toUpperCase() : '?';
                imgHtml = `
                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: var(--border-color); color: var(--brand-primary); font-weight: 900; font-size: 1.5em; text-transform: uppercase;">
                        ${initial}
                    </div>
                `;
            }
            
            return `
                <div style="position:relative; width:100%; height:100%;">
                    <div class="avatar-circle">
                        ${imgHtml}
                    </div>
                    ${badge}
                </div>
            `;
        }

        function getSmartRestImage(id, category, userImg) {
            if (userImg && userImg !== 'null' && userImg !== '') {
                // ë°±ì—”ë“œ ê²½ë¡œ ë³´ì • ë¡œì§ (ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì‹œ 127.0.0.1 ë°©ì–´)
                if (userImg.includes('127.0.0.1:8000') || userImg.startsWith('/images')) {
                    const fileName = userImg.split('/').pop();
                    return `${API_URL}/images/${fileName}`;
                }
                return userImg; 
            }
            
            const cat = category || "";
            
            if (cat.includes('ê³ ê¸°') || cat.includes('êµ¬ì´') || cat.includes('ì†Œ') || cat.includes('ë¼ì§€')) {
                return 'https://images.unsplash.com/photo-1544025162-811114cd354a?w=800&q=80';
            }
            if (cat.includes('ì¹´í˜') || cat.includes('ì»¤í”¼') || cat.includes('ë””ì €íŠ¸')) {
                return 'https://images.unsplash.com/photo-1554118811-1e0d58224f24?w=800&q=80';
            }
            if (cat.includes('ì¼ì‹') || cat.includes('ì´ˆë°¥') || cat.includes('ìŠ¤ì‹œ')) {
                return 'https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?w=800&q=80';
            }
            if (cat.includes('ì¤‘ì‹') || cat.includes('ë§ˆë¼') || cat.includes('ì§œì¥')) {
                return 'https://images.unsplash.com/photo-1585032226651-759b368d7246?w=800&q=80';
            }
            if (cat.includes('ì–‘ì‹') || cat.includes('íŒŒìŠ¤íƒ€') || cat.includes('í”¼ì')) {
                return 'https://images.unsplash.com/photo-1473093295043-cdd812d0e601?w=800&q=80';
            }
            
            if (id && id !== 'undefined' && id !== 'null') {
                return `https://img1.kakaocdn.net/cthumb/local/R0x0/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flocalfiy%2Fsearch%2Fplace%2F${id}`;
            }
            
            return 'https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800&q=80'; 
        }

        async function fetchUserProfiles() {
            try {
                const res = await fetch(`${API_URL}/users/profiles`);
                if (res.ok) {
                    userProfiles = await res.json();
                }
            } catch (error) {
                console.error("í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", error);
            }
        }

        function triggerProfileUpload() {
            if (!currentProfileIsMe) return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const fd = new FormData();
                fd.append('image', file);
                
                try {
                    const res = await fetch(`${API_URL}/user/profile-image`, {
                        method: 'POST',
                        headers: { 'user-id': localStorage.getItem('currentUser') },
                        body: fd
                    });
                    
                    if (res.ok) {
                        alert("í”„ë¡œí•„ ì‚¬ì§„ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¸");
                        await fetchUserProfiles(); 
                        fetchGuideView(localStorage.getItem('currentUser')); 
                    } else { 
                        alert("ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); 
                    }
                } catch(error) { 
                    alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); 
                }
            };
            input.click();
        }

        // =========================================================
        // [3] ë„¤ë¹„ê²Œì´ì…˜ ë° íƒ­ ì „í™˜
        // =========================================================
        function toggleLanguage() {
            currentLang = currentLang === 'ko' ? 'en' : 'ko';
            document.getElementById('lang-toggle').innerText = currentLang === 'ko' ? 'EN' : 'KR';
            
            document.querySelectorAll('[data-ko]').forEach(el => { 
                el.innerText = el.getAttribute(`data-${currentLang}`); 
            });
            document.querySelectorAll('[data-ph-ko]').forEach(el => { 
                el.placeholder = el.getAttribute(`data-ph-${currentLang}`); 
            });
            
            if (document.getElementById('tab-local') && currentProfileLocalRegion) {
                document.getElementById('tab-local').innerText = currentLang === 'ko' ? `ì§€ì—­ ë§›ì§‘ (${currentProfileLocalRegion})` : `Local (${currentProfileLocalRegion})`;
            }
            
            const activeTab = document.querySelector('.nav-item.active');
            if (activeTab) switchTab(activeTab.id.replace('m-', '')); 
        }

        function changeGlobalRegion() {
            globalRegion = document.getElementById('global-region-select').value;
            const activeTab = document.querySelector('.nav-item.active');
            if (activeTab) { 
                const tabId = activeTab.id.replace('m-', '');
                if (tabId === 'home') fetchHomeData();
                else if (tabId === 'explore') switchExploreTab('ranking'); 
                else if (tabId === 'network') fetchNetworkData();
            }
        }

        function switchTab(t, skipFetch = false) {
            const user = localStorage.getItem('currentUser');
            const topBar = document.getElementById('main-top-bar');
            
            if (t === 'home') topBar.classList.add('transparent');
            else topBar.classList.remove('transparent');
            
            document.querySelectorAll('.tab-view').forEach(view => view.style.display = 'none');
            document.getElementById(t + '-view').style.display = 'block';
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById('m-' + t);
            if (activeNav) activeNav.classList.add('active');
            
            if (!skipFetch) {
                if (t === 'home') fetchHomeData();
                else if (t === 'network') fetchNetworkData(); 
                else if (t === 'explore') switchExploreTab('ranking'); 
                else if (t === 'profile') fetchGuideView(user);
                else if (t === 'map') setTimeout(() => initGlobalMap(), 200); 
            }
            window.scrollTo(0,0);
        }

        // =========================================================
        // [4] ì¹´ì¹´ì˜¤ë§µ API ì—°ë™ ë° ì£¼ë³€ ê²€ìƒ‰ ë¡œì§
        // =========================================================
        function initGlobalMap() {
            if (typeof kakao === 'undefined' || !kakao.maps) {
                console.error("ì¹´ì¹´ì˜¤ë§µ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }
            
            kakao.maps.load(function() {
                const mapContainer = document.getElementById('global-map');
                if (!mapContainer) return;
                
                if (globalMap) { 
                    globalMap.relayout(); 
                    moveToMyLocation(); 
                    setTimeout(() => { globalMap.relayout(); moveToMyLocation(); }, 100);
                    return; 
                } 
                
                const defaultLoc = new kakao.maps.LatLng(37.5665, 126.9780);
                globalMap = new kakao.maps.Map(mapContainer, { center: defaultLoc, level: 6 });
                
                moveToMyLocation();
                loadMapMarkers();
                
                setTimeout(() => { globalMap.relayout(); moveToMyLocation(); }, 100);
            });
        }

        function moveToMyLocation() {
            if (navigator.geolocation && globalMap) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const loc = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    globalMap.setCenter(loc);
                    globalMap.setLevel(4);
                });
            }
        }

        async function loadMapMarkers() {
            try {
                const res = await fetch(`${API_URL}/feed`);
                if (!res.ok) throw new Error("í”¼ë“œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                
                let feedList = await res.json();
                if (!Array.isArray(feedList)) feedList = feedList.data || [];
                
                feedList.forEach(r => {
                    if (r.x && r.y) {
                        const loc = new kakao.maps.LatLng(Number(r.y), Number(r.x));
                        const marker = new kakao.maps.Marker({ position: loc, map: globalMap });
                        
                        kakao.maps.event.addListener(marker, 'click', function() {
                            openRestDetail(
                                (r.name || '').replace(/`/g, ""), 
                                (r.category || '').replace(/`/g, ""), 
                                (r.address || '').replace(/`/g, ""), 
                                (r.comment || '').replace(/`/g, ""), 
                                r.tier || '', r.kakao_id || '', r.image_url || '', r.owner || '', r.id || '', false
                            );
                        });
                    }
                });
            } catch (error) {
                console.error("ë§ˆì»¤ ë¡œë“œ ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
            }
        }

        // =========================================================
        // [5] ë©”ì¸ ë°ì´í„° ë Œë”ë§ (í™ˆ, íƒìƒ‰, ë„¤íŠ¸ì›Œí¬)
        // =========================================================
        async function fetchHomeData() {
            try {
                const res = await fetch(`${API_URL}/main/data`); 
                if (!res.ok) throw new Error("ì„œë²„ ì—ëŸ¬");
                const d = await res.json();
                
                nationalTop50 = d.national_top_50 || [];
                regionalTop10 = d.regional_top_10 || {};
                
                let displayEditors = [];
                const titleEl = document.getElementById('home-editor-title');

                if (globalRegion === 'national') {
                    displayEditors = d.all_editors || [];
                    if (titleEl) titleEl.innerText = currentLang === 'ko' ? "ì¸ê¸° ë¯¸ì‹ê°€" : "Featured Gourmets";
                } else {
                    const regionalUsernames = regionalTop10[globalRegion] || [];
                    displayEditors = (d.all_editors || []).filter(e => regionalUsernames.includes(e.username));
                    if (titleEl) titleEl.innerText = currentLang === 'ko' ? `${globalRegion}ì§€ì—­ ì¶”ì²œ ë¯¸ì‹ê°€` : `Top in ${globalRegion}`;
                }

                if (displayEditors.length === 0) {
                    document.getElementById('editor-list-container').innerHTML = `
                        <div style="padding:20px; color:var(--text-sub); font-size:13px; text-align:center; width:100%;">
                            ${currentLang === 'ko' ? 'ì´ ì§€ì—­ì— í™œë™í•˜ëŠ” ë¯¸ì‹ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'No gourmets in this region yet.'}
                        </div>`;
                } else {
                    let editorsHtml = '';
                    displayEditors.forEach(e => {
                        const isMe = (e.username === localStorage.getItem('currentUser'));
                        const isFollow = followingList.includes(e.username);
                        let followHtml = !isMe ? `<button class="editor-follow-btn" onclick="event.stopPropagation(); const btn = this; executeToggleFollow('${e.username}').then(() => { btn.innerText = btn.innerText.includes('âœ“') ? '+ íŒ”ë¡œìš°' : 'âœ“ íŒ”ë¡œì‰'; });">${isFollow ? 'âœ“ íŒ”ë¡œì‰' : '+ íŒ”ë¡œìš°'}</button>` : '';

                        editorsHtml += `
                            <div class="editor-card" onclick="fetchGuideView('${e.username}', true)">
                                <div class="editor-img-container" style="overflow:visible !important;">${getAvatar(e.username)}</div>
                                <div style="font-weight:800; font-size:15px; color:var(--brand-primary); margin-bottom:2px;">${e.display_name || e.username}</div>
                                <div style="font-size:11px; color:var(--text-sub);">${e.followers} ${currentLang === 'ko' ? 'íŒ”ë¡œì›Œ' : 'Followers'}</div>
                                ${followHtml}
                            </div>`;
                    });
                    document.getElementById('editor-list-container').innerHTML = editorsHtml;
                }
                
                const renderer = function(list, tid, isPopular = false) {
                    if (globalRegion !== 'national') {
                        list = list.filter(r => (r.address || '').includes(globalRegion));
                    }
                    if (list.length === 0) { 
                        document.getElementById(tid).innerHTML = `<div style="grid-column: span 2; padding:20px; color:var(--text-sub); text-align:center; font-size:13px;">í•´ë‹¹ ì§€ì—­ì˜ ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; 
                        return; 
                    }
                    
                    let html = '';
                    list.forEach(r => {
                        const finalImg = getSmartRestImage(r.kakao_id, r.category, r.image_url);
                        let subInfoHtml = isPopular && r.save_count ? `ğŸ”¥ ${r.save_count}ëª… ë“±ë¡` : `âœï¸ ${r.owner}`;
                        let bookmarkHtml = (r.owner !== localStorage.getItem('currentUser')) ? `
                            <div class="bookmark-btn-mini" onclick="event.stopPropagation(); executeBookmark('${r.id}')" style="position:absolute; bottom:8px; right:8px; background:rgba(255,255,255,0.9); padding:6px; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
                                <svg viewBox="0 0 24 24" style="width:16px; height:16px; stroke:var(--brand-primary); fill:none; stroke-width:2;"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                            </div>` : '';

                        html += `
                            <div class="rest-card" onclick="openRestDetail(\`${(r.name||'').replace(/`/g,"")}\`, \`${(r.category||'').replace(/`/g,"")}\`, \`${(r.address||'').replace(/`/g,"")}\`, \`${(r.comment||'').replace(/`/g,"")}\`, \`${r.tier||''}\`, \`${r.kakao_id||''}\`, \`${r.image_url||''}\`, \`${r.owner||''}\`, \`${r.id||''}\`, false)">
                                <div class="rest-img-wrapper">
                                    <img class="rest-img" src="${finalImg}" onerror="this.src='https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800&q=80'">
                                    ${bookmarkHtml}
                                </div>
                                <div class="rest-name">${r.name}</div>
                                <div style="font-size:11px; color:var(--text-sub); padding: 0 12px 12px;">${subInfoHtml}</div>
                            </div>`;
                    });
                    document.getElementById(tid).innerHTML = html;
                };
                
                renderer(d.popular_places || [], 'popular-list-container', true); 
                renderer(d.new_restaurants || [], 'new-list-container', false);
                
            } catch(error) {
                console.error("ë©”ì¸ ë°ì´í„° í˜ì¹˜ ì—ëŸ¬:", error);
            }
        }

        async function fetchNetworkData() {
            try {
                const res = await fetch(`${API_URL}/main/data`); 
                if (!res.ok) throw new Error("ì„œë²„ ì—ëŸ¬ ë°œìƒ");
                const d = await res.json();
                
                nationalTop50 = d.national_top_50 || [];
                regionalTop10 = d.regional_top_10 || {};

                const curUser = localStorage.getItem('currentUser');
                const me = (d.all_editors || []).find(e => e.username === curUser);
                if (me) followingList = me.following || [];
                
                let followingHtml = '';
                if (followingList.length > 0) {
                    followingList.forEach(u => {
                        const targetUser = (d.all_editors || []).find(e => e.username === u);
                        const displayName = targetUser ? (targetUser.display_name || u) : u;

                        followingHtml += `
                            <div class="user-result-item" onclick="fetchGuideView('${u}', true)" style="display:flex; align-items:center; padding:16px; background:var(--bg-card); border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-soft); cursor:pointer;">
                                <div style="width:48px; height:48px; border-radius:50%; overflow:visible; margin-right:16px;">${getAvatar(u)}</div>
                                <div style="flex:1;">
                                    <div style="font-weight:700; font-size:15px; color:var(--text-main); margin-bottom:4px;">${displayName}</div>
                                    <div class="tag-pill tag-blue" style="font-size:10px; padding:4px 8px; background:rgba(28, 30, 33, 0.05); color:var(--brand-primary); display:inline-block; border-radius:8px;">âœ“ ${currentLang === 'ko' ? 'íŒ”ë¡œì‰' : 'Following'}</div>
                                </div>
                                <div style="color:var(--text-sub);"><svg class="svg-icon" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                            </div>`;
                    });
                } else {
                    followingHtml = `<div style="text-align:center; padding:40px 20px; border:1px dashed var(--border-color); border-radius:var(--radius-lg); color:var(--text-sub); font-size:13px;">ì•„ì§ íŒ”ë¡œìš°í•œ ë¯¸ì‹ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                }
                document.getElementById('following-list-container').innerHTML = followingHtml;

                let recommendedSet = new Set();
                followingList.forEach(followedUser => {
                    const fUserObj = (d.all_editors || []).find(e => e.username === followedUser);
                    if (fUserObj && fUserObj.following) fUserObj.following.forEach(u => recommendedSet.add(u));
                });

                let recUsernames = Array.from(recommendedSet).filter(u => u !== curUser && !followingList.includes(u));
                if (recUsernames.length === 0) {
                    recUsernames = (d.all_editors || []).filter(e => e.username !== curUser && !followingList.includes(e.username)).slice(0, 10).map(e => e.username);
                }

                let recHtml = '';
                if (recUsernames.length > 0) {
                    const recommended = recUsernames.map(u => (d.all_editors || []).find(e => e.username === u)).filter(Boolean);
                    recHtml += `<div class="editor-row" style="padding-bottom: 10px;">`; 
                    recommended.forEach(e => {
                        recHtml += `
                            <div class="editor-card" onclick="fetchGuideView('${e.username}', true)">
                                <div class="editor-img-container" style="overflow:visible !important;">${getAvatar(e.username)}</div>
                                <div style="font-weight:800; font-size:14px; color:var(--brand-primary);">${e.display_name || e.username}</div>
                                <div style="font-size:11px; color:var(--text-sub); margin-top:4px;">${currentLang === 'ko' ? 'ê²Œì‹œë¬¼' : 'Posts'}: ${e.rest_count}</div>
                            </div>`;
                    });
                    recHtml += `</div>`; 
                } else {
                    recHtml = `<div style="text-align:center; padding:40px 20px; border:1px dashed var(--border-color); border-radius:var(--radius-lg); color:var(--text-sub); font-size:13px;">ì¶”ì²œí•  ë¯¸ì‹ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                }
                document.getElementById('recommended-list-container').innerHTML = recHtml;
                
            } catch(error) {
                console.error("ë„¤íŠ¸ì›Œí¬ íƒ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", error);
            }
        }

        function switchExploreTab(tab) {
            if (tab === 'ranking') {
                document.getElementById('tab-explore-ranking').style.background = 'var(--brand-primary)';
                document.getElementById('tab-explore-ranking').style.color = '#FFFFFF';
                document.getElementById('tab-explore-feed').style.background = '#EAEAEA';
                document.getElementById('tab-explore-feed').style.color = '#111111';
                document.getElementById('explore-ranking-area').style.display = 'block';
                document.getElementById('explore-feed-area').style.display = 'none';
                fetchRankingData(); 
            } else {
                document.getElementById('tab-explore-feed').style.background = 'var(--brand-primary)';
                document.getElementById('tab-explore-feed').style.color = '#FFFFFF';
                document.getElementById('tab-explore-ranking').style.background = '#EAEAEA';
                document.getElementById('tab-explore-ranking').style.color = '#111111';
                document.getElementById('explore-feed-area').style.display = 'block';
                document.getElementById('explore-ranking-area').style.display = 'none';
                fetchExploreFeed(); 
            }
        }

        function renderRankingList(rankingData, container) {
            let html = '';
            if(rankingData.length === 0) {
                html = `<div style="text-align:center; padding:40px; border:1px dashed var(--border-color); border-radius:12px; color:var(--text-sub); font-size:13px;">ê²€ìƒ‰ëœ ì¡°ê±´ì˜ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            } else {
                rankingData.forEach((r, idx) => {
                    const finalImg = getSmartRestImage(r.kakao_id, r.category, r.image_url);
                    let rankBadge = `<div style="font-size:18px; font-weight:900; color:var(--text-sub);">${idx + 1}</div>`;
                    if(idx === 0) rankBadge = `<div style="font-size:24px;">ğŸ¥‡</div>`;
                    else if (idx === 1) rankBadge = `<div style="font-size:24px;">ğŸ¥ˆ</div>`;
                    else if (idx === 2) rankBadge = `<div style="font-size:24px;">ğŸ¥‰</div>`;

                    html += `
                        <div class="user-result-item" onclick="closeGlobalSearchModal(); openRestDetail(\`${(r.name||'').replace(/'/g,"")}\`, \`${(r.category||'').replace(/'/g,"")}\`, \`${(r.address||'').replace(/'/g,"")}\`, '', '', \`${r.kakao_id}\`, \`${r.image_url}\`, '', \`${r.id}\`, false)" style="display:flex; align-items:center; padding:16px; background:var(--bg-card); border-radius:16px; margin-bottom:12px; box-shadow:var(--shadow-soft); cursor:pointer;">
                            <div style="width:40px; text-align:center; margin-right:10px;">${rankBadge}</div>
                            <div style="width:60px; height:60px; border-radius:12px; overflow:hidden; flex-shrink:0; margin-right:16px;">
                                <img src="${finalImg}" style="width:100%; height:100%; object-fit:cover;">
                            </div>
                            <div style="flex:1;">
                                <div style="font-weight:800; font-size:15px; color:var(--text-main); margin-bottom:4px;">${r.name}</div>
                                <div style="font-size:11px; color:var(--text-sub); margin-bottom:6px;">${r.category.split('>').pop()}</div>
                                <div class="tag-pill tag-pink" style="font-size:10px; padding:4px 8px; background:rgba(255,90,32,0.1); color:var(--brand-fab); display:inline-block; border-radius:8px; font-weight:700;">ğŸ”¥ ${r.save_count}ëª…ì´ ì„œì—´ì— ë“±ë¡</div>
                            </div>
                        </div>`;
                });
            }
            container.innerHTML = html;
        }

        async function fetchRankingData() {
            const keyword = document.getElementById('ranking-search-input').value.trim();
            const container = document.getElementById('ranking-list-container');
            container.innerHTML = `<div style="text-align:center; padding:30px; color:var(--brand-primary); font-size:13px; font-weight:700;">ë­í‚¹ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... â³</div>`;
            
            try {
                const res = await fetch(`${API_URL}/ranking?keyword=${encodeURIComponent(keyword)}`);
                const d = await res.json();
                renderRankingList(d.ranking, container);
            } catch(e) { 
                container.innerHTML = `<div style="color: red; text-align: center; padding: 20px;">ì„œë²„ì™€ì˜ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>`;
            }
        }

        function openGlobalSearchModal() {
            document.getElementById('global-search-modal').style.display = 'flex';
            document.getElementById('global-ranking-input').value = '';
            document.getElementById('global-search-results').innerHTML = `<div style="text-align:center; padding:40px 20px; color:var(--text-sub); font-size:13px;">ì›í•˜ì‹œëŠ” ë©”ë‰´ë‚˜ ì‹ë‹¹ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì‹œë©´<br>ê°€ì¥ ë§ì´ ë“±ë¡ëœ ìˆœì„œëŒ€ë¡œ ë­í‚¹ì„ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.</div>`;
        }
        function closeGlobalSearchModal() { document.getElementById('global-search-modal').style.display = 'none'; }
        
        async function executeGlobalSearch() {
            const keyword = document.getElementById('global-ranking-input').value.trim();
            const container = document.getElementById('global-search-results');
            container.innerHTML = `<div style="text-align:center; padding:30px; color:var(--brand-primary); font-size:13px; font-weight:700;">ë­í‚¹ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... â³</div>`;
            
            try {
                const res = await fetch(`${API_URL}/ranking?keyword=${encodeURIComponent(keyword)}`);
                const d = await res.json();
                renderRankingList(d.ranking, container);
            } catch(e) {
                container.innerHTML = `<div style="color: red; text-align: center; padding: 20px;">í†µì‹  ì‹¤íŒ¨.</div>`;
            }
        }

        async function fetchExploreFeed() {
            try {
                const current = localStorage.getItem('currentUser');
                const res = await fetch(`${API_URL}/feed`); 
                if (!res.ok) throw new Error("ì„œë²„ ì—ëŸ¬ ë°œìƒ");
                let feedList = await res.json();
                if (!Array.isArray(feedList)) feedList = feedList.data || [];
                
                if (globalRegion !== 'national') {
                    feedList = feedList.filter(r => (r.address || '').includes(globalRegion));
                }

                if (!feedList || feedList.length === 0) {
                    document.getElementById('feed-scroll-area').innerHTML = `<div style="text-align:center; padding:60px 20px; border:1px dashed var(--border-color); border-radius:var(--radius-lg); color:var(--text-sub); font-size:14px;">í•´ë‹¹ ì§€ì—­ì— ì•„ì§ ì†Œì‹ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                    return;
                }
                
                let html = '';
                feedList.reverse().forEach(r => {
                    const isMe = (r.owner === current); 
                    const isFollowing = followingList.includes(r.owner);
                    const finalImg = getSmartRestImage(r.kakao_id, r.category, r.image_url);
                    const fallbackImg = "https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800&q=80";
                    const safeName = (r.name || '').replace(/`/g, "");
                    const safeCat = (r.category || '').replace(/`/g, "");
                    const safeAddr = (r.address || '').replace(/`/g, "");
                    const safeComment = (r.comment || '').replace(/`/g, "");
                    const likesCount = (r.likes || []).length;
                    const isLiked = (r.likes || []).includes(current);

                    let socialHtml = `
                        <div class="social-bar" onclick="event.stopPropagation()" style="display:flex; justify-content:space-between; align-items:center; padding-top:16px; border-top:1px solid var(--border-color); margin-top:16px;">
                            <div style="display:flex; gap:16px;">
                                <div id="like-btn-${r.id}" class="action-btn ${isLiked ? 'liked' : ''}" onclick="executeLike('${r.id}')" style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                    <svg class="svg-icon" viewBox="0 0 24 24" style="width:20px; height:20px; stroke:var(--text-sub); fill:${isLiked ? 'var(--brand-fab)' : 'none'};"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                    <span id="like-count-${r.id}" style="color:var(--text-sub); font-size:13px; font-weight:600;">${likesCount}</span>
                                </div>
                                <div class="action-btn" onclick="openRestDetail(\`${safeName}\`, \`${safeCat}\`, \`${safeAddr}\`, \`${safeComment}\`, \`${r.tier||''}\`, \`${r.kakao_id||''}\`, \`${r.image_url||''}\`, \`${r.owner||''}\`, \`${r.id||''}\`, false)" style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                    <svg class="svg-icon" viewBox="0 0 24 24" style="width:20px; height:20px; stroke:var(--text-sub);"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                                </div>
                            </div>`;
                    
                    if (!isMe) {
                        socialHtml += `<div class="action-btn" onclick="executeBookmark('${r.id}')" style="cursor:pointer;"><svg class="svg-icon" viewBox="0 0 24 24" style="width:20px; height:20px; stroke:var(--text-sub);"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg></div>`;
                    }
                    socialHtml += `</div>`;

                    html += `
                    <div class="feed-card" style="background:var(--bg-card); border-radius:var(--radius-xl); padding:24px; box-shadow:var(--shadow-soft); border:1px solid var(--border-color); margin-bottom:30px; cursor:pointer;" onclick="openRestDetail(\`${safeName}\`, \`${safeCat}\`, \`${safeAddr}\`, \`${safeComment}\`, \`${r.tier||''}\`, \`${r.kakao_id||''}\`, \`${r.image_url||''}\`, \`${r.owner||''}\`, \`${r.id||''}\`, false)">
                        <div class="feed-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;" onclick="event.stopPropagation()">
                            <div class="feed-user" onclick="fetchGuideView('${r.owner}', true)" style="font-weight:800; cursor:pointer; display:flex; align-items:center; gap:10px; color:var(--brand-primary);">
                                <div style="width:36px; height:36px; border-radius:50%; overflow:visible;">${getAvatar(r.owner)}</div>${r.owner}
                            </div>
                            ${!isMe ? `<button onclick="executeToggleFollow('${r.owner}')" style="background:transparent; border:1px solid var(--border-color); color:var(--text-sub); padding:6px 12px; border-radius:8px; font-weight:600; font-size:11px; cursor:pointer;">${isFollowing?'âœ“ íŒ”ë¡œì‰':'Follow'}</button>` : ''}
                        </div>
                        <div style="position:relative; width:100%; border-radius:16px; overflow:hidden; margin-bottom:20px;">
                            <img src="${finalImg}" class="feed-main-img" onerror="this.src='${fallbackImg}'" style="width:100%; height:260px; object-fit:cover;">
                            ${r.tier ? `<div class="rest-badge" style="position:absolute; top:12px; right:12px; background:rgba(0,0,0,0.7); color:white; padding:6px 12px; border-radius:10px; font-size:11px; font-weight:800;">â­ï¸ ${r.tier.split(' ')[0]}</div>` : ''}
                        </div>
                        <div class="feed-body" style="padding:0;">
                            <div class="feed-rest-name" style="font-size:20px; font-weight:900; color:var(--text-main); margin-bottom:8px;">${r.name}</div>
                            <div style="font-size:12px; color:var(--text-sub); margin-bottom:16px; font-weight:500; display:flex; align-items:center; gap:6px;">
                                <span>ğŸ“ ${r.address.split(' ')[0]} ${r.address.split(' ')[1] || ''}</span><span>â€¢</span><span>${r.category.split('>').pop()}</span>
                            </div>
                            ${r.comment ? `<div style="font-size:14px; color:var(--text-main); line-height:1.6; font-weight:400;">"${r.comment}"</div>` : ''}
                            ${socialHtml}
                        </div>
                    </div>`;
                });
                document.getElementById('feed-scroll-area').innerHTML = html;
            } catch(error) {
                console.error("í”¼ë“œ ë¡œë“œ ì‹¤íŒ¨:", error);
            }
        }

        async function fetchGuideView(u, isForeign = false) {
            if (isForeign) { 
                switchTab('profile', true); 
                document.getElementById('registration-trigger').style.display = 'none'; 
            } else { 
                document.getElementById('registration-trigger').style.display = 'block'; 
            }
            
            const curUser = localStorage.getItem('currentUser');
            const isMe = (u === curUser);
            const isFollowing = followingList.includes(u);
            
            try {
                const res = await fetch(`${API_URL}/guide/${u}`);
                if (!res.ok) throw new Error("ì„œë²„ ì—ëŸ¬ ë°œìƒ");
                
                const data = await res.json(); 
                currentProfileGuideData = data.guide;
                currentProfileOwner = u;
                currentProfileIsMe = isMe;
                currentProfilePhilosophy = data.philosophy || '';
                currentProfileTags = data.taste_tags || [];
                currentProfilePersonalInfo = data.personal_info || '';

                if (isMe) {
                    const myRes = await fetch(`${API_URL}/restaurants`, { headers: { 'user-id': u } });
                    const myData = await myRes.json();
                    currentProfileGuideData["í‰ê°€ ëŒ€ê¸° ì¤‘ â³"] = myData.data.filter(r => !r.tier);
                }

                let regionCounts = {}; 
                let maxCount = 0; 
                currentProfileLocalRegion = '';
                
                Object.values(currentProfileGuideData).forEach(tierList => {
                    tierList.forEach(item => {
                        if (item.address) {
                            let region = item.address.split(' ')[0];
                            regionCounts[region] = (regionCounts[region] || 0) + 1;
                            if (regionCounts[region] > maxCount) { 
                                maxCount = regionCounts[region]; 
                                currentProfileLocalRegion = region; 
                            }
                        }
                    });
                });

                const philosophyHtml = currentProfilePhilosophy ? `<div class="profile-philosophy">"${currentProfilePhilosophy}"</div>` : '';
                const tagsHtml = currentProfileTags.length > 0 ? `<div class="profile-dna-tags">${currentProfileTags.map(t => `<div class="dna-tag">#${t}</div>`).join('')}</div>` : '';
                const badgesHtml = data.badges && data.badges.length > 0 ? `<div class="profile-badges">${data.badges.map(b => `<span class="badge-item">${b}</span>`).join('')}</div>` : '';

                let editBtnHtml = isMe ? `<button class="my-journal-btn" onclick="openEditProfileModal()" style="position:absolute; top:24px; right:24px; background:rgba(255,255,255,0.1); color:#FFF; border:1px solid rgba(255,255,255,0.3); padding:6px 16px; border-radius:20px; font-size:10px; font-weight:700; cursor:pointer; z-index:10; backdrop-filter:blur(4px);">EDIT PROFILE</button>` : '';
                let followBtnHtml = !isMe ? `<button onclick="executeToggleFollow('${u}', true)" style="background:var(--brand-fab); color:#FFF; border:none; padding:12px 36px; border-radius:24px; font-weight:800; font-size:13px; cursor:pointer; margin-bottom:10px; box-shadow:var(--shadow-fab); transition:all 0.2s; margin-top: 20px;">${isFollowing ? (currentLang==='ko'?'âœ“ íŒ”ë¡œì‰':'âœ“ Following') : (currentLang==='ko'?'+ íŒ”ë¡œìš°':'+ Follow')}</button>` : '';

                document.getElementById('profile-header-target').innerHTML = `
                    <div class="profile-dash">
                        ${editBtnHtml} 
                        <div class="dash-header">
                            <div class="dash-pic-container" ${isMe ? `onclick="triggerProfileUpload()"` : ''}>${getAvatar(u)}</div>
                            <div style="font-size:26px; font-weight:900; margin-bottom:8px; display:flex; justify-content:center; align-items:center; gap:8px; letter-spacing:-0.5px;">
                                <span id="display-profile-name">${data.nickname || u}</span>
                            </div>
                            ${philosophyHtml}${tagsHtml}${badgesHtml}${followBtnHtml}
                        </div>
                        <div class="dash-stats" id="profile-stats-bar"></div>
                    </div>`;
            } catch(error) {
                console.error("í”„ë¡œí•„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", error);
            }
            
            fetchStats(u);
            document.getElementById('guide-controls-target').style.display = 'block';
            document.getElementById('guide-search-input').value = '';
            switchGuideTab('national'); 
        }

        function switchGuideTab(tab) {
            activeGuideTab = tab;
            renderGuideSheet();
        }

        function renderGuideSheet() {
            let searchQuery = document.getElementById('guide-search-input') ? document.getElementById('guide-search-input').value.toLowerCase() : '';
            
            const tierMeta = { 
                "â­â­â­ (3ìŠ¤íƒ€)": { title: "3 STARS", sub: "NO.1 CLASS", color: "var(--brand-yellow)" }, 
                "â­â­ (2ìŠ¤íƒ€)": { title: "2 STARS", sub: "PREMIUM", color: "#FFFFFF" }, 
                "â­ (1ìŠ¤íƒ€)": { title: "1 STAR", sub: "EXCELLENT", color: "#CCCCCC" }, 
                "ë‹¨ìˆœ ì¶”ì²œ": { title: "RECOMMENDED", sub: "REC", color: "#A86A51" }, 
                "í‰ê°€ ëŒ€ê¸° ì¤‘ â³": { title: "WISHLIST", sub: "WISH", color: "#777777" } 
            };
            
            let html = '';
            let hasAnyItem = false;
            
            for(let key in tierMeta) {
                let items = currentProfileGuideData[key] || [];
                items = items.filter(item => {
                    let matchSearch = true;
                    if (searchQuery) {
                        const nameStr = (item.name || '').toLowerCase();
                        const catStr = (item.category || '').toLowerCase();
                        const addrStr = (item.address || '').toLowerCase();
                        matchSearch = nameStr.includes(searchQuery) || catStr.includes(searchQuery) || addrStr.includes(searchQuery);
                    }
                    let matchTab = true;
                    if (activeGuideTab !== 'national') matchTab = (item.address || '').startsWith(currentProfileLocalRegion);
                    return matchSearch && matchTab;
                });

                if (items.length > 0) {
                    hasAnyItem = true;
                    const meta = tierMeta[key];
                    html += `
                        <div class="tier-section" style="margin-bottom: 30px;">
                            <div class="tier-header-title">${meta.title} <span style="font-size:14px; color:var(--text-sub);">${items.length}</span></div>
                            <div class="guide-grid">`;
                    
                    items.forEach(i => {
                        const safeName = (i.name || '').replace(/'/g, "");
                        const safeCat = (i.category || '').replace(/'/g, "");
                        const safeAddr = (i.address || '').replace(/'/g, "");
                        const safeComment = (i.comment || '').replace(/'/g, "");
                        const finalImg = getSmartRestImage(i.kakao_id, i.category, i.image_url);
                        
                        let selectHtml = currentProfileIsMe ? `
                                <select onchange="executeChangeTier('${i.id}', this.value)" onclick="event.stopPropagation()" style="position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.8); color:#FFF; border:1px solid rgba(255,255,255,0.3); border-radius:8px; font-size:11px; padding:6px; outline:none; font-weight:600;">
                                    <option value="">ë“±ê¸‰ìˆ˜ì •</option>
                                    <option value="â­â­â­ (3ìŠ¤íƒ€)" ${i.tier === 'â­â­â­ (3ìŠ¤íƒ€)' ? 'selected' : ''}>3 Stars</option>
                                    <option value="â­â­ (2ìŠ¤íƒ€)" ${i.tier === 'â­â­ (2ìŠ¤íƒ€)' ? 'selected' : ''}>2 Stars</option>
                                    <option value="â­ (1ìŠ¤íƒ€)" ${i.tier === 'â­ (1ìŠ¤íƒ€)' ? 'selected' : ''}>1 Star</option>
                                    <option value="ë‹¨ìˆœ ì¶”ì²œ" ${i.tier === 'ë‹¨ìˆœ ì¶”ì²œ' ? 'selected' : ''}>Rec</option>
                                    <option value="" ${!i.tier ? 'selected' : ''}>Wishlist</option>
                                </select>` : '';

                        html += `
                            <div class="guide-card" onclick="openRestDetail('${safeName}', '${safeCat}', '${safeAddr}', '${safeComment}', '${i.tier||''}', '${i.kakao_id||''}', '${i.image_url||''}', '${currentProfileOwner}', '${i.id||''}')">
                                <img class="guide-card-bg" src="${finalImg}" onerror="this.src='https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800&q=80'">
                                <div class="guide-card-overlay">
                                    <div class="guide-tier-text" style="color:${meta.color};">${meta.sub}</div>
                                    <div class="guide-name-text">${i.name}</div>
                                    <div style="font-size:10px; color:#ddd; margin-top:4px; font-weight:500;">
                                        ${i.address ? i.address.split(' ')[0] : ''} Â· ${i.category ? i.category.split('>').pop().trim() : ''}
                                    </div>
                                </div>
                                ${selectHtml}
                            </div>`;
                    });
                    html += `</div></div>`;
                }
            }
            if (!hasAnyItem) {
                html = `<div style="text-align:center; padding:50px 20px; border:1px dashed var(--border-color); border-radius:var(--radius-lg); color:var(--text-sub); font-size:13px; font-weight:600;">ê¸°ë¡ëœ ë§›ì§‘ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }
            document.getElementById('michelin-tables-target').innerHTML = html;
        }

        async function fetchStats(u) {
            try {
                const res = await fetch(`${API_URL}/profile/stats`, { headers: { 'user-id': u } });
                const d = await res.json();
                const bar = document.getElementById('profile-stats-bar');
                if (bar) {
                    let statsHtml = '';
                    Object.keys(d.stats).forEach(k => {
                        statsHtml += `
                            <div style="text-align:center;">
                                <div style="font-weight:800; font-size:20px; line-height:1; color:#FFFFFF;">${d.stats[k].count}</div>
                                <div style="font-size:10px; font-weight:600; color:rgba(255,255,255,0.6); margin-top:6px; text-transform:uppercase; letter-spacing:1px;">${k.split(' ')[0]}</div>
                            </div>`;
                    });
                    bar.innerHTML = statsHtml;
                }
            } catch(e) {}
        }

        async function executeChangeTier(id, tier) {
            const user = localStorage.getItem('currentUser');
            try {
                await fetch(`${API_URL}/restaurants/${id}`, { 
                    method: 'PUT', headers: { 'Content-Type': 'application/json', 'user-id': user }, body: JSON.stringify({ tier: tier }) 
                });
                fetchGuideView(user);
            } catch(e) {}
        }

        async function executeToggleFollow(target, isFromProfile = false) {
            const user = localStorage.getItem('currentUser');
            try {
                const res = await fetch(`${API_URL}/follow/${target}`, { method: 'POST', headers: { 'user-id': user } });
                if (res.ok) { 
                    const data = await res.json();
                    followingList = data.following; 
                    if (isFromProfile) fetchGuideView(target, true); 
                    else fetchNetworkData(); 
                }
            } catch(e) {}
        }

        function openSearchModal() { switchTab('profile'); document.getElementById('search-modal').style.display = 'flex'; }
        function closeSearchModal() { document.getElementById('search-modal').style.display = 'none'; }

        async function executeKakaoSearch() {
            const keyword = document.getElementById('search-keyword').value;
            if (!keyword) return;
            try {
                const res = await fetch(`${API_URL}/search/kakao?query=${encodeURIComponent(keyword)}`);
                const d = await res.json();
                
                if (d.errorType || d.msg || d.code) {
                    alert(`ğŸš¨ ì¹´ì¹´ì˜¤ ì„œë²„ ì°¨ë‹¨ ì‚¬ìœ : ${d.message || d.msg || d.code}`);
                    return;
                }

                const target = document.getElementById('search-results-target');
                if (!d.documents || d.documents.length === 0) { 
                    target.innerHTML = `<div style="text-align:center; padding:40px 20px; color:var(--text-sub); font-size:13px; font-weight:600;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; 
                    return; 
                }
                
                let html = '';
                d.documents.forEach(doc => {
                    const safeName = doc.place_name.replace(/'/g, "\\'");
                    const safeCat = doc.category_name.replace(/'/g, "\\'");
                    const safeAddr = (doc.road_address_name || doc.address_name).replace(/'/g, "\\'");
                    html += `
                        <div class="user-result-item" onclick="preparePosting('${safeName}', '${safeCat}', '${safeAddr}', '${doc.id}', ${doc.x}, ${doc.y}, '${doc.phone || ''}')" style="border:none; border-bottom:1px solid var(--border-color); border-radius:0; box-shadow:none; padding:16px 0; background:transparent; cursor:pointer;">
                            <div style="flex:1;">
                                <div style="font-weight:800; font-size:15px; color:var(--brand-primary); margin-bottom:4px;">${doc.place_name}</div>
                                <div style="font-size:12px; color:var(--text-sub); font-weight:500;">${doc.road_address_name || doc.address_name}</div>
                            </div>
                            <div style="color:var(--brand-fab);"><svg class="svg-icon" viewBox="0 0 24 24" style="width:20px; height:20px;"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></div>
                        </div>`;
                });
                target.innerHTML = html;
            } catch(e) {
                alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ë Œë” ì„œë²„ê°€ ì¼œì ¸ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
            }
        }

        function handleImagePreview(input) {
            const photoBox = document.getElementById('selected-rest-photo');
            if (input.files && input.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoBox.style.backgroundImage = `url('${e.target.result}')`;
                    const statusText = input.files.length > 1 ? `ğŸ”¥ ì´ ${input.files.length}ì¥ì˜ ì‚¬ì§„ ì„ íƒë¨` : `âœ… ì‚¬ì§„ 1ì¥ ì„ íƒë¨`;
                    photoBox.innerHTML = `<div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.7); color:white; font-size:12px; font-weight:800; text-align:center; padding: 10px 0;">${statusText}</div>`;
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                photoBox.style.backgroundImage = 'none';
                photoBox.innerHTML = '';
            }
        }

        function preparePosting(n, c, a, id, x, y, phone) {
            closeSearchModal();
            const form = document.getElementById('post-detail-modal');
            form.style.display = 'flex';
            
            document.getElementById('h-name').value = n;
            document.getElementById('h-cat').value = c.split('>').pop().trim();
            document.getElementById('h-addr').value = a;
            document.getElementById('h-id').value = id;
            document.getElementById('h-x').value = x;
            document.getElementById('h-y').value = y;
            document.getElementById('h-phone').value = phone || '';
            
            document.getElementById('selected-info-text').innerHTML = `<b style="font-size:20px; font-weight:900; color:var(--brand-primary);">${n}</b><br><span style="font-size:13px; color:var(--text-sub); font-weight:600; display:inline-block; margin-top:4px;">${a}</span>`;

            const photoBox = document.getElementById('selected-rest-photo');
            photoBox.style.backgroundImage = `url('${getSmartRestImage(id, c, null)}')`;
            photoBox.innerHTML = '<div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.6); color:white; font-size:11px; font-weight:700; text-align:center; padding: 6px 0;">âœ¨ AI Theme Image</div>'; 
            
            const photoUrl = `https://img1.kakaocdn.net/cthumb/local/R0x0/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flocalfiy%2Fsearch%2Fplace%2F${id}`;
            let img = new Image();
            img.onload = function() { 
                photoBox.style.backgroundImage = `url('${photoUrl}')`; 
                photoBox.innerHTML = `<div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.6); color:white; font-size:11px; font-weight:700; text-align:center; padding: 6px 0;">ğŸ“ Basic Location Image</div>`;
            };
            img.src = photoUrl;

            setTimeout(() => {
                if (typeof kakao !== 'undefined' && kakao.maps) {
                    const mapArea = document.getElementById('map-preview-area');
                    mapArea.innerHTML = ''; 
                    const loc = new kakao.maps.LatLng(Number(y), Number(x));
                    if (!previewMap) {
                        previewMap = new kakao.maps.Map(mapArea, { center: loc, level: 3 });
                        previewMarker = new kakao.maps.Marker({ position: loc, map: previewMap });
                    } else {
                        previewMap.relayout();
                        previewMap.setCenter(loc);
                        previewMarker.setPosition(loc);
                    }
                    setTimeout(() => { previewMap.relayout(); previewMap.setCenter(loc); }, 200);
                }
            }, 300); 
        }

        function cancelPosting() { 
            document.getElementById('post-detail-modal').style.display = 'none'; 
            document.getElementById('post-image').value = '';
            document.getElementById('post-comment').value = '';
        }

        async function executeAddRestaurant() {
            const user = localStorage.getItem('currentUser');
            const fd = new FormData();
            fd.append('name', document.getElementById('h-name').value);
            fd.append('category', document.getElementById('h-cat').value);
            fd.append('address', document.getElementById('h-addr').value);
            fd.append('kakao_id', document.getElementById('h-id').value);
            fd.append('x', document.getElementById('h-x').value);
            fd.append('y', document.getElementById('h-y').value);
            
            const comment = document.getElementById('post-comment').value;
            if (!comment) { alert("ë¯¸ì‹í‰ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."); return; }
            fd.append('comment', comment);
            
            const files = document.getElementById('post-image').files;
            if (files && files.length > 0) { 
                for(let i=0; i<files.length; i++) fd.append('images', files[i]); 
            }

            try {
                const res = await fetch(`${API_URL}/restaurants`, { method: 'POST', headers: { 'user-id': encodeURI(user) }, body: fd });
                if (res.ok) { 
                    alert("ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“"); 
                    cancelPosting(); 
                    fetchGuideView(user); 
                } else { 
                    alert(`ğŸš¨ ì„œë²„ ì €ì¥ ì‹¤íŒ¨! (ì½”ë“œ: ${res.status})`); 
                }
            } catch(e) { 
                alert(`ğŸš¨ ë„¤íŠ¸ì›Œí¬ í†µì‹  ì—ëŸ¬ ë°œìƒ!\n${e.message}`); 
            }
        }

        async function executeDeleteRestaurant() {
            if (!confirm("ì´ ë§›ì§‘ ê¸°ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const user = localStorage.getItem('currentUser');
            try {
                const res = await fetch(`${API_URL}/restaurants/${currentOpenRestId}`, { method: 'DELETE', headers: { 'user-id': encodeURI(user) } });
                if (res.ok) {
                    alert("ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeRestDetail(); 
                    fetchGuideView(user); 
                }
            } catch (error) {}
        }

        function openRestDetail(name, category, address, comment, tier, kakao_id, img_url, owner, db_id, showGuestbook = false) {
            document.getElementById('restaurant-detail-modal').style.display = 'flex';
            const user = localStorage.getItem('currentUser');
            currentOpenRestId = db_id; 
            
            const detailImgEl = document.getElementById('detail-img');
            const finalImg = getSmartRestImage(kakao_id, category, img_url);
            
            detailImgEl.querySelector('.multi-image-slider')?.remove();
            detailImgEl.querySelector('.image-indicator')?.remove();
            detailImgEl.style.backgroundImage = `url('${finalImg}')`;
            
            document.getElementById('delete-rest-btn').style.display = (owner === user && db_id) ? 'block' : 'none';
            const aiBtn = document.getElementById('ai-sync-btn');
            if (owner === user && db_id) {
                aiBtn.style.display = 'block';
                aiBtn.onclick = (e) => { e.stopPropagation(); openAIPicker(db_id, name); };
            } else { aiBtn.style.display = 'none'; }

            document.getElementById('detail-name').innerText = name;
            document.getElementById('detail-category').innerText = category.split('>').pop().trim();
            document.getElementById('detail-address').innerText = `ğŸ“ ${address.split(' ')[0]} ${address.split(' ')[1] || ''}`;
            document.getElementById('detail-comment').innerText = comment && comment !== "undefined" ? `"${comment}"` : "ë“±ë¡ëœ ë¯¸ì‹í‰ì´ ì—†ìŠµë‹ˆë‹¤.";
            document.getElementById('detail-tier').innerText = tier ? `â­ï¸ ${tier.split(' ')[0]}` : "New Entry";
            
            const ownerBtn = document.getElementById('detail-owner');
            ownerBtn.innerText = `âœï¸ ${owner}`;
            ownerBtn.onclick = () => { closeRestDetail(); fetchGuideView(owner, true); };

            const followBtn = document.getElementById('detail-follow-btn');
            if (owner === user || !owner) {
                followBtn.style.display = 'none';
            } else {
                followBtn.style.display = 'inline-block';
                followBtn.innerText = followingList.includes(owner) ? 'âœ“ íŒ”ë¡œì‰' : '+ íŒ”ë¡œìš°';
                followBtn.onclick = (e) => {
                    e.stopPropagation();
                    executeToggleFollow(owner, false).then(() => {
                        followBtn.innerText = followingList.includes(owner) ? 'âœ“ íŒ”ë¡œì‰' : '+ íŒ”ë¡œìš°';
                    });
                };
            }
            
            document.getElementById('detail-phone').style.display = 'none';
            document.getElementById('detail-map-area').innerHTML = `<div style="text-align:center; padding:100px 0; color:var(--text-sub); font-size:13px; font-weight:600;">ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>`;

            document.querySelector('.aggregated-reviews')?.remove();
            document.querySelector('.comment-area')?.remove();

            if (db_id) {
                fetch(`${API_URL}/feed`).then(r => r.json()).then(res => {
                    const dataList = Array.isArray(res) ? res : (res.data || []);
                    const targetData = dataList.find(item => item.id === db_id);
                    
                    if (targetData && targetData.image_urls && targetData.image_urls.length > 1) {
                        let sliderHtml = `<div class="multi-image-slider">`;
                        let indicatorHtml = `<div class="image-indicator" style="position:absolute; top:12px; left:12px; background:rgba(0,0,0,0.8); color:var(--brand-yellow); padding:6px 14px; border-radius:12px; font-size:11px; font-weight:800; z-index:15;">ğŸ“¸ ë‹¤ì¤‘ ì‚¬ì§„ (${targetData.image_urls.length}ì¥)</div>`;
                        targetData.image_urls.forEach(u => sliderHtml += `<img src="${u}" class="multi-image-slide" onerror="this.src='https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800&q=80'">`);
                        sliderHtml += `</div>`;
                        detailImgEl.style.backgroundImage = 'none';
                        detailImgEl.insertAdjacentHTML('afterbegin', indicatorHtml + sliderHtml);
                    }
                    
                    const samePlaces = dataList.filter(item => item.kakao_id === kakao_id && item.comment);
                    let reviewHtml = samePlaces.length > 0 ? samePlaces.map(p => `
                        <div style="padding: 16px 0; border-bottom: 1px dashed var(--border-color);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <div style="font-weight:800; font-size:13px; color:var(--brand-primary); cursor:pointer;" onclick="closeRestDetail(); fetchGuideView('${p.owner}', true)">ğŸ§‘â€ğŸ³ ${p.owner}</div>
                                ${p.tier ? `<span class="s-badge" style="position:static; font-size:9px; padding:4px 8px;">${p.tier.split(' ')[0]}</span>` : ''}
                            </div>
                            <div style="color:var(--text-main); font-size: 14px; line-height:1.6; font-weight:500;">"${p.comment}"</div>
                        </div>`).join('') : `<div style="color:var(--text-sub); font-size:12px; text-align:center; padding: 20px 0; font-weight:500;">ì•„ì§ ë‹¤ë¥¸ ë¯¸ì‹ê°€ë“¤ì˜ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;

                    const aggregatedHtml = `
                        <div class="aggregated-reviews" style="padding: 24px; background:var(--bg-main); border-radius:16px; margin-bottom:24px;">
                            <div style="font-size:12px; font-weight:800; margin-bottom:16px; color:var(--brand-primary); text-transform:uppercase;">ğŸ’¡ ì´ ì‹ë‹¹ì— ëŒ€í•œ ë‹¤ë¥¸ ë¯¸ì‹ê°€ë“¤ì˜ í•œì¤„í‰</div>
                            <div style="max-height:200px; overflow-y:auto; padding-right:8px;">${reviewHtml}</div>
                        </div>`;

                    let guestbookHtml = targetData && showGuestbook ? `
                        <div class="comment-area" style="background:var(--bg-main); border-radius:16px; padding:20px; margin-bottom:30px;">
                            <div style="font-size:12px; font-weight:800; margin-bottom:16px; color:var(--brand-primary); text-transform:uppercase;">ğŸ’¬ ${owner}ë‹˜ì˜ ê¸°ë¡ì— ë°©ëª…ë¡ ë‚¨ê¸°ê¸°</div>
                            <div id="comment-list-${db_id}" class="comment-list"></div>
                            <div class="comment-input-row" style="display:flex; gap:10px; margin-top:10px;">
                                <input type="text" id="comment-input-${db_id}" class="comment-input input-field" placeholder="ë°©ëª…ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”..." style="flex:1; margin:0;">
                                <button class="comment-btn btn-primary" onclick="submitComment('${db_id}')" style="width:auto; padding:12px 24px;">ê²Œì‹œ</button>
                            </div>
                        </div>` : '';

                    document.getElementById('detail-map-area').insertAdjacentHTML('beforebegin', aggregatedHtml + guestbookHtml);
                    if (targetData && showGuestbook) renderComments(db_id, targetData.comments || []);
                });
            }
            
            fetch(`${API_URL}/search/kakao?query=${encodeURIComponent(name)}`).then(res => res.json()).then(d => {
                const place = d.documents.find(doc => doc.id === kakao_id) || d.documents[0];
                if (place) {
                    if (place.phone) {
                        document.getElementById('detail-phone').innerText = `ğŸ“ ${place.phone}`;
                        document.getElementById('detail-phone').style.display = 'inline-block';
                    }
                    document.getElementById('detail-kakao-btn').onclick = () => window.open(place.place_url, '_blank');
                    setTimeout(() => {
                        if (typeof kakao !== 'undefined' && kakao.maps) {
                            const mapArea = document.getElementById('detail-map-area');
                            mapArea.innerHTML = ''; 
                            const loc = new kakao.maps.LatLng(Number(place.y), Number(place.x));
                            const map = new kakao.maps.Map(mapArea, { center: loc, level: 3 });
                            new kakao.maps.Marker({ position: loc, map: map });
                            setTimeout(() => { map.relayout(); map.setCenter(loc); }, 200);
                        }
                    }, 300);
                }
            });
        }

        function closeRestDetail() { 
            document.getElementById('restaurant-detail-modal').style.display = 'none'; 
            currentOpenRestId = null; 
        }

        async function openAIPicker(db_id, name) {
            document.getElementById('ai-image-modal').style.display = 'flex';
            const target = document.getElementById('ai-image-target');
            target.innerHTML = `<div style="grid-column: span 2; text-align:center; padding: 60px 0; color:var(--brand-primary); font-size:14px; font-weight:800; line-height: 1.6;">ì„œë²„ì—ì„œ ê³ í™”ì§ˆ ì‚¬ì§„ì„ ì¶”ì¶œ ì¤‘ì…ë‹ˆë‹¤...<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” â³</div>`;
            try {
                const res = await fetch(`${API_URL}/restaurants/${db_id}/ai-images?name=${encodeURIComponent(name)}`);
                const data = await res.json();
                if (data.images && data.images.length > 0) {
                    let html = '';
                    data.images.forEach(img => html += `<img src="${img}" class="ai-image-item" onclick="selectAIImage('${db_id}', '${img}')" onerror="this.style.display='none'" style="width:100%; height:150px; object-fit:cover; border-radius:12px; cursor:pointer;">`);
                    target.innerHTML = html;
                } else {
                    target.innerHTML = `<div style="grid-column: span 2; text-align:center; padding: 40px 0; color:var(--text-sub); font-size:13px; font-weight: 600;">ì‚¬ì§„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
                }
            } catch(error) {}
        }

        async function selectAIImage(db_id, img_url) {
            if (!confirm("ì´ ì‚¬ì§„ìœ¼ë¡œ ì‹ë‹¹ì˜ ëŒ€í‘œ ì´ë¯¸ì§€ë¥¼ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const user = localStorage.getItem('currentUser');
            try {
                const res = await fetch(`${API_URL}/restaurants/${db_id}/image`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'user-id': user }, body: JSON.stringify({ image_url: img_url }) });
                if (res.ok) {
                    alert("ëŒ€í‘œ ì‚¬ì§„ì´ ì„±ê³µì ìœ¼ë¡œ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨");
                    document.getElementById('ai-image-modal').style.display = 'none';
                    document.getElementById('restaurant-detail-modal').style.display = 'none';
                    fetchGuideView(user);
                }
            } catch(e) {}
        }

        async function fetchNotifications() {
            const user = localStorage.getItem('currentUser');
            if (!user) return;
            try {
                const res = await fetch(`${API_URL}/notifications`, { headers: { 'user-id': user } });
                if (res.ok) {
                    const data = await res.json();
                    const badge = document.getElementById('noti-badge');
                    badge.style.display = data.unread_count > 0 ? 'block' : 'none';
                }
            } catch(e) {}
        }

        async function openNotificationModal() {
            document.getElementById('notification-modal').style.display = 'flex';
            const target = document.getElementById('notification-list-target');
            const user = localStorage.getItem('currentUser');
            target.innerHTML = `<div style="text-align:center; padding:60px 20px; color:var(--brand-primary); font-size:14px; font-weight:800;">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>`;
            try {
                const res = await fetch(`${API_URL}/notifications`, { headers: { 'user-id': user } });
                const data = await res.json();
                if (!data.notifications || data.notifications.length === 0) {
                    target.innerHTML = `<div style="text-align:center; padding:60px 20px; color:var(--text-sub); font-size:13px; font-weight:600;">ì•„ì§ ë„ì°©í•œ ì†Œì‹ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                } else {
                    let html = '';
                    data.notifications.forEach(n => {
                        const icon = n.type === 'follow' ? 'ğŸ¤' : n.type === 'like' ? 'â¤ï¸' : n.type === 'comment' ? 'ğŸ’¬' : 'ğŸ””';
                        html += `
                            <div class="noti-item ${n.read ? '' : 'unread'}" style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; gap:16px; align-items:center; background:${n.read ? 'transparent' : 'rgba(255, 90, 32, 0.05)'};">
                                <div class="noti-icon" style="width:48px; height:48px; border-radius:50%; background:var(--bg-card); color:var(--brand-primary); display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; border: 1px solid var(--border-color);">${icon}</div>
                                <div style="flex:1; font-size:14px; color:var(--text-main); line-height:1.5; font-weight:600;">${n.message}</div>
                            </div>`;
                    });
                    target.innerHTML = html;
                }
                fetch(`${API_URL}/notifications/read`, { method: 'PUT', headers: { 'user-id': user } });
                document.getElementById('noti-badge').style.display = 'none';
            } catch(e) {}
        }

        function closeNotificationModal() { document.getElementById('notification-modal').style.display = 'none'; }

        async function executeBookmark(restaurant_id) {
            const user = localStorage.getItem('currentUser');
            try {
                const res = await fetch(`${API_URL}/restaurants/bookmark/${restaurant_id}`, { method: 'POST', headers: { 'user-id': user } });
                const data = await res.json();
                alert(data.message || "ìœ„ì‹œë¦¬ìŠ¤íŠ¸ì— ë‹´ì•˜ìŠµë‹ˆë‹¤!");
            } catch(e) {}
        }

        async function executeLike(restaurant_id) {
            const user = localStorage.getItem('currentUser');
            try {
                const res = await fetch(`${API_URL}/restaurants/${restaurant_id}/like`, { method: 'POST', headers: { 'user-id': user } });
                if (res.ok) {
                    const data = await res.json();
                    const countEl = document.getElementById(`like-count-${restaurant_id}`);
                    if (countEl) countEl.innerText = data.likes_count;
                    const btn = document.getElementById(`like-btn-${restaurant_id}`);
                    if (btn) {
                        const svg = btn.querySelector('svg');
                        if (data.liked) {
                            btn.classList.add('liked'); 
                            svg.style.fill = 'var(--brand-fab)';
                            svg.style.stroke = 'var(--brand-fab)';
                        } else {
                            btn.classList.remove('liked'); 
                            svg.style.fill = 'none';
                            svg.style.stroke = 'var(--text-sub)';
                        }
                    }
                }
            } catch(e) {}
        }

        function recommendAIComment() {
            const name = document.getElementById('h-name').value || "ì´ ê³³";
            const cat = document.getElementById('h-cat').value || "";
            const comments = {
                "ê³ ê¸°": [`ì…ì•ˆ ê°€ë“ í¼ì§€ëŠ” ìœ¡ì¦™ì´ ì˜ˆìˆ ì¸ ${name}!`, `ê³ ê¸° í€„ë¦¬í‹°ê°€ ë‚¨ë‹¤ë¥¸ ${name}, ê°•ë ¥ ì¶”ì²œí•©ë‹ˆë‹¤.`, `íšŒì‹ì´ë‚˜ ëª¨ì„ ì¥ì†Œë¡œ ì†ìƒ‰ì—†ëŠ” ${name}ì…ë‹ˆë‹¤.`],
                "ì¹´í˜": [`ë¶„ìœ„ê¸° ë§›ì§‘ ${name}, ì»¤í”¼ í–¥ì´ ë„ˆë¬´ ì¢‹ì•„ìš”.`, `ë””ì €íŠ¸ì™€ ì»¤í”¼ì˜ ì™„ë²½í•œ ì¡°í™”, ${name}ì—ì„œ íë§í•˜ê³  ê°‘ë‹ˆë‹¤.`, `ì¸í…Œë¦¬ì–´ê°€ ì˜ˆë»ì„œ ì‚¬ì§„ ì°ê¸° ì¢‹ì€ ${name}!`],
                "ì¼ì‹": [`ì‹ ì„ í•œ ì¬ë£Œê°€ ë‹ë³´ì´ëŠ” ${name}, í›Œë¥­í•œ ì‹ì‚¬ì˜€ìŠµë‹ˆë‹¤.`, `ì •ê°ˆí•˜ê³  ê¹”ë”í•œ ë§›, ${name}ì—ì„œì˜ í•œ ë¼ëŠ” ìµœê³ ë„¤ìš”.`, `ì…ì—ì„œ ì‚´ì‚´ ë…¹ëŠ” ë§›, ${name} ì¬ë°©ë¬¸ ì˜ì‚¬ 100%ì…ë‹ˆë‹¤.`],
                "ì¤‘ì‹": [`ë¶ˆë§›ì´ ì‚´ì•„ìˆëŠ” ${name}, ìê¾¸ ìƒê°ë‚˜ëŠ” ë§›ì…ë‹ˆë‹¤.`, `ìŠ¤íŠ¸ë ˆìŠ¤ í’€ë¦¬ëŠ” ë§¤ì½¤í•¨! ${name} ì¶”ì²œí•´ìš”.`, `ê¸°ë³¸ê¸°ê°€ íƒ„íƒ„í•œ ì¤‘ì‹ë‹¹, ${name}ì…ë‹ˆë‹¤.`],
                "ì–‘ì‹": [`ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ë¶„ìœ„ê¸°ì™€ ì™„ë²½í•œ í”Œë ˆì´íŒ…, ${name} ìµœê³ !`, `ë°ì´íŠ¸ ì½”ìŠ¤ë¡œ ë”± ì¢‹ì€ ${name}, ì™€ì¸ê³¼ ì°°ë–¡ê¶í•©ì…ë‹ˆë‹¤.`, `íŒŒìŠ¤íƒ€ ì†ŒìŠ¤ê°€ ì •ë§ ê¾¸ë•í•˜ê³  ë§›ìˆëŠ” ${name}!`],
                "default": [`${name}, ê¸°ëŒ€ ì´ìƒìœ¼ë¡œ ë„ˆë¬´ í›Œë¥­í•œ ë¯¸ì‹ ê²½í—˜ì´ì—ˆìŠµë‹ˆë‹¤.`, `ë¶„ìœ„ê¸°, ë§›, ì„œë¹„ìŠ¤ ëª¨ë‘ ë§Œì¡±ìŠ¤ëŸ¬ìš´ ${name}!`, `ìˆ¨ê²¨ì§„ ë³´ì„ ê°™ì€ ${name}, ë‚˜ë§Œ ì•Œê³  ì‹¶ì€ ë§›ì§‘ì´ë„¤ìš”.`]
            };
            let selectedCategory = "default";
            if (cat.includes("ê³ ê¸°") || cat.includes("ë¼ì§€") || cat.includes("ì†Œ") || cat.includes("êµ¬ì´")) selectedCategory = "ê³ ê¸°";
            else if (cat.includes("ì¹´í˜") || cat.includes("ì»¤í”¼") || cat.includes("ë””ì €íŠ¸")) selectedCategory = "ì¹´í˜";
            else if (cat.includes("ì¼ì‹") || cat.includes("ì´ˆë°¥") || cat.includes("ìŠ¤ì‹œ")) selectedCategory = "ì¼ì‹";
            else if (cat.includes("ì¤‘ì‹") || cat.includes("ë§ˆë¼") || cat.includes("ì§œì¥")) selectedCategory = "ì¤‘ì‹";
            else if (cat.includes("ì–‘ì‹") || cat.includes("íŒŒìŠ¤íƒ€") || cat.includes("í”¼ì")) selectedCategory = "ì–‘ì‹";

            const list = comments[selectedCategory];
            document.getElementById('post-comment').value = list[Math.floor(Math.random() * list.length)];
        }

        async function submitComment(restaurant_id) {
            const user = localStorage.getItem('currentUser');
            const input = document.getElementById(`comment-input-${restaurant_id}`);
            const text = input.value.trim();
            if (!text) return;
            try {
                const res = await fetch(`${API_URL}/restaurants/${restaurant_id}/comment`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'user-id': user }, body: JSON.stringify({ text: text }) });
                if (res.ok) {
                    const data = await res.json();
                    input.value = '';
                    renderComments(restaurant_id, data.comments);
                }
            } catch(e) {}
        }

        function renderComments(restaurant_id, comments) {
            const listEl = document.getElementById(`comment-list-${restaurant_id}`);
            if (!listEl) return;
            if (!comments || comments.length === 0) {
                listEl.innerHTML = `<div style="color:var(--text-sub); font-size:12px; text-align:center; padding: 20px 0; font-weight:500;">ì²« ë°©ëª…ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”.</div>`;
                return;
            }
            let html = '';
            comments.forEach(c => html += `<div class="comment-item" style="margin-bottom: 12px; font-size: 14px; line-height: 1.5;"><b style="color:var(--brand-primary); font-weight:800; margin-right: 6px;">${c.user}</b> <span style="color:var(--text-main); font-weight:500;">${c.text}</span></div>`);
            listEl.innerHTML = html;
            listEl.scrollTop = listEl.scrollHeight;
        }

        // =========================================================
        // [14] ì•± ë¼ì´í”„ì‚¬ì´í´ ê´€ë¦¬ (ğŸš¨ ê°€ì§œ ë¡œê·¸ì¸ ë²„ê·¸ ì™„ë²½ ìˆ˜ì •)
        // =========================================================
        function initApp() { 
            const user = localStorage.getItem('currentUser'); 
            
            // ğŸš¨ "null" ì´ë‚˜ "undefined" í…ìŠ¤íŠ¸ê°€ ì €ì¥ë˜ì–´ ìˆì„ ë•Œ í†µê³¼ë˜ëŠ” ë²„ê·¸ ë°©ì–´
            if (user && user !== "null" && user !== "undefined" && user.trim() !== "") { 
                document.getElementById('login-section').style.display = 'none'; 
                document.getElementById('main-content').style.display = 'block'; 
                switchTab('home'); 
                fetchNotifications(); 
            } else {
                localStorage.removeItem('currentUser'); // ì°Œêº¼ê¸° ì™„ë²½ ì‚­ì œ
                document.getElementById('login-section').style.display = 'flex';
                document.getElementById('main-content').style.display = 'none';
            }
        }

        function openEditProfileModal() {
            document.getElementById('edit-nickname-input').value = document.getElementById('display-profile-name').innerText;
            document.getElementById('edit-philosophy-input').value = currentProfilePhilosophy;
            document.getElementById('edit-dna-input').value = currentProfileTags.join(', ');
            document.getElementById('edit-personal-info').value = currentProfilePersonalInfo;
            document.getElementById('edit-profile-modal').style.display = 'flex';
        }

        function closeEditProfileModal() { document.getElementById('edit-profile-modal').style.display = 'none'; }

        function submitProfileEdit() {
            const newName = document.getElementById('edit-nickname-input').value.trim();
            if (!newName) { alert("ë³€ê²½í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            
            const rawTags = document.getElementById('edit-dna-input').value.split(',');
            const tagsArray = rawTags.map(t => t.trim()).filter(t => t !== "");
            
            document.getElementById('display-profile-name').innerText = newName;
            
            fetch(`${API_URL}/user/update-profile`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'user-id': localStorage.getItem('currentUser') },
                body: JSON.stringify({ 
                    nickname: newName, 
                    personal_info: document.getElementById('edit-personal-info').value,
                    philosophy: document.getElementById('edit-philosophy-input').value.trim(),
                    taste_tags: tagsArray
                })
            }).then(res => {
                if(res.ok) {
                    alert("í”„ë¡œí•„ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨");
                    closeEditProfileModal();
                    fetchGuideView(localStorage.getItem('currentUser')); 
                } else alert("í”„ë¡œí•„ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }).catch(e => console.error("í”„ë¡œí•„ ìˆ˜ì • ì—ëŸ¬", e));
        }

        // =========================================================
        // [15] ìµœì í™”ëœ ì˜¨ë¡œë“œ ì´ˆê¸°í™”
        // =========================================================
        window.onload = function() { 
            if (typeof kakao !== 'undefined' && kakao.maps) {
                kakao.maps.load(function() { console.log("Kakao Map Engine Ready"); }); 
            }
            
            const splash = document.getElementById('splash-screen');
            setTimeout(function() {
                fetchUserProfiles(); 
                if (splash) { 
                    splash.style.transform = 'scale(1.05)';
                    splash.style.opacity = '0'; 
                    setTimeout(() => { 
                        splash.style.display = 'none'; 
                        initApp(); 
                    }, 600); 
                } else { 
                    initApp(); 
                }
            }, 1800); 
        };
    </script>
</body>
</html>
