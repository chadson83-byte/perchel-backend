<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Perchel - The Gastronomy Journal</title>
    
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=1bf29ed9131417186b665259385414f8&libraries=services&autoload=false"></script>
    
    <style>
        /* =========================================================
           [1] ê¸€ë¡œë²Œ í…Œë§ˆ ë° ì»¬ëŸ¬ íŒ”ë ˆíŠ¸
           ========================================================= */
        :root {
            --bg-main: #F4F3F0; 
            --bg-card: #FFFFFF; 
            --brand-primary: #1C1E21; 
            --brand-fab: #DDA77B; 
            
            --text-main: #1A1A1A; 
            --text-sub: #7A7C80; 
            --border-color: #E2E0D9;
            
            --tag-pink-bg: #F8EBE6; 
            --tag-pink-txt: #A86A51; 
            
            --tag-green-bg: #EAF0EA; 
            --tag-green-txt: #4A634E;
            
            --tag-orange-bg: #F5EAE0; 
            --tag-orange-txt: #A67046; 
            
            --tag-blue-bg: #E6EBED; 
            --tag-blue-txt: #4D5A68;
            
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.04); 
            --shadow-fab: 0 8px 24px rgba(221, 167, 123, 0.35);
            
            --radius-xl: 20px; 
            --radius-lg: 16px; 
            --radius-md: 10px;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
        }

        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-main); 
            line-height: 1.6; 
            overflow-x: hidden; 
            -webkit-font-smoothing: antialiased; 
        }

        /* ğŸŒŸ Së§ˆí¬ ë°°ì§€ ë””ìì¸ (ì‚¬ì§„ ë°–ìœ¼ë¡œ ëŒì¶œë˜ë„ë¡ í¬ì§€ì…”ë‹) */
        .s-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #FFD700, #FDB931);
            color: #111;
            font-size: 10px;
            font-weight: 900;
            padding: 2px 6px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            border: 1px solid #FFF;
            z-index: 10;
            letter-spacing: -0.5px;
        }
        .s-badge.regional {
            background: linear-gradient(135deg, #A86A51, #DDA77B);
            color: #FFF;
        }

        /* =========================================================
           [2] ìŠ¤í”Œë˜ì‹œ ì¸íŠ¸ë¡œ ìŠ¤í¬ë¦°
           ========================================================= */
        #splash-screen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: #111315; 
            z-index: 9999; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            transition: opacity 0.8s ease-in-out, background 0.8s ease; 
        }

        .splash-content { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }

        .cloche-svg { 
            animation: liftCloche 1.5s 1.2s cubic-bezier(0.25, 1, 0.5, 1) forwards; 
            margin-bottom: 20px; 
        }

        .cloche-path { 
            stroke-dasharray: 300; 
            stroke-dashoffset: 300; 
            animation: drawCloche 1.2s forwards ease-out; 
        }

        .splash-logo { 
            font-size: 38px; 
            font-weight: 900; 
            color: #DDA77B; 
            font-style: italic; 
            letter-spacing: -1.5px; 
            opacity: 0; 
            transform: translateY(10px); 
            animation: fadeUpLogo 0.8s 0.6s forwards ease-out; 
        }

        .splash-sub { 
            font-size: 11px; 
            color: #DDA77B; 
            opacity: 0; 
            letter-spacing: 3px; 
            margin-top: 5px; 
            text-transform: uppercase; 
            animation: fadeUpLogo 0.8s 0.8s forwards ease-out; 
        }

        @keyframes drawCloche { 
            to { stroke-dashoffset: 0; } 
        }

        @keyframes fadeUpLogo { 
            to { opacity: 1; transform: translateY(0); } 
        }

        @keyframes liftCloche { 
            0% { transform: translateY(0); opacity: 1; } 
            50% { transform: translateY(-50px); opacity: 0; filter: blur(5px); } 
            100% { transform: translateY(-50px); opacity: 0; display: none; } 
        }

        /* =========================================================
           [3] ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë° í—¤ë” ë°”
           ========================================================= */
        .top-bar { 
            width: 100%; 
            background: rgba(244, 243, 240, 0.85); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            display: flex; 
            justify-content: center; 
            position: fixed; 
            top: 0; 
            left: 0; 
            z-index: 1000; 
            border-bottom: 1px solid rgba(0,0,0,0.03); 
            pointer-events: none; 
        }

        .top-bar-content { 
            width: 100%; 
            max-width: 600px; 
            height: 60px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 20px; 
            pointer-events: auto; 
        }

        .top-logo { 
            font-size: 24px; 
            font-weight: 800; 
            color: var(--text-main); 
            cursor: pointer; 
            letter-spacing: -1.5px; 
            text-transform: lowercase; 
            font-style: italic; 
        }

        #global-region-select {
            background: transparent; 
            border: none; 
            font-family: 'Pretendard', sans-serif; 
            font-weight: 700; 
            font-size: 13px; 
            color: var(--text-main); 
            outline: none; 
            cursor: pointer;
        }

        .lang-toggle { 
            background: transparent; 
            padding: 4px 8px; 
            border-radius: 8px; 
            font-size: 11px; 
            font-weight: 600; 
            color: var(--text-sub); 
            cursor: pointer; 
            border: 1px solid var(--border-color); 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            transition: 0.2s;
        }

        .lang-toggle:hover {
            background: var(--border-color);
            color: var(--text-main);
        }

        .mentor-btn { 
            background: var(--brand-primary); 
            color: var(--brand-fab); 
            padding: 8px 14px; 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: 800; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            cursor: pointer; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            transition: 0.2s; 
            letter-spacing: 0.5px; 
            border: 1px solid rgba(221, 167, 123, 0.3); 
        }

        .mentor-btn:active { 
            transform: scale(0.95); 
        }

        /* =========================================================
           [4] í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë° ì¤‘ì•™ í”Œë¡œíŒ… ë²„íŠ¼
           ========================================================= */
        .bottom-nav { 
            display: flex; 
            position: fixed; 
            bottom: 0; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 100%; 
            max-width: 600px; 
            height: 75px; 
            background: #fff; 
            border-top: 1px solid var(--border-color); 
            z-index: 1000; 
            padding: 0 10px env(safe-area-inset-bottom); 
        }

        .nav-item { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: #B0B3B8; 
            cursor: pointer; 
            transition: 0.2s; 
            font-size: 10px; 
            font-weight: 600; 
            margin-top: 2px; 
        }

        .nav-item.active { 
            color: var(--brand-primary); 
        }

        .nav-icon { 
            width: 22px; 
            height: 22px; 
            margin-bottom: 4px; 
            opacity: 0.8; 
            transition: 0.2s;
        }

        .nav-item.active .nav-icon { 
            opacity: 1; 
            stroke-width: 2.5; 
        }

        .nav-fab-wrapper { 
            position: relative; 
            width: 60px; 
            display: flex; 
            justify-content: center; 
        }

        .nav-fab { 
            position: absolute; 
            top: -20px; 
            width: 56px; 
            height: 56px; 
            background: var(--brand-primary); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            cursor: pointer; 
            transition: 0.2s; 
            z-index: 1001; 
        }

        .nav-fab svg { 
            width: 24px; 
            height: 24px; 
            stroke: white; 
            stroke-width: 2; 
            fill: none; 
            stroke-linecap: round; 
            stroke-linejoin: round; 
        }

        .nav-fab:active { 
            transform: scale(0.95); 
        }

        /* =========================================================
           [5] ë©”ì¸ ë ˆì´ì•„ì›ƒ ë° ë²”ìš© ì¹´ë“œ UI
           ========================================================= */
        #main-content { 
            display: none; 
            width: 100%; 
            max-width: 500px; 
            margin: 60px auto 100px; 
            padding: 20px 20px; 
            animation: fadeUp 0.4s ease-out; 
        }

        @keyframes fadeUp { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .section-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin: 35px 0 16px; 
        }

        .section-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: var(--text-main); 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            margin: 30px 0 16px; 
        }

        .editor-row { 
            display: flex; 
            gap: 14px; 
            overflow-x: auto; 
            padding-bottom: 10px; 
            scrollbar-width: none;
            scroll-snap-type: x mandatory; 
        }

        .editor-row::-webkit-scrollbar { 
            display: none; 
        }

        .editor-card { 
            background: var(--bg-card); 
            padding: 20px 16px; 
            border-radius: var(--radius-lg); 
            min-width: 120px; 
            flex-shrink: 0;
            text-align: center; 
            cursor: pointer; 
            box-shadow: var(--shadow-soft); 
            border: 1px solid var(--border-color); 
            scroll-snap-align: start;
        }

        .editor-img-container { 
            width: 60px; 
            height: 60px; 
            margin: 0 auto 12px; 
            position: relative; 
        }

        .avatar-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            background: #eee;
            border: 1px solid var(--border-color);
        }

        .card-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 16px; 
        }

        .rest-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-lg); 
            overflow: hidden; 
            padding: 12px; 
            box-shadow: var(--shadow-soft); 
            border: 1px solid var(--border-color); 
            cursor: pointer; 
            transition: 0.2s; 
            position: relative; 
            display: flex;
            flex-direction: column;
        }

        .rest-card:active { 
            transform: scale(0.98); 
        }

        .rest-img-wrapper { 
            position: relative; 
            border-radius: var(--radius-md); 
            overflow: hidden; 
            aspect-ratio: 4/3; 
            margin-bottom: 12px; 
            background: #eee; 
        }

        .rest-img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }

        .rest-badge { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(4px); 
            padding: 4px 8px; 
            border-radius: 6px; 
            font-size: 10px; 
            font-weight: 600; 
            color: white; 
            letter-spacing: 0.5px; 
        }

        .rest-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            justify-content: center;
        }

        .rest-name { 
            font-weight: 700; 
            font-size: 14px; 
            margin-bottom: 4px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            color: var(--text-main); 
            display: block;
        }

        .tag-pill { 
            padding: 4px 10px; 
            border-radius: 6px; 
            font-size: 11px; 
            font-weight: 600; 
            display: inline-block; 
            letter-spacing: 0.5px; 
        }

        .tag-pink { background: var(--tag-pink-bg); color: var(--tag-pink-txt); }
        .tag-green { background: var(--tag-green-bg); color: var(--tag-green-txt); }
        .tag-orange { background: var(--tag-orange-bg); color: var(--tag-orange-txt); }
        .tag-blue { background: var(--tag-blue-bg); color: var(--tag-blue-txt); }

        .user-result-item { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            padding: 16px; 
            border-radius: var(--radius-lg); 
            margin-bottom: 12px; 
            background: var(--bg-card); 
            cursor: pointer; 
            box-shadow: var(--shadow-soft); 
            border: 1px solid var(--border-color); 
            transition: 0.2s; 
            position: relative; 
            z-index: 10; 
        }

        .feed-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-xl); 
            padding: 24px; 
            box-shadow: var(--shadow-soft); 
            border: 1px solid var(--border-color); 
            margin-bottom: 30px; 
            position: relative; 
            cursor: pointer; 
            transition: 0.2s; 
        }
        
        .feed-card:active {
            transform: scale(0.99);
        }

        .feed-main-img { 
            width: 100%; 
            height: 260px; 
            border-radius: var(--radius-lg); 
            object-fit: cover; 
            margin-bottom: 20px; 
            background: #eee; 
        }

        .feed-rest-name { 
            font-size: 22px; 
            font-weight: 800; 
            line-height: 1.2; 
            color: var(--text-main); 
            letter-spacing: -0.5px; 
            margin-bottom: 12px; 
        }

        /* =========================================================
           [6] í•˜ì´ì—”ë“œ í”„ë¡œí•„ & W50B ëª…í•¨í˜• ì„œì—´í‘œ ë””ìì¸ 
           ========================================================= */
        .profile-dash { 
            background: var(--brand-primary); 
            border-radius: var(--radius-xl); 
            padding: 35px 25px; 
            color: white; 
            margin-bottom: 20px; 
            text-align: center; 
            box-shadow: 0 15px 30px rgba(28, 30, 33, 0.2); 
            position: relative;
        }

        .dash-pic-container { 
            width: 80px; 
            height: 80px; 
            border-radius: 50%; 
            margin: 0 auto 16px; 
            border: 2px solid white; 
            overflow: visible !important; 
            cursor: pointer; 
            background: transparent;
            position: relative;
        }

        .profile-philosophy {
            font-size: 13px;
            font-style: italic;
            color: #DDA77B;
            margin: 12px 0 16px;
            line-height: 1.5;
            padding: 0 20px;
            font-weight: 500;
        }

        .profile-dna-tags {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
            margin-bottom: 16px;
        }
        .dna-tag {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .profile-badges {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        .badge-item {
            background: linear-gradient(135deg, #FFD700, #FDB931);
            color: #111;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 900;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .dash-stats { 
            display: flex; 
            justify-content: space-around; 
            background: rgba(255,255,255,0.05); 
            padding: 20px; 
            border-radius: var(--radius-lg); 
            border: 1px solid rgba(255,255,255,0.1); 
            margin-top: 16px;
        }

        .initial-avatar { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: var(--brand-fab); 
            color: white; 
            font-weight: 800; 
            font-size: 2em; 
            text-transform: uppercase; 
        }

        .guide-sheet { padding-bottom: 20px; }
        .tier-section { margin-bottom: 30px; }
        .tier-header-title { font-size: 20px; font-weight: 900; color: var(--text-main); margin: 30px 0 15px; text-transform: uppercase; letter-spacing: -0.5px; border-bottom: 2px solid var(--brand-primary); padding-bottom: 8px; display: flex; justify-content: space-between; align-items: flex-end; }
        .guide-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }

        .guide-card { position: relative; width: 100%; aspect-ratio: 1; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-soft); cursor: pointer; background: #111; border: 1px solid rgba(0,0,0,0.05); }
        .guide-card-bg { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; opacity: 0.85; }
        .guide-card:hover .guide-card-bg { transform: scale(1.05); opacity: 1; }
        .guide-card-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.5) 70%, transparent 100%); padding: 30px 12px 12px; text-align: center; color: white; pointer-events: none; }

        .guide-tier-text { font-size: 11px; font-weight: 900; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1.5px; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        .guide-name-text { font-size: 15px; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 2px 4px rgba(0,0,0,0.5); letter-spacing: -0.5px; }
        .guide-sub-text { font-size: 10px; color: #ccc; margin-top: 4px; font-weight: 500; }
        
        .guide-tabs { display: flex; background: var(--border-color); border-radius: 12px; padding: 4px; margin-bottom: 12px; }
        .guide-tab-btn { flex: 1; text-align: center; padding: 10px; border-radius: 8px; font-weight: 700; font-size: 13px; cursor: pointer; transition: 0.2s; color: var(--text-sub); }
        .guide-tab-btn.active { background: var(--bg-card); color: var(--text-main); box-shadow: var(--shadow-soft); }

        /* =========================================================
           [7] ì†Œì…œ ê¸°ëŠ¥ ë° ëŒ“ê¸€ ì‹œìŠ¤í…œ
           ========================================================= */
        .bookmark-btn-mini { position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 5; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: 1px solid var(--border-color); transition: 0.2s; }
        .bookmark-btn-mini:active { transform: scale(0.9); }
        .social-bar { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border-color); margin-top: 12px; }
        .action-btn { display: flex; align-items: center; gap: 6px; color: var(--text-sub); font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .action-btn:hover { color: var(--text-main); }
        .action-btn.liked svg { fill: #FF4757; stroke: #FF4757; }
        
        .comment-area { background: var(--bg-main); border-radius: 12px; padding: 16px; margin-bottom: 30px; border: 1px solid var(--border-color); }
        .comment-list { max-height: 150px; overflow-y: auto; margin-bottom: 12px; }
        .comment-item { font-size: 13px; margin-bottom: 8px; color: var(--text-main); line-height: 1.4; }
        .comment-input-row { display: flex; gap: 8px; }
        .comment-input { flex: 1; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 12px; background: white; outline: none; }
        .comment-btn { padding: 8px 14px; background: var(--text-main); color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 12px; cursor: pointer; }

        /* =========================================================
           [8] íŒì—… ëª¨ë‹¬ì°½ ë° íŠ¹ìˆ˜ UI
           ========================================================= */
        .bottom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 2000; align-items: flex-end; justify-content: center; }
        .modal-body { background: var(--bg-main); width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; display: flex; flex-direction: column; height: 88vh; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .input-field { position: relative; z-index: 10; width: 100%; padding: 16px 20px; margin-bottom: 16px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-main); font-size: 14px; font-family: inherit; transition: 0.2s; outline: none; }
        .input-field:focus { background: white; border-color: var(--brand-primary); }
        .btn-primary { width: 100%; padding: 16px; border-radius: 8px; border: none; background: var(--brand-primary); color: white; font-weight: 700; font-size: 15px; letter-spacing: 0.5px; cursor: pointer; transition: 0.2s; }
        
        #login-section { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: var(--bg-main); padding: 20px; }
        .svg-icon { width: 24px; height: 24px; stroke: currentColor; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; fill: none; }
        .nav-item.active .svg-icon { stroke-width: 2.5; }
        
        .ai-image-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px; }
        .ai-image-item { width: 100%; aspect-ratio: 1; border-radius: 12px; object-fit: cover; cursor: pointer; border: 2px solid transparent; transition: 0.2s; box-shadow: var(--shadow-soft); }
        .ai-image-item:hover { border-color: var(--brand-fab); transform: scale(0.98); }

        ::-webkit-scrollbar { display: none; }
        
        #map-view { padding: 0; margin: 60px 0 0 0; max-width: 100%; height: calc(100vh - 60px - 75px); position: relative; }
        #global-map { width: 100%; height: 100%; min-height: 400px; }

        .my-location-btn { position: absolute; bottom: 20px; right: 20px; width: 44px; height: 44px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10; cursor: pointer; border: 1px solid var(--border-color); }
        .my-location-btn:active { transform: scale(0.95); }

        .server-error-banner { width: 100%; padding: 20px; text-align: center; color: #FF4757; background: rgba(255, 71, 87, 0.1); border: 1px dashed #FF4757; border-radius: 12px; font-weight: 700; font-size: 13px; margin-top: 20px; line-height: 1.5; }

        /* =========================================================
           [9] ğŸŒŸ NEW: ì•Œë¦¼ ë°°ì§€ & ë‹¤ì¤‘ ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” CSS
           ========================================================= */
        .noti-badge { position:absolute; top:-2px; right:-2px; background:#FF4757; width:10px; height:10px; border-radius:50%; border:2px solid var(--bg-main); display:none; z-index: 10; }
        .noti-item { padding:16px; border-bottom:1px solid var(--border-color); display:flex; gap:12px; align-items:center; }
        .noti-item.unread { background: rgba(221, 167, 123, 0.1); }
        .noti-icon { width:40px; height:40px; border-radius:50%; background:var(--brand-primary); color:var(--brand-fab); display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0;}

        .multi-image-slider { width:100%; display:flex; overflow-x:auto; scroll-snap-type: x mandatory; gap:8px; padding-bottom:8px; scrollbar-width:none; margin-bottom:16px; }
        .multi-image-slider::-webkit-scrollbar { display:none; }
        .multi-image-slide { flex: 0 0 100%; height:260px; scroll-snap-align:center; border-radius:var(--radius-lg); object-fit:cover; background:#eee; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-content">
            <svg class="cloche-svg" viewBox="0 0 100 100" width="100" height="100">
                <path class="cloche-path" d="M10 70 Q50 5 90 70 L95 70 Q97 70 97 73 Q97 76 95 76 L5 76 Q3 76 3 73 Q3 70 5 70 Z M45 10 L55 10 A5 5 0 0 0 45 10 Z" fill="none" stroke="#DDA77B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="splash-logo">perchel</div>
            <div class="splash-sub">The Gastronomy Journal</div>
        </div>
    </div>

    <div id="login-section" style="display: none;">
        <div style="width: 70px; height: 70px; background: var(--brand-primary); border-radius: 16px; display: flex; justify-content: center; align-items: center; color: white; font-size: 32px; font-weight: 800; font-style: italic; margin-bottom: 40px; box-shadow: var(--shadow-soft);">p.</div>
        <h1 data-ko="í¼ìŠ ì…ì¥" data-en="Enter Perchel" style="color: var(--text-main); font-size: 28px; font-weight: 800; margin-bottom: 40px; letter-spacing: -0.5px;">í¼ìŠ ì…ì¥</h1>
        <div style="width: 100%; max-width: 320px;">
            <input type="text" id="login-user" class="input-field" data-ph-ko="ì•„ì´ë””" data-ph-en="Username" placeholder="ì•„ì´ë””">
            <input type="password" id="login-pass" class="input-field" data-ph-ko="ë¹„ë°€ë²ˆí˜¸" data-ph-en="Password" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <input type="text" id="login-info" class="input-field" data-ph-ko="ê°„ë‹¨í•œ ìê¸°ì†Œê°œ" data-ph-en="Bio" placeholder="ê°„ë‹¨í•œ ìê¸°ì†Œê°œ" style="display: none; margin-top: 8px;">
            <button class="btn-primary" style="margin-top: 10px;" onclick="handleLogin()" data-ko="ì‹œì‘í•˜ê¸°" data-en="Continue">ì‹œì‘í•˜ê¸°</button>
            <p onclick="handleSignup()" data-ko="ê³„ì • ìƒì„±í•˜ê¸°" data-en="Create account" style="margin-top: 30px; color: var(--text-sub); text-align: center; cursor: pointer; font-weight: 600; font-size: 13px;">ê³„ì • ìƒì„±í•˜ê¸°</p>
        </div>
    </div>

    <div id="main-content" style="margin-top:0; padding-top:60px;">
        
        <header class="top-bar">
            <div class="top-bar-content">
                <div class="top-logo" onclick="switchTab('home')">perchel</div>
                <div style="display:flex; align-items:center; gap: 12px;">
                    
                    <select id="global-region-select" onchange="changeGlobalRegion()">
                        <option value="national" data-ko="ì „êµ­ ì‹ë‹¹" data-en="National">ì „êµ­ ì‹ë‹¹</option>
                        <option value="ì„œìš¸">ì„œìš¸</option>
                        <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                        <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
                        <option value="ì¸ì²œ">ì¸ì²œ</option>
                        <option value="ê´‘ì£¼">ê´‘ì£¼</option>
                        <option value="ëŒ€ì „">ëŒ€ì „</option>
                        <option value="ìš¸ì‚°">ìš¸ì‚°</option>
                        <option value="ì„¸ì¢…">ì„¸ì¢…</option>
                        <option value="ê²½ê¸°">ê²½ê¸°</option>
                        <option value="ê°•ì›">ê°•ì›</option>
                        <option value="ì¶©ë¶">ì¶©ë¶</option>
                        <option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
                        <option value="ì „ë¶">ì „ë¶</option>
                        <option value="ì „ë‚¨">ì „ë‚¨</option>
                        <option value="ê²½ë¶">ê²½ë¶</option>
                        <option value="ê²½ë‚¨">ê²½ë‚¨</option>
                        <option value="ì œì£¼">ì œì£¼</option>
                    </select>

                    <div class="mentor-btn" onclick="switchTab('network')" title="ë‚˜ì˜ ë¯¸ì‹ë©˜í† ">
                        ğŸ‘‘ <span data-ko="ë‚˜ì˜ ë¯¸ì‹ë©˜í† " data-en="Mentors">ë‚˜ì˜ ë¯¸ì‹ë©˜í† </span>
                    </div>

                    <div onclick="openGlobalSearchModal()" style="cursor:pointer; display:flex; align-items:center; justify-content:center;" title="ë©”ë‰´/ì‹ë‹¹ ê²€ìƒ‰">
                        <svg class="svg-icon" viewBox="0 0 24 24" style="width:20px; height:20px; stroke:var(--text-main);">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>

                    <div style="position:relative; cursor:pointer; display:flex; align-items:center; justify-content:center;" onclick="openNotificationModal()" title="ë‚´ ì†Œì‹">
                        <svg class="svg-icon" viewBox="0 0 24 24" style="width:20px; height:20px; stroke:var(--text-main);">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <div id="noti-badge" class="noti-badge"></div>
                    </div>

                    <div id="lang-toggle" class="lang-toggle" onclick="toggleLanguage()">EN</div>

                    <div onclick="handleLogout()" style="cursor:pointer; display:flex; align-items:center; justify-content:center;" title="ë¡œê·¸ì•„ì›ƒ">
                        <svg class="svg-icon" viewBox="0 0 24 24" style="width:22px; height:22px; stroke:var(--text-sub);">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </div>
                </div>
            </div>
        </header>

        <div id="home-view" class="tab-view">
            <div class="section-header">
                <div class="section-title" id="home-editor-title" data-ko="ì¸ê¸° ë¯¸ì‹ê°€" data-en="Featured Gourmets">ì¸ê¸° ë¯¸ì‹ê°€</div>
            </div>
            <div class="editor-row" id="editor-list-container"></div>
            
            <div class="section-title" style="margin-top:30px;" data-ko="ì¸ê¸° ë§›ì§‘ ë¦¬ìŠ¤íŠ¸" data-en="Popular Places">ì¸ê¸° ë§›ì§‘ ë¦¬ìŠ¤íŠ¸</div>
            <div class="card-grid" id="popular-list-container"></div>
            
            <div class="section-title" style="margin-top:30px;" data-ko="ìµœê·¼ ë“±ë¡ëœ ì‹ë‹¹" data-en="Recently Added">ìµœê·¼ ë“±ë¡ëœ ì‹ë‹¹</div>
            <div class="card-grid" id="new-list-container"></div>
        </div>

        <div id="network-view" class="tab-view" style="display:none;">
            <div style="padding: 10px 0;">
                <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 5px;" data-ko="ë‚˜ì˜ ë¯¸ì‹ë©˜í† " data-en="My Mentors">ë‚˜ì˜ ë¯¸ì‹ë©˜í† </h2>
                <div style="font-size:13px; color:var(--text-sub); margin-bottom:30px;" data-ko="ìµœê³ ì˜ ë¯¸ì‹ê°€ë“¤ì„ íŒ”ë¡œìš°í•˜ê³  ì„œì—´í‘œë¥¼ í™•ì¸í•˜ì„¸ìš”." data-en="Follow top gourmets and check their tier lists.">ìµœê³ ì˜ ë¯¸ì‹ê°€ë“¤ì„ íŒ”ë¡œìš°í•˜ê³  ì„œì—´í‘œë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>
                
                <div class="section-title" data-ko="íŒ”ë¡œì‰" data-en="Following">íŒ”ë¡œì‰</div>
                <div id="following-list-container"></div>
                
                <div class="section-title" style="margin-top:30px;" data-ko="ì¶”ì²œ ë¯¸ì‹ê°€" data-en="Recommended Gourmets">ì¶”ì²œ ë¯¸ì‹ê°€</div>
                <div id="recommended-list-container"></div>
            </div>
        </div>

        <div id="explore-view" class="tab-view" style="display:none;">
            <div class="guide-tabs" style="margin-top:10px; margin-bottom:20px;">
                <div id="tab-explore-ranking" class="guide-tab-btn active" onclick="switchExploreTab('ranking')" data-ko="ë¯¸ì‹ ë­í‚¹" data-en="Ranking">ë¯¸ì‹ ë­í‚¹</div>
                <div id="tab-explore-feed" class="guide-tab-btn" onclick="switchExploreTab('feed')" data-ko="ì‹¤ì‹œê°„ ë¯¸ì‹ íŠ¸ë Œë“œ" data-en="Global Feed">ì‹¤ì‹œê°„ ë¯¸ì‹ íŠ¸ë Œë“œ</div>
            </div>

            <div id="explore-ranking-area">
                <input type="text" id="ranking-search-input" class="input-field" placeholder="ë©”ë‰´ë‚˜ ì‹ë‹¹ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš” ğŸ”" onkeyup="if(event.keyCode==13) fetchRankingData()">
                <div style="font-size:12px; color:var(--text-sub); margin-bottom:16px; text-align:center;">
                    ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•Šê³  ë‹ë³´ê¸°ë¥¼ ëˆ„ë¥´ë©´ 'ì „ì²´ ë­í‚¹'ì´ í‘œì‹œë©ë‹ˆë‹¤.
                </div>
                <button class="btn-primary" style="margin-bottom:20px; padding:12px;" onclick="fetchRankingData()">ê²€ìƒ‰ ë° ë­í‚¹ í™•ì¸</button>
                <div id="ranking-list-container"></div>
            </div>

            <div id="explore-feed-area" style="display:none;">
                <div id="feed-scroll-area"></div>
            </div>
        </div>
        
        <div id="map-view" class="tab-view" style="display:none;">
            <div id="global-map"></div>
            <div class="my-location-btn" onclick="moveToMyLocation()" title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">
                <svg class="svg-icon" viewBox="0 0 24 24" style="stroke:var(--brand-primary);">
                    <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
                </svg>
            </div>
        </div>

        <div id="profile-view" class="tab-view" style="display:none;">
            <div id="profile-header-target"></div>
            
            <div id="registration-trigger" style="background:transparent; border: 1px dashed var(--border-color); border-radius:var(--radius-lg); padding:20px; margin-bottom:20px; text-align:center; cursor: pointer;" onclick="openSearchModal()">
                <div style="font-size: 24px; color: var(--text-sub); margin-bottom: 8px;">+</div>
                <div data-ko="ìƒˆë¡œìš´ ë¯¸ì‹ ê²½í—˜ ê¸°ë¡í•˜ê¸°" data-en="Log new experience" style="font-size: 13px; font-weight: 600; color: var(--text-main);">ìƒˆë¡œìš´ ë¯¸ì‹ ê²½í—˜ ê¸°ë¡í•˜ê¸°</div>
            </div>
            
            <div id="guide-controls-target" class="guide-controls" style="display:none;">
                <div class="guide-tabs">
                    <div id="tab-national" class="guide-tab-btn active" onclick="switchGuideTab('national')" data-ko="ì „êµ­ ë§›ì§‘" data-en="National">ì „êµ­ ë§›ì§‘</div>
                    <div id="tab-local" class="guide-tab-btn" onclick="switchGuideTab('local')" data-ko="ì§€ì—­ ë§›ì§‘" data-en="Local">ì§€ì—­ ë§›ì§‘</div>
                </div>
                <input type="text" id="guide-search-input" class="input-field" data-ph-ko="ì„œì—´í‘œ ë‚´ ì‹ë‹¹ ê²€ìƒ‰..." data-ph-en="Search in guide..." placeholder="ì„œì—´í‘œ ë‚´ ì‹ë‹¹ ê²€ìƒ‰..." onkeyup="renderGuideSheet()">
            </div>
            
            <div id="michelin-tables-target"></div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item" id="m-home" onclick="switchTab('home')">
                <svg class="nav-icon svg-icon" viewBox="0 0 24 24">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2-2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span data-ko="í™ˆ" data-en="Home">í™ˆ</span>
            </div>
            <div class="nav-item" id="m-map" onclick="switchTab('map')">
                <svg class="nav-icon svg-icon" viewBox="0 0 24 24">
                    <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
                    <line x1="8" y1="2" x2="8" y2="18"></line>
                    <line x1="16" y1="6" x2="16" y2="22"></line>
                </svg>
                <span data-ko="ë‚´ì£¼ë³€" data-en="Map">ë‚´ì£¼ë³€</span>
            </div>
            
            <div class="nav-fab-wrapper">
                <div class="nav-fab" onclick="openSearchModal()">
                    <svg viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </div>
            </div>
            
            <div class="nav-item" id="m-explore" onclick="switchTab('explore')">
                <svg class="nav-icon svg-icon" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <span data-ko="íƒìƒ‰" data-en="Explore">íƒìƒ‰</span>
            </div>
            <div class="nav-item" id="m-profile" onclick="switchTab('profile')">
                <svg class="nav-icon svg-icon" viewBox="0 0 24 24">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <span data-ko="ë‚´ í”„ë¡œí•„" data-en="My Profile">ë‚´ í”„ë¡œí•„</span>
            </div>
        </nav>
    </div>
    <div id="region-editors-modal" class="bottom-modal">
        <div class="modal-body" style="height: 60vh;">
            <div style="padding:24px 24px 16px; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-weight:800; font-size:20px; color:var(--text-main);" id="region-editor-title">ì¶”ì²œ ë¯¸ì‹ê°€</h2>
                <div onclick="document.getElementById('region-editors-modal').style.display='none'" style="cursor:pointer;">
                    <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div style="padding:0 24px 24px; flex:1; overflow-y:auto;" id="region-editors-target"></div>
        </div>
    </div>

    <div id="search-modal" class="bottom-modal">
        <div class="modal-body" style="height: 85vh;">
            <div style="padding:24px 24px 16px; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-weight:800; font-size:20px; color:var(--text-main);" data-ko="ì¥ì†Œ ì°¾ê¸°" data-en="Search Place">ì¥ì†Œ ì°¾ê¸°</h2>
                <div onclick="closeSearchModal()" style="cursor:pointer;">
                    <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div style="padding:0 24px 24px; flex:1; overflow-y:auto; display:flex; flex-direction:column; position: relative;">
                <input type="text" id="search-keyword" class="input-field" style="border:1px solid var(--border-color);" data-ph-ko="ì‹ë‹¹ ì´ë¦„ ì…ë ¥ í›„ Enter" data-ph-en="Search name and Enter" placeholder="ì‹ë‹¹ ì´ë¦„ ì…ë ¥ í›„ Enter" onkeypress="if(event.keyCode==13) executeKakaoSearch()">
                <div id="search-results-target" style="flex:1; margin-top:10px;"></div>
            </div>
        </div>
    </div>

    <div id="global-search-modal" class="bottom-modal" style="z-index: 2100;">
        <div class="modal-body" style="height: 90vh;">
            <div style="padding:24px 24px 16px; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-weight:800; font-size:20px; color:var(--text-main);">ğŸ” ë©”ë‰´ & ë­í‚¹ ê²€ìƒ‰</h2>
                <div onclick="closeGlobalSearchModal()" style="cursor:pointer;">
                    <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div style="padding:0 24px 24px; flex:1; overflow-y:auto; display:flex; flex-direction:column;">
                <input type="text" id="global-ranking-input" class="input-field" style="border:2px solid var(--brand-primary);" placeholder="ì˜ˆ: íŒŒìŠ¤íƒ€, ë¼ì§€ê°ˆë¹„, ì˜¤ë§ˆì¹´ì„¸..." onkeyup="if(event.keyCode==13) executeGlobalSearch()">
                <button class="btn-primary" style="margin-bottom:20px; padding:12px;" onclick="executeGlobalSearch()">ê²€ìƒ‰í•˜ê¸°</button>
                <div id="global-search-results" style="flex:1;">
                    <div style="text-align:center; padding:40px 20px; color:var(--text-sub); font-size:13px;">
                        ì›í•˜ì‹œëŠ” ë©”ë‰´ë‚˜ ì‹ë‹¹ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì‹œë©´<br>ê°€ì¥ ë§ì´ ë“±ë¡ëœ ìˆœì„œëŒ€ë¡œ ë­í‚¹ì„ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification-modal" class="bottom-modal" style="z-index: 2200;">
        <div class="modal-body" style="height: 75vh;">
            <div style="padding:24px 24px 16px; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-weight:800; font-size:20px; color:var(--text-main);">ğŸ”” ë‚´ ì†Œì‹</h2>
                <div onclick="closeNotificationModal()" style="cursor:pointer;">
                    <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div style="padding:0; flex:1; overflow-y:auto;" id="notification-list-target">
                <div style="text-align:center; padding:40px 20px; color:var(--text-sub); font-size:13px;">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>
        </div>
    </div>

    <div id="post-detail-modal" class="bottom-modal">
        <div class="modal-body" style="padding: 30px 24px; background: var(--bg-card); overflow-y: auto;">
            <div style="font-weight: 800; font-size: 20px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                <span data-ko="ìƒˆë¡œìš´ ë“±ê¸°" data-en="New Entry">ìƒˆë¡œìš´ ë“±ê¸°</span>
                <div onclick="cancelPosting()" style="cursor:pointer;">
                    <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            
            <div class="preview-container">
                <div id="selected-rest-photo" style="width:100%; height:200px; background-size:cover; background-position:center; border-radius:12px; margin-bottom:12px; position:relative; overflow:hidden;"></div>
                <div id="map-preview-area" style="width:100%; height:150px; border-radius:12px; margin-bottom:12px;"></div>
            </div>
            
            <div id="selected-info-text" style="background:var(--bg-main); padding:16px; border-radius:8px; margin-bottom:20px;"></div>
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                <div style="font-size: 12px; font-weight: 700; color: var(--text-sub); text-transform:uppercase;" data-ko="ë¯¸ì‹í‰" data-en="Description">ë¯¸ì‹í‰</div>
                <button onclick="recommendAIComment()" style="background:transparent; border:1px solid var(--brand-fab); color:var(--brand-fab); border-radius:12px; padding:4px 10px; font-size:10px; font-weight:700; cursor:pointer; transition:0.2s;">
                    âœ¨ AI ë¬¸êµ¬ ì¶”ì²œ
                </button>
            </div>
            
            <input type="text" id="post-comment" class="input-field" data-ph-ko="ì´ ê³³ì—ì„œì˜ ê²½í—˜ì„ í•œ ì¤„ë¡œ ì ì–´ì£¼ì„¸ìš”." data-ph-en="Write your experience..." placeholder="ì´ ê³³ì—ì„œì˜ ê²½í—˜ì„ í•œ ì¤„ë¡œ ì ì–´ì£¼ì„¸ìš”.">
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                <div style="flex:1;">
                    <div style="font-size: 11px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px;" data-ko="ì‚¬ì§„ ì—…ë¡œë“œ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)" data-en="Upload Photos (Multiple)">ì‚¬ì§„ ì—…ë¡œë“œ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</div>
                    <input type="file" id="post-image" accept="image/*" multiple style="font-size:12px;" onchange="handleImagePreview(this)">
                </div>
                <button onclick="executeAddRestaurant()" class="btn-primary" style="width: auto; background:var(--brand-primary); padding: 12px 24px;" data-ko="ì €ì¥" data-en="Save">ì €ì¥</button>
            </div>
            
            <input type="hidden" id="h-name">
            <input type="hidden" id="h-cat">
            <input type="hidden" id="h-addr">
            <input type="hidden" id="h-id">
            <input type="hidden" id="h-x">
            <input type="hidden" id="h-y">
            <input type="hidden" id="h-phone">
        </div>
    </div>

    <div id="restaurant-detail-modal" class="bottom-modal">
        <div class="modal-body" style="height: 90vh; padding: 0; overflow-y:auto; background: var(--bg-card);">
            <div id="detail-view-card" style="padding: 30px 24px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 24px;">
                    <span class="tag-pill tag-blue" id="detail-tier" style="font-size:13px; padding:6px 14px;"></span>
                    <div style="display:flex; gap: 15px; align-items:center;">
                        
                        <div id="delete-rest-btn" onclick="executeDeleteRestaurant()" style="display:none; cursor:pointer; color:#FF4757;" title="ê¸°ë¡ ì‚­ì œ">
                            <svg class="svg-icon" viewBox="0 0 24 24" style="stroke:#FF4757; width:24px; height:24px;">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </div>
                        
                        <div onclick="closeRestDetail()" style="cursor:pointer;">
                            <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px; stroke:var(--text-sub);"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </div>
                    </div>
                </div>
                
                <div id="detail-img" class="detail-main-img" style="background-position:center; background-color:#eee; position:relative; overflow:hidden;">
                    <button id="ai-sync-btn" style="position:absolute; bottom:12px; right:12px; background:rgba(0,0,0,0.7); color:var(--brand-fab); border:1px solid var(--brand-fab); padding:8px 14px; border-radius:20px; font-size:11px; font-weight:700; cursor:pointer; backdrop-filter:blur(4px); display:none; transition:0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index:20;">
                        âœ¨ AI íë ˆì´ì…˜
                    </button>
                </div>

                <h2 id="detail-name" style="font-size:28px; font-weight:800; margin-bottom:12px; color:var(--text-main); letter-spacing:-0.5px;"></h2>
                
                <div style="display:flex; gap:8px; margin-bottom:24px; flex-wrap:wrap;">
                    <span class="tag-pill tag-orange" id="detail-category"></span>
                    <span class="tag-pill tag-green" id="detail-address"></span>
                    <span class="tag-pill tag-pink" id="detail-phone" style="display:none;"></span>
                </div>
                
                <div style="background:var(--bg-main); padding:24px; border-radius:16px; margin-bottom:30px;">
                    <div style="font-size:11px; color:var(--text-sub); font-weight:700; margin-bottom:10px; text-transform:uppercase; letter-spacing:1px;" data-ko="ë¯¸ì‹ê°€ ì½”ë©˜íŠ¸" data-en="Editor's Comment">ë¯¸ì‹ê°€ ì½”ë©˜íŠ¸</div>
                    <div id="detail-comment" style="font-size:16px; font-weight:400; color:var(--text-main); line-height: 1.6;"></div>
                    
                    <div style="display:flex; align-items:center; gap:8px; margin-top:16px;">
                        <div id="detail-owner" style="display:inline-block; padding:6px 12px; background:white; border-radius:8px; font-size:12px; font-weight:600; color:var(--text-sub); border:1px solid var(--border-color); cursor:pointer;"></div>
                        <button id="detail-follow-btn" style="display:none; padding:6px 14px; background:var(--brand-primary); color:var(--brand-fab); border-radius:8px; border:none; font-size:11px; font-weight:700; cursor:pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition:0.2s;"></button>
                    </div>
                </div>
                
                <div style="font-size: 12px; font-weight: 700; margin-bottom: 12px; color: var(--text-sub); text-transform:uppercase; letter-spacing:1px;" data-ko="ìœ„ì¹˜ ì •ë³´" data-en="Location Info">ìœ„ì¹˜ ì •ë³´</div>
                <div id="detail-map-area" style="width:100%; height:250px; border-radius:12px; margin-bottom:30px; border: 1px solid var(--border-color); background: #eee;"></div>
                
                <button id="detail-kakao-btn" class="btn-primary" style="background:var(--text-main); color:#fff; display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom: 50px;" data-ko="ìƒì„¸ ì •ë³´ ë° ë©”ë‰´ ë³´ê¸°" data-en="View Info & Menu">ìƒì„¸ ì •ë³´ ë° ë©”ë‰´ ë³´ê¸°</button>
            </div>
        </div>
    </div>

    <div id="edit-profile-modal" class="bottom-modal" style="z-index: 2500;">
        <div class="modal-body" style="height: auto; min-height: 50vh; padding: 30px 24px; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 24px;">
                <h2 style="font-weight:800; font-size:20px; color:var(--text-main);">í”„ë¡œí•„ ìˆ˜ì •</h2>
                <div onclick="closeEditProfileModal()" style="cursor:pointer;">
                    <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            
            <div style="font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px;">ìƒˆë¡œìš´ í”„ë¡œí•„ ì´ë¦„ (ë‹‰ë„¤ì„)</div>
            <input type="text" id="edit-nickname-input" class="input-field" placeholder="ë³€ê²½í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.">
            
            <div style="font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; margin-top: 10px;">ë‚˜ë§Œì˜ ë¯¸ì‹ ì² í•™ (Quote)</div>
            <input type="text" id="edit-philosophy-input" class="input-field" placeholder="ì˜ˆ: ìŒì‹ì€ í˜€ê°€ ì•„ë‹ˆë¼ ë¶„ìœ„ê¸°ë¡œ ë¨¹ëŠ” ê²ƒì´ë‹¤">

            <div style="font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; margin-top: 10px;">ë¯¸ì‹ DNA íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</div>
            <input type="text" id="edit-dna-input" class="input-field" placeholder="ì˜ˆ: íŒŒì¸ë‹¤ì´ë‹, ë…¸í¬ë§¤ë‹ˆì•„, ì™€ì¸ëŸ¬ë²„">

            <div style="font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; margin-top: 10px;">ê¸°íƒ€ ê°œì¸ì •ë³´</div>
            <textarea id="edit-personal-info" class="input-field" placeholder="ìê¸°ì†Œê°œë‚˜ ì¶”ê°€ ê°œì¸ì •ë³´ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆëŠ” ê³µê°„ì…ë‹ˆë‹¤." style="height: 60px; resize: none;"></textarea>
            
            <button onclick="submitProfileEdit()" class="btn-primary" style="margin-top: 10px;">ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="ai-image-modal" class="bottom-modal" style="z-index: 2500;">
        <div class="modal-body" style="height: auto; min-height: 50vh; padding: 30px 24px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                <h2 style="font-weight:800; font-size:20px; color:var(--text-main);">âœ¨ AI ì‚¬ì§„ íë ˆì´ì…˜</h2>
                <div onclick="document.getElementById('ai-image-modal').style.display='none'" style="cursor:pointer;">
                    <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div style="font-size:13px; color:var(--text-sub); margin-bottom:20px;">ì„œë²„ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì§‘í•œ ê³ í™”ì§ˆ ì´ë¯¸ì§€ ì¤‘<br>ëŒ€í‘œ ì‚¬ì§„ìœ¼ë¡œ ì‚¬ìš©í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
            <div id="ai-image-target" class="ai-image-grid"></div>
        </div>
    </div>
    <script>
        const API_URL = `http://127.0.0.1:8000`; 
        
        let followingList = [];
        let currentLang = 'ko'; 
        let globalRegion = 'national';
        let currentProfileGuideData = {};
        let currentProfileOwner = '';
        let currentProfileIsMe = false;
        let currentProfileLocalRegion = '';
        let activeGuideTab = 'national';
        let currentOpenRestId = null; 
        let userProfiles = {}; 
        
        let currentProfilePhilosophy = '';
        let currentProfileTags = [];
        let currentProfilePersonalInfo = '';
        
        let globalMap = null; 
        let previewMap = null; 
        let previewMarker = null;

        let nationalTop50 = [];
        let regionalTop10 = {};

        function getBadgeHtml(username) {
            if (nationalTop50.includes(username)) {
                return `<div class="s-badge">ì „êµ­S</div>`;
            }
            for (let reg in regionalTop10) {
                if (regionalTop10[reg] && regionalTop10[reg].includes(username)) {
                    return `<div class="s-badge regional">${reg}S</div>`;
                }
            }
            return '';
        }

        function getAvatar(username) {
            let badge = getBadgeHtml(username);
            let imgHtml = '';
            if (userProfiles[username]) {
                imgHtml = `<img src="${userProfiles[username]}" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                const initial = username ? username.charAt(0).toUpperCase() : '?';
                imgHtml = `<div class="initial-avatar">${initial}</div>`;
            }
            return `
                <div style="position:relative; width:100%; height:100%;">
                    <div class="avatar-circle">
                        ${imgHtml}
                    </div>
                    ${badge}
                </div>
            `;
        }

        async function fetchUserProfiles() {
            try {
                const res = await fetch(`${API_URL}/users/profiles`);
                if (res.ok) {
                    userProfiles = await res.json();
                }
            } catch (e) {}
        }

        function triggerProfileUpload() {
            if (!currentProfileIsMe) return;
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const fd = new FormData();
                fd.append('image', file);
                try {
                    const res = await fetch(`${API_URL}/user/profile-image`, {
                        method: 'POST',
                        headers: { 'user-id': localStorage.getItem('currentUser') },
                        body: fd
                    });
                    if (res.ok) {
                        alert("í”„ë¡œí•„ ì‚¬ì§„ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¸");
                        await fetchUserProfiles(); 
                        fetchGuideView(localStorage.getItem('currentUser')); 
                    } else { 
                        alert("ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); 
                    }
                } catch(err) { alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
            };
            input.click();
        }

        function initGlobalMap() {
            if (typeof kakao === 'undefined' || !kakao.maps) return;
            kakao.maps.load(function() {
                const mapContainer = document.getElementById('global-map');
                if (!mapContainer) return;
                if (globalMap) { 
                    globalMap.relayout(); 
                    moveToMyLocation(); 
                    setTimeout(function() { globalMap.relayout(); moveToMyLocation(); }, 100);
                    return; 
                } 
                const defaultLoc = new kakao.maps.LatLng(37.5665, 126.9780);
                globalMap = new kakao.maps.Map(mapContainer, { center: defaultLoc, level: 6 });
                moveToMyLocation();
                loadMapMarkers();
                setTimeout(function() { globalMap.relayout(); moveToMyLocation(); }, 100);
            });
        }

        function moveToMyLocation() {
            if (navigator.geolocation && globalMap) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const loc = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    globalMap.setCenter(loc);
                    globalMap.setLevel(4);
                });
            }
        }

        async function loadMapMarkers() {
            try {
                const res = await fetch(`${API_URL}/feed`);
                if (!res.ok) throw new Error("ì„œë²„ ì—ëŸ¬");
                let feedList = await res.json();
                if (!Array.isArray(feedList)) feedList = feedList.data || [];
                feedList.forEach(function(r) {
                    if (r.x && r.y) {
                        const loc = new kakao.maps.LatLng(Number(r.y), Number(r.x));
                        const marker = new kakao.maps.Marker({ position: loc, map: globalMap });
                        kakao.maps.event.addListener(marker, 'click', function() {
                            const safeName = (r.name||'').replace(/`/g,"");
                            const safeCat = (r.category||'').replace(/`/g,"");
                            const safeAddr = (r.address||'').replace(/`/g,"");
                            const safeComment = (r.comment||'').replace(/`/g,"");
                            openRestDetail(safeName, safeCat, safeAddr, safeComment, r.tier||'', r.kakao_id||'', r.image_url||'', r.owner||'', r.id||'', false);
                        });
                    }
                });
            } catch (e) {}
        }

        function toggleLanguage() {
            currentLang = currentLang === 'ko' ? 'en' : 'ko';
            document.getElementById('lang-toggle').innerText = currentLang === 'ko' ? 'EN' : 'KR';
            document.querySelectorAll('[data-ko]').forEach(function(el) { el.innerText = el.getAttribute(`data-${currentLang}`); });
            document.querySelectorAll('[data-ph-ko]').forEach(function(el) { el.placeholder = el.getAttribute(`data-ph-${currentLang}`); });
            if (document.getElementById('tab-local') && currentProfileLocalRegion) {
                document.getElementById('tab-local').innerText = currentLang === 'ko' ? `ì§€ì—­ ë§›ì§‘ (${currentProfileLocalRegion})` : `Local (${currentProfileLocalRegion})`;
            }
            const activeTab = document.querySelector('.nav-item.active');
            if (activeTab) switchTab(activeTab.id.replace('m-', '')); 
        }

        function changeGlobalRegion() {
            globalRegion = document.getElementById('global-region-select').value;
            const activeTab = document.querySelector('.nav-item.active');
            if (activeTab) { 
                const tabId = activeTab.id.replace('m-', '');
                if (tabId === 'home') fetchHomeData();
                else if (tabId === 'explore') switchExploreTab('ranking'); 
                else if (tabId === 'network') fetchNetworkData();
            }
        }

        function switchTab(t, skipFetch = false) {
            const user = localStorage.getItem('currentUser');
            document.querySelectorAll('.tab-view').forEach(function(view) { view.style.display = 'none'; });
            document.getElementById(t + '-view').style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(function(el) { el.classList.remove('active'); });
            const activeNav = document.getElementById('m-' + t);
            if (activeNav) activeNav.classList.add('active');
            
            if (!skipFetch) {
                if (t === 'home') fetchHomeData();
                else if (t === 'network') fetchNetworkData(); 
                else if (t === 'explore') switchExploreTab('ranking'); 
                else if (t === 'profile') fetchGuideView(user);
                else if (t === 'map') setTimeout(function() { initGlobalMap(); }, 200); 
            }
            window.scrollTo(0,0);
        }

        function getSmartRestImage(id, category, userImg) {
            if (userImg && userImg !== 'null' && userImg !== '') return userImg; 
            const cat = category || "";
            if (cat.includes('ê³ ê¸°') || cat.includes('êµ¬ì´') || cat.includes('ì†Œ') || cat.includes('ë¼ì§€')) return 'https://images.unsplash.com/photo-1544025162-811114cd354a?w=800&q=80';
            if (cat.includes('ì¹´í˜') || cat.includes('ì»¤í”¼') || cat.includes('ë””ì €íŠ¸')) return 'https://images.unsplash.com/photo-1554118811-1e0d58224f24?w=800&q=80';
            if (cat.includes('ì¼ì‹') || cat.includes('ì´ˆë°¥') || cat.includes('ìŠ¤ì‹œ')) return 'https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?w=800&q=80';
            if (cat.includes('ì¤‘ì‹') || cat.includes('ë§ˆë¼') || cat.includes('ì§œì¥')) return 'https://images.unsplash.com/photo-1585032226651-759b368d7246?w=800&q=80';
            if (cat.includes('ì–‘ì‹') || cat.includes('íŒŒìŠ¤íƒ€') || cat.includes('í”¼ì')) return 'https://images.unsplash.com/photo-1473093295043-cdd812d0e601?w=800&q=80';
            if (id && id !== 'undefined' && id !== 'null') return `https://img1.kakaocdn.net/cthumb/local/R0x0/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flocalfiy%2Fsearch%2Fplace%2F${id}`;
            return 'https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800&q=80'; 
        }

        // ğŸŒŸ ì§€ì—­ ë¯¸ì‹ê°€ ë™ì  ë³€ê²½ ë° ìˆ˜ìš”(ğŸ”¥) í‘œì‹œ ì™„ë²½ ìœ ì§€
        async function fetchHomeData() {
            try {
                const res = await fetch(`${API_URL}/main/data`); 
                if (!res.ok) throw new Error("ì„œë²„ ì—ëŸ¬ ë°œìƒ");
                const d = await res.json();
                
                nationalTop50 = d.national_top_50 || [];
                regionalTop10 = d.regional_top_10 || {};
                
                let displayEditors = [];
                const titleEl = document.getElementById('home-editor-title');

                if (globalRegion === 'national') {
                    displayEditors = d.all_editors || [];
                    if (titleEl) titleEl.innerText = currentLang === 'ko' ? "ì¸ê¸° ë¯¸ì‹ê°€" : "Featured Gourmets";
                } else {
                    const regionalUsernames = regionalTop10[globalRegion] || [];
                    displayEditors = (d.all_editors || []).filter(e => regionalUsernames.includes(e.username));
                    if (titleEl) titleEl.innerText = currentLang === 'ko' ? `${globalRegion}ì§€ì—­ ì¶”ì²œ ë¯¸ì‹ê°€` : `Top in ${globalRegion}`;
                }

                if (displayEditors.length === 0) {
                    document.getElementById('editor-list-container').innerHTML = `<div style="padding:20px; color:var(--text-sub); font-size:13px; text-align:center; width:100%;">${currentLang==='ko'?'ì´ ì§€ì—­ì— í™œë™í•˜ëŠ” ë¯¸ì‹ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.':'No gourmets in this region yet.'}</div>`;
                } else {
                    document.getElementById('editor-list-container').innerHTML = displayEditors.map(function(e) {
                        const isMe = (e.username === localStorage.getItem('currentUser'));
                        const isFollow = followingList.includes(e.username);
                        const followHtml = !isMe ? `
                            <button onclick="event.stopPropagation(); const btn = this; executeToggleFollow('${e.username}').then(() => { btn.innerText = btn.innerText.includes('âœ“') ? '+ íŒ”ë¡œìš°' : 'âœ“ íŒ”ë¡œì‰'; });" 
                                style="margin-top:8px; padding:4px 12px; background:var(--brand-primary); color:var(--brand-fab); border:none; border-radius:12px; font-size:10px; font-weight:700; cursor:pointer;">
                                ${isFollow ? 'âœ“ íŒ”ë¡œì‰' : '+ íŒ”ë¡œìš°'}
                            </button>` : '';

                        return `
                        <div class="editor-card" onclick="fetchGuideView('${e.username}', true)">
                            <div class="editor-img-container" style="overflow:visible !important;">${getAvatar(e.username)}</div>
                            <div style="font-weight:700; font-size:14px; color:var(--text-main);">${e.display_name || e.username}</div>
                            <div style="font-size:11px; color:var(--text-sub); margin-top:4px;">${e.followers} ${currentLang==='ko'?'íŒ”ë¡œì›Œ':'Followers'}</div>
                            ${followHtml}
                        </div>`;
                    }).join('');
                }
                
                const renderer = function(list, tid, isPopular = false) {
                    if (globalRegion !== 'national') {
                        list = list.filter(function(r) { return (r.address || '').includes(globalRegion); });
                    }
                    if (list.length === 0) { 
                        document.getElementById(tid).innerHTML = `<div style="padding:20px; color:var(--text-sub); font-size:13px;">${currentLang==='ko'?'í•´ë‹¹ ì§€ì—­ì˜ ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤.':'No restaurants in this region.'}</div>`; 
                        return; 
                    }
                    
                    let html = '';
                    list.forEach(function(r) {
                        const finalImg = getSmartRestImage(r.kakao_id, r.category, r.image_url);
                        const safeName = (r.name || '').replace(/`/g, "");
                        const safeCat = (r.category || '').replace(/`/g, "");
                        const safeAddr = (r.address || '').replace(/`/g, "");
                        const safeComment = (r.comment || '').replace(/`/g, "");
                        
                        let subInfoHtml = '';
                        if (isPopular && r.save_count) {
                            subInfoHtml = `<span style="font-weight:700; color:var(--brand-fab);">ğŸ”¥ ${r.save_count}ëª…ì´ ì„œì—´ì— ë“±ë¡</span>`;
                        } else {
                            subInfoHtml = `<span style="font-weight:600; color:var(--text-main);">âœï¸ ${r.owner}</span>`;
                        }
                        
                        html += `
                        <div class="rest-card" onclick="openRestDetail(\`${safeName}\`, \`${safeCat}\`, \`${safeAddr}\`, \`${safeComment}\`, \`${r.tier||''}\`, \`${r.kakao_id||''}\`, \`${r.image_url||''}\`, \`${r.owner||''}\`, \`${r.id||''}\`, false)">
                            ${r.owner !== localStorage.getItem('currentUser') ? `
                                <div class="bookmark-btn-mini" onclick="event.stopPropagation(); executeBookmark('${r.id}')">
                                    <svg viewBox="0 0 24 24" style="width:16px; height:16px; stroke:var(--text-main); fill:none; stroke-width:2;"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                                </div>
                            ` : ''}
                            <div class="rest-img-wrapper">
                                <img class="rest-img" src="${finalImg}" onerror="this.src='https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800&q=80'">
                            </div>
                            <div class="rest-info">
                                <div class="rest-name">${r.name}</div>
                                <div style="font-size:11px; color:var(--text-sub); display:flex; align-items:center; gap:6px;">
                                    ${subInfoHtml}
                                </div>
                            </div>
                        </div>`;
                    });
                    document.getElementById(tid).innerHTML = html;
                };
                
                renderer(d.popular_places || [], 'popular-list-container', true); 
                renderer(d.new_restaurants || [], 'new-list-container', false);
            } catch(e) {}
        }

        async function fetchNetworkData() {
            try {
                const res = await fetch(`${API_URL}/main/data`); 
                if (!res.ok) throw new Error("ì„œë²„ ì—ëŸ¬ ë°œìƒ");
                const d = await res.json();
                
                nationalTop50 = d.national_top_50 || [];
                regionalTop10 = d.regional_top_10 || {};

                const curUser = localStorage.getItem('currentUser');
                const me = (d.all_editors || []).find(e => e.username === curUser);
                if (me) followingList = me.following || [];
                
                let followingHtml = '';
                if (followingList.length > 0) {
                    followingList.forEach(function(u) {
                        const targetUser = (d.all_editors || []).find(e => e.username === u);
                        const displayName = targetUser ? (targetUser.display_name || u) : u;

                        followingHtml += `
                        <div class="user-result-item" onclick="fetchGuideView('${u}', true)">
                            <div style="width:48px; height:48px; border-radius:50%; overflow:visible;">${getAvatar(u)}</div>
                            <div style="flex:1;">
                                <div style="font-weight:700; font-size:16px; color:var(--text-main); margin-bottom:4px;">${displayName}</div>
                                <div class="tag-pill tag-blue" style="font-size:10px; padding:4px 8px;">âœ“ ${currentLang==='ko'?'íŒ”ë¡œì‰':'Following'}</div>
                            </div>
                            <div style="color:var(--text-sub);">
                                <svg class="svg-icon" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </div>
                        </div>`;
                    });
                } else {
                    followingHtml = `<div style="text-align:center; padding:40px 20px; background:transparent; border:1px dashed var(--border-color); border-radius:var(--radius-lg); color:var(--text-sub); font-size:13px;">${currentLang==='ko'?'ì•„ì§ íŒ”ë¡œìš°í•œ ë¯¸ì‹ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.':'No following yet.'}</div>`;
                }
                document.getElementById('following-list-container').innerHTML = followingHtml;

                let recommendedSet = new Set();
                followingList.forEach(followedUser => {
                    const fUserObj = (d.all_editors || []).find(e => e.username === followedUser);
                    if (fUserObj && fUserObj.following) {
                        fUserObj.following.forEach(u => recommendedSet.add(u));
                    }
                });

                let recUsernames = Array.from(recommendedSet).filter(u => u !== curUser && !followingList.includes(u));

                if (recUsernames.length === 0) {
                    recUsernames = (d.all_editors || [])
                        .filter(e => e.username !== curUser && !followingList.includes(e.username))
                        .slice(0, 10)
                        .map(e => e.username);
                }

                let recHtml = '';
                if (recUsernames.length > 0) {
                    const recommended = recUsernames.map(u => (d.all_editors || []).find(e => e.username === u)).filter(Boolean);
                    
                    recHtml += `<div class="editor-row" style="padding-bottom: 10px;">`; 
                    recommended.forEach(function(e) {
                        recHtml += `
                        <div class="editor-card" onclick="fetchGuideView('${e.username}', true)">
                            <div class="editor-img-container" style="overflow:visible !important;">${getAvatar(e.username)}</div>
                            <div style="font-weight:700; font-size:14px; color:var(--text-main);">${e.display_name || e.username}</div>
                            <div style="font-size:11px; color:var(--text-sub); margin-top:4px;">${currentLang==='ko'?'ê²Œì‹œë¬¼':'Posts'}: ${e.rest_count}</div>
                        </div>`;
                    });
                    recHtml += `</div>`; 
                } else {
                    recHtml = `<div style="text-align:center; padding:40px 20px; background:transparent; border:1px dashed var(--border-color); border-radius:var(--radius-lg); color:var(--text-sub); font-size:13px;">${currentLang==='ko'?'ì¶”ì²œí•  ë¯¸ì‹ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.':'No recommendations.'}</div>`;
                }
                document.getElementById('recommended-list-container').innerHTML = recHtml;
            } catch(e) {}
        }

        // ==========================================
        // ğŸŒŸ íƒìƒ‰(Explore) ë©€í‹°í”Œë ‰ìŠ¤ & ê²€ìƒ‰ ì—”ì§„ 
        // ==========================================
        function switchExploreTab(tab) {
            if (tab === 'ranking') {
                document.getElementById('tab-explore-ranking').classList.add('active');
                document.getElementById('tab-explore-feed').classList.remove('active');
                document.getElementById('explore-ranking-area').style.display = 'block';
                document.getElementById('explore-feed-area').style.display = 'none';
                fetchRankingData(); 
            } else {
                document.getElementById('tab-explore-feed').classList.add('active');
                document.getElementById('tab-explore-ranking').classList.remove('active');
                document.getElementById('explore-feed-area').style.display = 'block';
                document.getElementById('explore-ranking-area').style.display = 'none';
                fetchExploreFeed(); 
            }
        }

        function renderRankingList(rankingData, container) {
            let html = '';
            if(rankingData.length === 0) {
                html = `<div style="text-align:center; padding:40px; border:1px dashed var(--border-color); border-radius:12px; color:var(--text-sub); font-size:13px;">ê²€ìƒ‰ëœ ì¡°ê±´ì˜ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            } else {
                rankingData.forEach((r, idx) => {
                    const finalImg = getSmartRestImage(r.kakao_id, r.category, r.image_url);
                    
                    let rankBadge = `<div style="font-size:18px; font-weight:900; color:var(--text-sub);">${idx + 1}</div>`;
                    if(idx === 0) rankBadge = `<div style="font-size:24px;">ğŸ¥‡</div>`;
                    if(idx === 1) rankBadge = `<div style="font-size:24px;">ğŸ¥ˆ</div>`;
                    if(idx === 2) rankBadge = `<div style="font-size:24px;">ğŸ¥‰</div>`;

                    html += `
                    <div class="user-result-item" onclick="closeGlobalSearchModal(); openRestDetail(\`${r.name}\`, \`${r.category}\`, \`${r.address}\`, '', '', \`${r.kakao_id}\`, \`${r.image_url}\`, '', \`${r.id}\`, false)" style="display:flex; align-items:center; gap:16px;">
                        <div style="width:40px; text-align:center;">${rankBadge}</div>
                        <div style="width:70px; height:70px; border-radius:12px; overflow:hidden; flex-shrink:0;">
                            <img src="${finalImg}" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:800; font-size:16px; color:var(--text-main); margin-bottom:4px;">${r.name}</div>
                            <div style="font-size:11px; color:var(--text-sub); margin-bottom:6px;">${r.category.split('>').pop()}</div>
                            <div class="tag-pill tag-pink" style="font-size:10px; padding:4px 8px; background:var(--brand-primary); color:var(--brand-fab);">
                                ğŸ”¥ ${r.save_count}ëª…ì´ ì„œì—´ì— ë“±ë¡
                            </div>
                        </div>
                    </div>`;
                });
            }
            container.innerHTML = html;
        }

        async function fetchRankingData() {
            const keyword = document.getElementById('ranking-search-input').value.trim();
            const container = document.getElementById('ranking-list-container');
            container.innerHTML = `<div style="text-align:center; padding:30px; color:var(--brand-fab); font-size:13px; font-weight:700;">ë­í‚¹ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... â³</div>`;
            try {
                const res = await fetch(`${API_URL}/ranking?keyword=${encodeURIComponent(keyword)}`);
                const d = await res.json();
                renderRankingList(d.ranking, container);
            } catch(e) { 
                container.innerHTML = `<div class="server-error-banner">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
            }
        }

        function openGlobalSearchModal() {
            document.getElementById('global-search-modal').style.display = 'flex';
            document.getElementById('global-ranking-input').value = '';
            document.getElementById('global-search-results').innerHTML = `
                <div style="text-align:center; padding:40px 20px; color:var(--text-sub); font-size:13px;">
                    ì›í•˜ì‹œëŠ” ë©”ë‰´ë‚˜ ì‹ë‹¹ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì‹œë©´<br>ê°€ì¥ ë§ì´ ë“±ë¡ëœ ìˆœì„œëŒ€ë¡œ ë­í‚¹ì„ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.
                </div>
            `;
        }
        function closeGlobalSearchModal() {
            document.getElementById('global-search-modal').style.display = 'none';
        }
        async function executeGlobalSearch() {
            const keyword = document.getElementById('global-ranking-input').value.trim();
            const container = document.getElementById('global-search-results');
            container.innerHTML = `<div style="text-align:center; padding:30px; color:var(--brand-fab); font-size:13px; font-weight:700;">ë­í‚¹ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... â³</div>`;
            try {
                const res = await fetch(`${API_URL}/ranking?keyword=${encodeURIComponent(keyword)}`);
                const d = await res.json();
                renderRankingList(d.ranking, container);
            } catch(e) {
                container.innerHTML = `<div class="server-error-banner">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
            }
        }

        async function fetchExploreFeed() {
            try {
                const current = localStorage.getItem('currentUser');
                const res = await fetch(`${API_URL}/feed`); 
                if (!res.ok) throw new Error("ì„œë²„ ì—ëŸ¬ ë°œìƒ");
                let feedList = await res.json();
                
                if (!Array.isArray(feedList)) feedList = feedList.data || [];
                
                if (globalRegion !== 'national') {
                    feedList = feedList.filter(function(r) { return (r.address || '').includes(globalRegion); });
                }

                if (!feedList || feedList.length === 0) {
                    document.getElementById('feed-scroll-area').innerHTML = `<div style="text-align:center; padding:60px 20px; border:1px dashed var(--border-color); border-radius:var(--radius-lg); color:var(--text-sub); font-size:14px;">${currentLang==='ko'?'í•´ë‹¹ ì§€ì—­ì— ì•„ì§ ì†Œì‹ì´ ì—†ìŠµë‹ˆë‹¤.':'No posts here.'}</div>`;
                    return;
                }
                
                let html = '';
                feedList.reverse().forEach(function(r) {
                    const isMe = (r.owner === current); 
                    const isFollowing = followingList.includes(r.owner);
                    const finalImg = getSmartRestImage(r.kakao_id, r.category, r.image_url);
                    const fallbackImg = "https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800&q=80";
                    
                    const safeName = (r.name || '').replace(/`/g, "");
                    const safeCat = (r.category || '').replace(/`/g, "");
                    const safeAddr = (r.address || '').replace(/`/g, "");
                    const safeComment = (r.comment || '').replace(/`/g, "");
                    
                    const likesCount = (r.likes || []).length;
                    const isLiked = (r.likes || []).includes(current);

                    html += `
                    <div class="feed-card" onclick="openRestDetail(\`${safeName}\`, \`${safeCat}\`, \`${safeAddr}\`, \`${safeComment}\`, \`${r.tier||''}\`, \`${r.kakao_id||''}\`, \`${r.image_url||''}\`, \`${r.owner||''}\`, \`${r.id||''}\`, false)">
                        <div class="feed-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;" onclick="event.stopPropagation()">
                            <div class="feed-user" onclick="fetchGuideView('${r.owner}', true)" style="font-weight:700; cursor:pointer; display:flex; align-items:center; gap:8px;">
                                <div style="width:28px; height:28px; border-radius:50%; overflow:visible;">${getAvatar(r.owner)}</div>
                                ${r.owner}
                            </div>
                            ${!isMe ? `<button onclick="executeToggleFollow('${r.owner}')" style="background:transparent; border:1px solid var(--border-color); padding:4px 10px; border-radius:6px; font-weight:600; font-size:11px; cursor:pointer;">${isFollowing?'âœ“':'Follow'}</button>` : ''}
                        </div>
                        
                        <div style="position:relative; width:100%; border-radius:12px; overflow:hidden; margin-bottom:16px;">
                            <img src="${finalImg}" class="feed-main-img" onerror="this.src='${fallbackImg}'">
                            ${r.tier ? `<div class="rest-badge">â­ï¸ ${r.tier.split(' ')[0]}</div>` : ''}
                        </div>
                        
                        <div class="feed-body" style="padding:0;">
                            <div class="feed-rest-name">${r.name}</div>
                            <div style="font-size:12px; color:var(--text-sub); margin-bottom:16px; font-weight:500; display:flex; align-items:center; gap:6px;">
                                <span>ğŸ“ ${r.address.split(' ')[0]} ${r.address.split(' ')[1] || ''}</span>
                                <span>â€¢</span>
                                <span>${r.category.split('>').pop()}</span>
                            </div>
                            ${r.comment ? `<div style="font-size:14px; color:var(--text-main); line-height:1.6; font-weight:400; margin-bottom: 16px;">"${r.comment}"</div>` : ''}
                            
                            <div class="social-bar" onclick="event.stopPropagation()">
                                <div style="display:flex; gap:16px;">
                                    <div id="like-btn-${r.id}" class="action-btn ${isLiked ? 'liked' : ''}" onclick="executeLike('${r.id}')">
                                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                        <span id="like-count-${r.id}">${likesCount}</span>
                                    </div>
                                    <div class="action-btn" onclick="openRestDetail(\`${safeName}\`, \`${safeCat}\`, \`${safeAddr}\`, \`${safeComment}\`, \`${r.tier||''}\`, \`${r.kakao_id||''}\`, \`${r.image_url||''}\`, \`${r.owner||''}\`, \`${r.id||''}\`, false)">
                                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                                    </div>
                                </div>
                                ${!isMe ? `<div class="action-btn" onclick="executeBookmark('${r.id}')"><svg class="svg-icon" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg></div>` : ''}
                            </div>
                        </div>
                    </div>`;
                });
                document.getElementById('feed-scroll-area').innerHTML = html;
            } catch(e) {}
        }

        async function fetchGuideView(u, isForeign = false) {
            if (isForeign) { 
                switchTab('profile', true); 
                document.getElementById('registration-trigger').style.display = 'none'; 
            } else { 
                document.getElementById('registration-trigger').style.display = 'block'; 
            }
            
            const curUser = localStorage.getItem('currentUser');
            const isMe = (u === curUser);
            const isFollowing = followingList.includes(u);
            
            try {
                const res = await fetch(`${API_URL}/guide/${u}`);
                if (!res.ok) throw new Error("ì„œë²„ ì—ëŸ¬");
                const data = await res.json(); 
                
                currentProfileGuideData = data.guide;
                currentProfileOwner = u;
                currentProfileIsMe = isMe;
                
                currentProfilePhilosophy = data.philosophy || '';
                currentProfileTags = data.taste_tags || [];
                currentProfilePersonalInfo = data.personal_info || '';

                if (isMe) {
                    const myRes = await fetch(`${API_URL}/restaurants`, { headers:{'user-id':u} });
                    const myData = await myRes.json();
                    currentProfileGuideData["í‰ê°€ ëŒ€ê¸° ì¤‘ â³"] = myData.data.filter(function(r) { return !r.tier; });
                }

                let regionCounts = {}; 
                let maxCount = 0; 
                currentProfileLocalRegion = '';
                
                Object.values(currentProfileGuideData).forEach(function(tierList) {
                    tierList.forEach(function(item) {
                        if (item.address) {
                            let region = item.address.split(' ')[0];
                            regionCounts[region] = (regionCounts[region] || 0) + 1;
                            if (regionCounts[region] > maxCount) { 
                                maxCount = regionCounts[region]; 
                                currentProfileLocalRegion = region; 
                            }
                        }
                    });
                });

                const philosophyHtml = currentProfilePhilosophy 
                    ? `<div class="profile-philosophy">"${currentProfilePhilosophy}"</div>` 
                    : '';
                
                const tagsHtml = currentProfileTags.length > 0 
                    ? `<div class="profile-dna-tags">${currentProfileTags.map(t => `<span class="dna-tag">#${t}</span>`).join('')}</div>`
                    : '';
                    
                const badgesHtml = data.badges && data.badges.length > 0
                    ? `<div class="profile-badges">${data.badges.map(b => `<span class="badge-item">${b}</span>`).join('')}</div>`
                    : '';

                document.getElementById('profile-header-target').innerHTML = `
                    <div class="profile-dash">
                        <div class="dash-header">
                            <div class="dash-pic-container" onclick="triggerProfileUpload()" style="cursor:${isMe ? 'pointer' : 'default'}; overflow:visible !important;" title="${isMe ? 'í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½' : ''}">
                                ${getAvatar(u)}
                            </div>
                            
                            <div style="font-size:24px; font-weight:800; margin-bottom:12px; display:flex; align-items:center; justify-content:center; gap:8px;">
                                <span id="display-profile-name">${data.nickname || u}</span>
                                ${isMe ? `<svg onclick="openEditProfileModal()" style="width:20px; height:20px; cursor:pointer; stroke:var(--brand-fab); fill:none; stroke-width:2;" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>` : ''}
                            </div>
                            
                            ${philosophyHtml}
                            ${tagsHtml}
                            ${badgesHtml}
                            
                            ${!isMe ? `
                                <button onclick="executeToggleFollow('${u}', true)" style="background:white; color:var(--brand-primary); border:none; padding:8px 24px; border-radius:20px; font-weight:700; font-size:12px; cursor:pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top:10px;">
                                    ${isFollowing ? (currentLang==='ko'?'âœ“ íŒ”ë¡œì‰':'âœ“ Following') : (currentLang==='ko'?'+ íŒ”ë¡œìš°':'+ Follow')}
                                </button>
                            ` : `
                                <div class="tag-pill tag-pink" style="background:rgba(255,255,255,0.1); color:white; border:1px solid rgba(255,255,255,0.3); font-weight:500; margin-top:10px;">
                                    My Journal
                                </div>
                            `}
                        </div>
                        <div class="dash-stats" id="profile-stats-bar"></div>
                    </div>`;

            } catch(e) {}
            
            fetchStats(u);

            document.getElementById('guide-controls-target').style.display = 'block';
            document.getElementById('guide-search-input').value = '';
            
            if (currentProfileLocalRegion) {
                document.getElementById('tab-local').innerText = currentLang==='ko' ? `ì§€ì—­ ë§›ì§‘ (${currentProfileLocalRegion})` : `Local (${currentProfileLocalRegion})`;
            } else {
                document.getElementById('tab-local').innerText = currentLang==='ko' ? `ì§€ì—­ ë§›ì§‘` : `Local`;
            }
            switchGuideTab('national'); 
        }

        function switchGuideTab(tab) {
            activeGuideTab = tab;
            if (tab === 'national') {
                document.getElementById('tab-national').style.background = 'var(--bg-card)';
                document.getElementById('tab-national').style.color = 'var(--text-main)';
                document.getElementById('tab-national').style.boxShadow = 'var(--shadow-soft)';
                document.getElementById('tab-local').style.background = 'transparent';
                document.getElementById('tab-local').style.color = 'var(--text-sub)';
                document.getElementById('tab-local').style.boxShadow = 'none';
            } else {
                document.getElementById('tab-local').style.background = 'var(--bg-card)';
                document.getElementById('tab-local').style.color = 'var(--text-main)';
                document.getElementById('tab-local').style.boxShadow = 'var(--shadow-soft)';
                document.getElementById('tab-national').style.background = 'transparent';
                document.getElementById('tab-national').style.color = 'var(--text-sub)';
                document.getElementById('tab-national').style.boxShadow = 'none';
            }
            renderGuideSheet();
        }

        function renderGuideSheet() {
            const searchQuery = document.getElementById('guide-search-input').value.toLowerCase();
            
            const tierMeta = {
                "â­â­â­ (3ìŠ¤íƒ€)": { title: "3 Stars", short: "No.1 CLASS", color: "var(--brand-fab)" },
                "â­â­ (2ìŠ¤íƒ€)": { title: "2 Stars", short: "PREMIUM", color: "#E2E0D9" },
                "â­ (1ìŠ¤íƒ€)": { title: "1 Star", short: "EXCELLENT", color: "#B0B3B8" },
                "ë‹¨ìˆœ ì¶”ì²œ": { title: "Recommended", short: "REC", color: "#4A634E" },
                "í‰ê°€ ëŒ€ê¸° ì¤‘ â³": { title: "Wishlist", short: "WISH", color: "#A86A51" }
            };

            let html = `<div class="guide-sheet">`;
            let hasAnyItem = false;

            for(let key in tierMeta) {
                let items = currentProfileGuideData[key] || [];
                
                items = items.filter(function(item) {
                    let matchSearch = !searchQuery || 
                        (item.name || '').toLowerCase().includes(searchQuery) || 
                        (item.category || '').toLowerCase().includes(searchQuery) || 
                        (item.address || '').toLowerCase().includes(searchQuery);
                    
                    let matchTab = activeGuideTab === 'national' || 
                        (item.address || '').startsWith(currentProfileLocalRegion);
                    
                    return matchSearch && matchTab;
                });

                if (items.length > 0 || (currentProfileIsMe && key === "í‰ê°€ ëŒ€ê¸° ì¤‘ â³" && activeGuideTab === 'national' && !searchQuery && items.length > 0)) {
                    hasAnyItem = true;
                    const meta = tierMeta[key];
                    
                    html += `
                        <div class="tier-section">
                            <div class="tier-header-title">
                                ${meta.title} 
                                <span style="font-size:14px; color:var(--text-sub); font-weight:600; margin-left:8px;">${items.length}</span>
                            </div>
                            <div class="guide-grid">
                    `;
                    
                    items.forEach(function(item) {
                        const safeName = (item.name || '').replace(/`/g, "");
                        const safeCat = (item.category || '').replace(/`/g, "");
                        const safeAddr = (item.address || '').replace(/`/g, "");
                        const safeComment = (item.comment || '').replace(/`/g, "");
                        const finalImg = getSmartRestImage(item.kakao_id, item.category, item.image_url);
                        const fallbackImg = "https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800&q=80";

                        let sel = '';
                        if (currentProfileIsMe) {
                            sel = `
                            <select class="tier-select" style="position:absolute; top:8px; right:8px; z-index:10; background:rgba(0,0,0,0.6); color:white; border:1px solid rgba(255,255,255,0.2); border-radius:6px; font-size:10px; font-weight:600; padding:6px; outline:none; cursor:pointer;" onclick="event.stopPropagation()" onchange="executeChangeTier('${item.id}', this.value)">
                                <option value="">ë“±ê¸‰ ìˆ˜ì •</option>
                                <option value="â­â­â­ (3ìŠ¤íƒ€)" ${item.tier==='â­â­â­ (3ìŠ¤íƒ€)'?'selected':''}>3 Stars</option>
                                <option value="â­â­ (2ìŠ¤íƒ€)" ${item.tier==='â­â­ (2ìŠ¤íƒ€)'?'selected':''}>2 Stars</option>
                                <option value="â­ (1ìŠ¤íƒ€)" ${item.tier==='â­ (1ìŠ¤íƒ€)'?'selected':''}>1 Star</option>
                                <option value="ë‹¨ìˆœ ì¶”ì²œ" ${item.tier==='ë‹¨ìˆœ ì¶”ì²œ'?'selected':''}>Recommended</option>
                                <option value="">Wishlist</option>
                            </select>`;
                        }

                        html += `
                        <div class="guide-card" onclick="openRestDetail(\`${safeName}\`, \`${safeCat}\`, \`${safeAddr}\`, \`${safeComment}\`, \`${item.tier||''}\`, \`${item.kakao_id||''}\`, \`${item.image_url||''}\`, \`${currentProfileOwner}\`, \`${item.id||''}\`, true)">
                            <img class="guide-card-bg" src="${finalImg}" onerror="this.src='${fallbackImg}'">
                            <div class="guide-card-overlay">
                                <div class="guide-tier-text" style="color: ${meta.color}">${meta.short}</div>
                                <div class="guide-name-text">${item.name}</div>
                                <div class="guide-sub-text">${item.address ? item.address.split(' ')[0] : ''} Â· ${item.category ? item.category.split('>').pop().trim() : ''}</div>
                            </div>
                            ${sel}
                        </div>`;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            }
            
            if (!hasAnyItem) {
                html += `
                    <div style="text-align:center; padding:50px 20px; color:var(--text-sub); font-size:14px; border:1px dashed var(--border-color); border-radius:var(--radius-lg);">
                        ${currentLang==='ko'?'ì¡°ê±´ì— ë§ëŠ” ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤.':'No restaurants found.'}
                    </div>
                `;
            }
            html += `</div>`;
            document.getElementById('michelin-tables-target').innerHTML = html;
        }

        async function fetchStats(u) {
            try {
                const res = await fetch(`${API_URL}/profile/stats`, { headers:{'user-id':u} });
                const d = await res.json();
                const bar = document.getElementById('profile-stats-bar');
                
                if (bar) {
                    let statsHtml = '';
                    Object.keys(d.stats).forEach(function(k) {
                        statsHtml += `
                        <div style="text-align:center;">
                            <div style="font-weight:700; font-size:20px; line-height:1;">${d.stats[k].count}</div>
                            <div style="font-size:10px; font-weight:500; opacity:0.7; margin-top:6px; text-transform:uppercase; letter-spacing:1px;">${k.split(' ')[0]}</div>
                        </div>`;
                    });
                    bar.innerHTML = statsHtml;
                }
            } catch(e) {}
        }

        async function executeChangeTier(id, tier) {
            const user = localStorage.getItem('currentUser');
            try {
                await fetch(`${API_URL}/restaurants/${id}`, { 
                    method: 'PUT', 
                    headers: { 'Content-Type': 'application/json', 'user-id': user }, 
                    body: JSON.stringify({ tier: tier }) 
                });
                fetchGuideView(user);
            } catch(e) {}
        }

        async function executeToggleFollow(target, isFromProfile = false) {
            const user = localStorage.getItem('currentUser');
            try {
                const res = await fetch(`${API_URL}/follow/${target}`, { 
                    method: 'POST', 
                    headers: { 'user-id': user } 
                });
                if (res.ok) { 
                    const data = await res.json();
                    followingList = data.following; 
                    if (isFromProfile) fetchGuideView(target, true); 
                    else fetchNetworkData(); 
                }
            } catch(e) {}
        }

        function openSearchModal() { 
            switchTab('profile'); 
            document.getElementById('search-modal').style.display = 'flex'; 
        }
        
        function closeSearchModal() { 
            document.getElementById('search-modal').style.display = 'none'; 
        }

        async function executeKakaoSearch() {
            const keyword = document.getElementById('search-keyword').value;
            if (!keyword) return;
            
            try {
                const res = await fetch(`${API_URL}/search/kakao?query=${encodeURIComponent(keyword)}`);
                const d = await res.json();
                
                if (d.errorType || d.msg || d.code) {
                    alert(`ğŸš¨ ì¹´ì¹´ì˜¤ ì„œë²„ ì°¨ë‹¨ ì‚¬ìœ : ${d.message || d.msg || d.code}`);
                    return;
                }

                const target = document.getElementById('search-results-target');
                
                if (!d.documents || d.documents.length === 0) { 
                    target.innerHTML = `<p style="text-align:center; padding:30px; font-weight:500; color:var(--text-sub);">${currentLang==='ko'?'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.':'No results.'}</p>`; 
                    return; 
                }
                
                let html = '';
                d.documents.forEach(function(doc) {
                    const safeName = doc.place_name.replace(/'/g, "\\'");
                    const safeCat = doc.category_name.replace(/'/g, "\\'");
                    const safeAddr = (doc.road_address_name || doc.address_name).replace(/'/g, "\\'");
                    const phone = doc.phone || '';
                    
                    html += `
                    <div class="user-result-item" onclick="preparePosting('${safeName}', '${safeCat}', '${safeAddr}', '${doc.id}', ${doc.x}, ${doc.y}, '${phone}')" style="border:none; border-bottom:1px solid var(--border-color); border-radius:0; box-shadow:none; padding:16px 0;">
                        <div style="flex:1;">
                            <div style="font-weight:700; font-size:15px; color:var(--text-main); margin-bottom:4px;">${doc.place_name}</div>
                            <div style="font-size:12px; color:var(--text-sub);">${doc.road_address_name || doc.address_name}</div>
                        </div>
                        <div style="color:var(--text-sub);">
                            <svg class="svg-icon" viewBox="0 0 24 24" style="width:20px; height:20px;">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                        </div>
                    </div>`;
                });
                target.innerHTML = html;
            } catch(e) {
                alert("ğŸš¨ íŒŒì´ì¬ ë°±ì—”ë“œ ì„œë²„ê°€ ë©ˆì¶°ìˆìŠµë‹ˆë‹¤.");
            }
        }

        // ğŸŒŸ ìˆ˜ì •ë¨: ë‹¤ì¤‘ ì´ë¯¸ì§€ ì„ íƒ ì‹œ ë¬¸êµ¬ ë° í”„ë¦¬ë·° ë°˜ì˜
        function handleImagePreview(input) {
            if (input.files && input.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoBox = document.getElementById('selected-rest-photo');
                    photoBox.style.backgroundImage = `url('${e.target.result}')`;
                    const text = input.files.length > 1 ? `âœ… ${input.files.length} Photos Selected` : `âœ… Photo Selected`;
                    photoBox.innerHTML = `<div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.6); color:white; font-size:11px; font-weight:700; text-align:center; padding: 6px 0;">${text}</div>`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function preparePosting(n, c, a, id, x, y, phone) {
            closeSearchModal();
            const form = document.getElementById('post-detail-modal');
            form.style.display = 'flex';
            
            document.getElementById('h-name').value = n;
            document.getElementById('h-cat').value = c.split('>').pop().trim();
            document.getElementById('h-addr').value = a;
            document.getElementById('h-id').value = id;
            document.getElementById('h-x').value = x;
            document.getElementById('h-y').value = y;
            document.getElementById('h-phone').value = phone || '';
            
            document.getElementById('selected-info-text').innerHTML = `<b style="font-size:18px; color:var(--text-main);">${n}</b><br><span style="font-size:13px; color:var(--text-sub); font-weight:500;">${a}</span>`;

            const photoBox = document.getElementById('selected-rest-photo');
            const defaultBgUrl = getSmartRestImage(id, c, null);
            photoBox.style.backgroundImage = `url('${defaultBgUrl}')`;
            photoBox.innerHTML = '<div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.5); color:white; font-size:11px; font-weight:600; text-align:center; padding: 6px 0;">âœ¨ Theme Image</div>'; 
            
            const photoUrl = `https://img1.kakaocdn.net/cthumb/local/R0x0/?fname=http%3A%2F%2Ft1.daumcdn.net%2Flocalfiy%2Fsearch%2Fplace%2F${id}`;
            let img = new Image();
            img.onload = function() { 
                photoBox.style.backgroundImage = `url('${photoUrl}')`; 
                photoBox.innerHTML = '<div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.5); color:white; font-size:11px; text-align:center; padding: 6px 0;">ğŸ“ Basic Image</div>';
            };
            img.src = photoUrl;

            setTimeout(function() {
                if (typeof kakao !== 'undefined' && kakao.maps) {
                    const mapArea = document.getElementById('map-preview-area');
                    mapArea.innerHTML = ''; 
                    
                    const loc = new kakao.maps.LatLng(Number(y), Number(x));
                    
                    if (!previewMap) {
                        previewMap = new kakao.maps.Map(mapArea, { center: loc, level: 3 });
                        previewMarker = new kakao.maps.Marker({ position: loc, map: previewMap });
                    } else {
                        previewMap.relayout();
                        previewMap.setCenter(loc);
                        previewMarker.setPosition(loc);
                    }
                    
                    setTimeout(function() { 
                        previewMap.relayout(); 
                        previewMap.setCenter(loc); 
                    }, 200);
                }
            }, 300); 
        }

        function cancelPosting() { 
            document.getElementById('post-detail-modal').style.display = 'none'; 
            document.getElementById('post-image').value = '';
            document.getElementById('post-comment').value = '';
        }

        // ğŸŒŸ ìˆ˜ì •ë¨: ë‹¤ì¤‘ ì´ë¯¸ì§€ ì „ì†¡ ë¡œì§ ì¶”ê°€
        async function executeAddRestaurant() {
            const user = localStorage.getItem('currentUser');
            const fd = new FormData();
            
            fd.append('name', document.getElementById('h-name').value);
            fd.append('category', document.getElementById('h-cat').value);
            fd.append('address', document.getElementById('h-addr').value);
            fd.append('kakao_id', document.getElementById('h-id').value);
            fd.append('x', document.getElementById('h-x').value);
            fd.append('y', document.getElementById('h-y').value);
            
            const comment = document.getElementById('post-comment').value;
            if (!comment) { 
                alert("ë¯¸ì‹í‰ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."); 
                return; 
            }
            fd.append('comment', comment);
            
            const files = document.getElementById('post-image').files;
            if (files && files.length > 0) { 
                for(let i=0; i<files.length; i++) {
                    fd.append('images', files[i]); 
                }
            }

            try {
                const res = await fetch(`${API_URL}/restaurants`, { 
                    method: 'POST', 
                    headers: { 'user-id': encodeURI(user) }, 
                    body: fd 
                });
                
                if (res.ok) { 
                    alert("ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                    cancelPosting(); 
                    fetchGuideView(user); 
                } else { 
                    const errText = await res.text();
                    alert(`ğŸš¨ ì„œë²„ ì €ì¥ ì‹¤íŒ¨! (ì½”ë“œ: ${res.status})\nì´ìœ : ${errText}`); 
                }
            } catch(e) { 
                alert(`ğŸš¨ ë„¤íŠ¸ì›Œí¬ í†µì‹  ì—ëŸ¬!\n${e.message}\n(íŒŒì´ì¬ í„°ë¯¸ë„ ì°½ì— ì—ëŸ¬ê°€ ë‚¬ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”)`); 
            }
        }
        // ğŸŒŸ ë³µêµ¬ ì™„ë£Œ: ì‹ë‹¹ ê¸°ë¡ ì‚­ì œ ì—”ì§„
        async function executeDeleteRestaurant() {
            if (!confirm("ì´ ë§›ì§‘ ê¸°ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•œ ë²ˆ ì‚­ì œí•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;

            const user = localStorage.getItem('currentUser');
            const restaurantId = currentOpenRestId; // í˜„ì¬ ì—´ë ¤ìˆëŠ” ì‹ë‹¹ì˜ ê³ ìœ  ID

            if (!restaurantId) {
                alert("ì‚­ì œí•  ì‹ë‹¹ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            try {
                const res = await fetch(`${API_URL}/restaurants/${restaurantId}`, {
                    method: 'DELETE',
                    headers: { 'user-id': encodeURI(user) }
                });

                if (res.ok) {
                    alert("ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeRestDetail(); // ìƒì„¸ì°½ ë‹«ê¸°
                    fetchGuideView(user); // ë‚´ í”„ë¡œí•„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    const errText = await res.text();
                    alert(`ğŸš¨ ì‚­ì œ ì‹¤íŒ¨: ${errText}`);
                }
            } catch (e) {
                alert(`ğŸš¨ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì‚­ì œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${e.message}`);
            }
        }

        // ğŸŒŸ ìˆ˜ì •ë¨: ë‹¤ì¤‘ ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” ë Œë”ë§ ë¡œì§ ì¶”ê°€
        function openRestDetail(name, category, address, comment, tier, kakao_id, img_url, owner, db_id, showGuestbook = false) {
            document.getElementById('restaurant-detail-modal').style.display = 'flex';
            const user = localStorage.getItem('currentUser');
            
            currentOpenRestId = db_id; 
            
            const detailImgEl = document.getElementById('detail-img');
            const finalImg = getSmartRestImage(kakao_id, category, img_url);
            
            // ê¸°ì¡´ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™” ë° ë‹¨ì¼ ì´ë¯¸ì§€ ì„¸íŒ…
            const oldSlider = detailImgEl.querySelector('.multi-image-slider');
            if(oldSlider) oldSlider.remove();
            detailImgEl.style.backgroundImage = `url('${finalImg}')`;
            
            const deleteBtn = document.getElementById('delete-rest-btn');
            if (owner === user && db_id && db_id !== 'undefined') {
                deleteBtn.style.display = 'block';
            } else {
                deleteBtn.style.display = 'none';
            }

            const aiBtn = document.getElementById('ai-sync-btn');
            if (owner === user && db_id && db_id !== 'undefined') {
                aiBtn.style.display = 'block';
                aiBtn.onclick = function(e) { 
                    e.stopPropagation(); 
                    openAIPicker(db_id, name); 
                };
            } else { 
                aiBtn.style.display = 'none'; 
            }

            document.getElementById('detail-name').innerText = name;
            document.getElementById('detail-category').innerText = category.split('>').pop().trim();
            document.getElementById('detail-address').innerText = `ğŸ“ ${address.split(' ')[0]} ${address.split(' ')[1] || ''}`;
            document.getElementById('detail-comment').innerText = comment && comment !== "undefined" ? `"${comment}"` : "ë“±ë¡ëœ ë¯¸ì‹í‰ì´ ì—†ìŠµë‹ˆë‹¤.";
            document.getElementById('detail-tier').innerText = tier ? `â­ï¸ ${tier.split(' ')[0]}` : "New Entry";
            
            const ownerBtn = document.getElementById('detail-owner');
            ownerBtn.innerText = `âœï¸ ${owner}`;
            ownerBtn.onclick = function() { 
                closeRestDetail(); 
                fetchGuideView(owner, true); 
            };

            const followBtn = document.getElementById('detail-follow-btn');
            if (owner === user || !owner || owner === 'undefined') {
                followBtn.style.display = 'none';
            } else {
                followBtn.style.display = 'inline-block';
                const isFollowing = followingList.includes(owner);
                followBtn.innerText = isFollowing ? (currentLang==='ko'?'âœ“ íŒ”ë¡œì‰':'âœ“ Following') : (currentLang==='ko'?'+ íŒ”ë¡œìš°':'+ Follow');
                
                followBtn.onclick = function(e) {
                    e.stopPropagation();
                    executeToggleFollow(owner, false).then(() => {
                        const updated = followingList.includes(owner);
                        followBtn.innerText = updated ? (currentLang==='ko'?'âœ“ íŒ”ë¡œì‰':'âœ“ Following') : (currentLang==='ko'?'+ íŒ”ë¡œìš°':'+ Follow');
                    });
                };
            }
            
            document.getElementById('detail-phone').style.display = 'none';
            document.getElementById('detail-map-area').innerHTML = '<p style="text-align:center; padding:100px 0; color:#999; font-size:12px;">Loading map...</p>';

            const existingAgg = document.querySelector('.aggregated-reviews');
            if (existingAgg) existingAgg.remove();
            const existingComment = document.querySelector('.comment-area');
            if (existingComment) existingComment.remove();

            if (db_id && db_id !== 'undefined') {
                fetch(`${API_URL}/feed`)
                .then(function(r) { return r.json(); })
                .then(function(res) {
                    const dataList = Array.isArray(res) ? res : (res.data || []);
                    const targetData = dataList.find(function(item) { return item.id === db_id; });
                    
                    // ğŸŒŸ ë‹¤ì¤‘ ì´ë¯¸ì§€ ë Œë”ë§ ì£¼ì…
                    if (targetData && targetData.image_urls && targetData.image_urls.length > 1) {
                        let sliderHtml = `<div class="multi-image-slider">`;
                        targetData.image_urls.forEach(u => {
                            sliderHtml += `<img src="${u}" class="multi-image-slide">`;
                        });
                        sliderHtml += `</div>`;
                        detailImgEl.style.backgroundImage = 'none';
                        detailImgEl.insertAdjacentHTML('afterbegin', sliderHtml);
                    }
                    
                    const samePlaces = dataList.filter(function(item) {
                        return item.kakao_id === kakao_id && item.comment && item.comment.trim() !== '';
                    });

                    let reviewHtml = '';
                    if (samePlaces.length > 0) {
                        samePlaces.forEach(function(p) {
                            reviewHtml += `
                            <div style="padding: 10px 0; border-bottom: 1px dashed var(--border-color);">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                                    <div style="font-weight:700; font-size:12px; color:var(--text-main); cursor:pointer;" onclick="closeRestDetail(); fetchGuideView('${p.owner}', true)">
                                        ğŸ§‘â€ğŸ³ ${p.owner}
                                    </div>
                                    ${p.tier ? `<span class="tag-pill tag-blue" style="font-size:9px; padding:2px 6px;">${p.tier.split(' ')[0]}</span>` : ''}
                                </div>
                                <div style="color:var(--text-main); font-size: 13px; line-height:1.4;">"${p.comment}"</div>
                            </div>`;
                        });
                    } else {
                        reviewHtml = `<div style="color:var(--text-sub); font-size:12px; text-align:center; padding: 10px 0;">ì•„ì§ ë‹¤ë¥¸ ë¯¸ì‹ê°€ë“¤ì˜ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                    }

                    const aggregatedHtml = `
                        <div class="aggregated-reviews" style="padding: 16px; background:var(--bg-main); border-radius:12px; margin-bottom:16px; border:1px solid var(--border-color);">
                            <div style="font-size:11px; font-weight:800; margin-bottom:10px; color:var(--text-sub); text-transform:uppercase; letter-spacing:0.5px;">
                                ğŸ’¡ ì´ ì‹ë‹¹ì— ëŒ€í•œ ë‹¤ë¥¸ ë¯¸ì‹ê°€ë“¤ì˜ í•œì¤„í‰
                            </div>
                            <div style="max-height:150px; overflow-y:auto;">${reviewHtml}</div>
                        </div>
                    `;

                    let guestbookHtml = '';
                    if (targetData && showGuestbook) {
                        guestbookHtml = `
                            <div class="comment-area" style="background:var(--bg-main); border-radius:12px; padding:16px; margin-bottom:30px; border:1px solid var(--border-color);">
                                <div style="font-size:11px; font-weight:800; margin-bottom:10px; color:var(--text-sub); text-transform:uppercase;">
                                    ğŸ’¬ ${owner}ë‹˜ì˜ ê¸°ë¡ì— ë°©ëª…ë¡ ë‚¨ê¸°ê¸°
                                </div>
                                <div id="comment-list-${db_id}" class="comment-list"></div>
                                <div class="comment-input-row">
                                    <input type="text" id="comment-input-${db_id}" class="comment-input" placeholder="ë°©ëª…ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”...">
                                    <button class="comment-btn" onclick="submitComment('${db_id}')">ê²Œì‹œ</button>
                                </div>
                            </div>
                        `;
                    }

                    document.getElementById('detail-map-area').insertAdjacentHTML('beforebegin', aggregatedHtml + guestbookHtml);
                    
                    if (targetData && showGuestbook) {
                        renderComments(db_id, targetData.comments || []);
                    }
                });
            }
            
            fetch(`${API_URL}/search/kakao?query=${encodeURIComponent(name)}`)
                .then(function(res) { 
                    return res.json(); 
                })
                .then(function(d) {
                    const place = d.documents.find(function(doc) { return doc.id === kakao_id; }) || d.documents[0];
                    if (place) {
                        if (place.phone) {
                            document.getElementById('detail-phone').innerText = `ğŸ“ ${place.phone}`;
                            document.getElementById('detail-phone').style.display = 'inline-block';
                        }
                        
                        document.getElementById('detail-kakao-btn').onclick = function() { 
                            window.open(place.place_url, '_blank'); 
                        };
                        
                        setTimeout(function() {
                            if (typeof kakao !== 'undefined' && kakao.maps) {
                                const mapArea = document.getElementById('detail-map-area');
                                mapArea.innerHTML = ''; 
                                
                                const loc = new kakao.maps.LatLng(Number(place.y), Number(place.x));
                                const map = new kakao.maps.Map(mapArea, { center: loc, level: 3 });
                                const marker = new kakao.maps.Marker({ position: loc, map: map });
                                
                                setTimeout(function() { 
                                    map.relayout(); 
                                    map.setCenter(loc); 
                                }, 200);
                            }
                        }, 300);
                    }
                })
                .catch(function(e) {});
        }

        function closeRestDetail() { 
            document.getElementById('restaurant-detail-modal').style.display = 'none'; 
            currentOpenRestId = null; 
        }

        async function openAIPicker(db_id, name) {
            document.getElementById('ai-image-modal').style.display = 'flex';
            const target = document.getElementById('ai-image-target');
            
            target.innerHTML = `<div style="grid-column: span 2; text-align:center; padding: 50px 0; color:var(--brand-fab); font-size:13px; font-weight:700;">ì„œë²„ì—ì„œ ê³ í™”ì§ˆ ì‚¬ì§„ì„ ì¶”ì¶œ ì¤‘ì…ë‹ˆë‹¤...<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” â³</div>`;
            
            try {
                const res = await fetch(`${API_URL}/restaurants/${db_id}/ai-images?name=${encodeURIComponent(name)}`);
                const data = await res.json();
                
                if (data.images && data.images.length > 0) {
                    let html = '';
                    data.images.forEach(function(img) {
                        html += `<img src="${img}" class="ai-image-item" onclick="selectAIImage('${db_id}', '${img}')" onerror="this.style.display='none'">`;
                    });
                    target.innerHTML = html;
                } else {
                    target.innerHTML = '<div style="grid-column: span 2; text-align:center; padding: 40px 0; color:var(--text-sub); font-size:12px;">ì‚¬ì§„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } catch(e) {}
        }

        async function selectAIImage(db_id, img_url) {
            if (!confirm("ì´ ì‚¬ì§„ìœ¼ë¡œ ì‹ë‹¹ì˜ ëŒ€í‘œ ì´ë¯¸ì§€ë¥¼ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            
            const user = localStorage.getItem('currentUser');
            try {
                const res = await fetch(`${API_URL}/restaurants/${db_id}/image`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'user-id': user },
                    body: JSON.stringify({ image_url: img_url })
                });
                
                if (res.ok) {
                    alert("ëŒ€í‘œ ì‚¬ì§„ì´ ì„±ê³µì ìœ¼ë¡œ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨");
                    document.getElementById('ai-image-modal').style.display = 'none';
                    document.getElementById('restaurant-detail-modal').style.display = 'none';
                    fetchGuideView(user);
                }
            } catch(e) {}
        }

        // ==========================================
        // ğŸŒŸ NEW: ì•Œë¦¼ ì‹œìŠ¤í…œ ì—”ì§„ (Polling & Render)
        // ==========================================
        async function fetchNotifications() {
            const user = localStorage.getItem('currentUser');
            if (!user) return;
            try {
                const res = await fetch(`${API_URL}/notifications`, { headers: { 'user-id': user } });
                if (res.ok) {
                    const data = await res.json();
                    const badge = document.getElementById('noti-badge');
                    if (data.unread_count > 0) {
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch(e) {}
        }

        async function openNotificationModal() {
            document.getElementById('notification-modal').style.display = 'flex';
            const target = document.getElementById('notification-list-target');
            const user = localStorage.getItem('currentUser');
            
            target.innerHTML = `<div style="text-align:center; padding:40px 20px; color:var(--text-sub); font-size:13px;">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>`;
            
            try {
                const res = await fetch(`${API_URL}/notifications`, { headers: { 'user-id': user } });
                const data = await res.json();
                
                if (!data.notifications || data.notifications.length === 0) {
                    target.innerHTML = `<div style="text-align:center; padding:40px 20px; color:var(--text-sub); font-size:13px;">ì•„ì§ ë„ì°©í•œ ì†Œì‹ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                } else {
                    let html = '';
                    data.notifications.forEach(n => {
                        const icon = n.type === 'follow' ? 'ğŸ¤' : n.type === 'like' ? 'â¤ï¸' : n.type === 'comment' ? 'ğŸ’¬' : 'ğŸ””';
                        html += `
                        <div class="noti-item ${n.read ? '' : 'unread'}">
                            <div class="noti-icon">${icon}</div>
                            <div style="flex:1; font-size:13px; color:var(--text-main); line-height:1.4; font-weight:500;">
                                ${n.message}
                            </div>
                        </div>`;
                    });
                    target.innerHTML = html;
                }
                
                // ì˜¤í”ˆ ì‹œ ì „ë¶€ ì½ìŒ ì²˜ë¦¬
                fetch(`${API_URL}/notifications/read`, { method: 'PUT', headers: { 'user-id': user } });
                document.getElementById('noti-badge').style.display = 'none';
                
            } catch(e) {}
        }

        function closeNotificationModal() {
            document.getElementById('notification-modal').style.display = 'none';
        }

        async function executeBookmark(restaurant_id) {
            const user = localStorage.getItem('currentUser');
            try {
                const res = await fetch(`${API_URL}/restaurants/bookmark/${restaurant_id}`, { 
                    method: 'POST', 
                    headers: { 'user-id': user } 
                });
                const data = await res.json();
                alert(data.message || "ìœ„ì‹œë¦¬ìŠ¤íŠ¸ì— ë‹´ì•˜ìŠµë‹ˆë‹¤!");
            } catch(e) {}
        }

        async function executeLike(restaurant_id) {
            const user = localStorage.getItem('currentUser');
            try {
                const res = await fetch(`${API_URL}/restaurants/${restaurant_id}/like`, { 
                    method: 'POST', 
                    headers: { 'user-id': user } 
                });
                if (res.ok) {
                    const data = await res.json();
                    const countEl = document.getElementById(`like-count-${restaurant_id}`);
                    if (countEl) countEl.innerText = data.likes_count;
                    
                    const btn = document.getElementById(`like-btn-${restaurant_id}`);
                    if (btn) { 
                        if (data.liked) {
                            btn.classList.add('liked'); 
                        } else {
                            btn.classList.remove('liked'); 
                        }
                    }
                }
            } catch(e) {}
        }

        function recommendAIComment() {
            const name = document.getElementById('h-name').value || "ì´ ê³³";
            const cat = document.getElementById('h-cat').value || "";
            
            const comments = {
                "ê³ ê¸°": [`ì…ì•ˆ ê°€ë“ í¼ì§€ëŠ” ìœ¡ì¦™ì´ ì˜ˆìˆ ì¸ ${name}!`, `ê³ ê¸° í€„ë¦¬í‹°ê°€ ë‚¨ë‹¤ë¥¸ ${name}, ê°•ë ¥ ì¶”ì²œí•©ë‹ˆë‹¤.`, `íšŒì‹ì´ë‚˜ ëª¨ì„ ì¥ì†Œë¡œ ì†ìƒ‰ì—†ëŠ” ${name}ì…ë‹ˆë‹¤.`],
                "ì¹´í˜": [`ë¶„ìœ„ê¸° ë§›ì§‘ ${name}, ì»¤í”¼ í–¥ì´ ë„ˆë¬´ ì¢‹ì•„ìš”.`, `ë””ì €íŠ¸ì™€ ì»¤í”¼ì˜ ì™„ë²½í•œ ì¡°í™”, ${name}ì—ì„œ íë§í•˜ê³  ê°‘ë‹ˆë‹¤.`, `ì¸í…Œë¦¬ì–´ê°€ ì˜ˆë»ì„œ ì‚¬ì§„ ì°ê¸° ì¢‹ì€ ${name}!`],
                "ì¼ì‹": [`ì‹ ì„ í•œ ì¬ë£Œê°€ ë‹ë³´ì´ëŠ” ${name}, í›Œë¥­í•œ ì‹ì‚¬ì˜€ìŠµë‹ˆë‹¤.`, `ì •ê°ˆí•˜ê³  ê¹”ë”í•œ ë§›, ${name}ì—ì„œì˜ í•œ ë¼ëŠ” ìµœê³ ë„¤ìš”.`, `ì…ì—ì„œ ì‚´ì‚´ ë…¹ëŠ” ë§›, ${name} ì¬ë°©ë¬¸ ì˜ì‚¬ 100%ì…ë‹ˆë‹¤.`],
                "ì¤‘ì‹": [`ë¶ˆë§›ì´ ì‚´ì•„ìˆëŠ” ${name}, ìê¾¸ ìƒê°ë‚˜ëŠ” ë§›ì…ë‹ˆë‹¤.`, `ìŠ¤íŠ¸ë ˆìŠ¤ í’€ë¦¬ëŠ” ë§¤ì½¤í•¨! ${name} ì¶”ì²œí•´ìš”.`, `ê¸°ë³¸ê¸°ê°€ íƒ„íƒ„í•œ ì¤‘ì‹ë‹¹, ${name}ì…ë‹ˆë‹¤.`],
                "ì–‘ì‹": [`ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ë¶„ìœ„ê¸°ì™€ ì™„ë²½í•œ í”Œë ˆì´íŒ…, ${name} ìµœê³ !`, `ë°ì´íŠ¸ ì½”ìŠ¤ë¡œ ë”± ì¢‹ì€ ${name}, ì™€ì¸ê³¼ ì°°ë–¡ê¶í•©ì…ë‹ˆë‹¤.`, `íŒŒìŠ¤íƒ€ ì†ŒìŠ¤ê°€ ì •ë§ ê¾¸ë•í•˜ê³  ë§›ìˆëŠ” ${name}!`],
                "default": [`${name}, ê¸°ëŒ€ ì´ìƒìœ¼ë¡œ ë„ˆë¬´ í›Œë¥­í•œ ë¯¸ì‹ ê²½í—˜ì´ì—ˆìŠµë‹ˆë‹¤.`, `ë¶„ìœ„ê¸°, ë§›, ì„œë¹„ìŠ¤ ëª¨ë‘ ë§Œì¡±ìŠ¤ëŸ¬ìš´ ${name}!`, `ìˆ¨ê²¨ì§„ ë³´ì„ ê°™ì€ ${name}, ë‚˜ë§Œ ì•Œê³  ì‹¶ì€ ë§›ì§‘ì´ë„¤ìš”.`]
            };

            let selectedCategory = "default";
            if (cat.includes("ê³ ê¸°") || cat.includes("ë¼ì§€") || cat.includes("ì†Œ") || cat.includes("êµ¬ì´")) selectedCategory = "ê³ ê¸°";
            else if (cat.includes("ì¹´í˜") || cat.includes("ì»¤í”¼") || cat.includes("ë””ì €íŠ¸")) selectedCategory = "ì¹´í˜";
            else if (cat.includes("ì¼ì‹") || cat.includes("ì´ˆë°¥") || cat.includes("ìŠ¤ì‹œ")) selectedCategory = "ì¼ì‹";
            else if (cat.includes("ì¤‘ì‹") || cat.includes("ë§ˆë¼") || cat.includes("ì§œì¥")) selectedCategory = "ì¤‘ì‹";
            else if (cat.includes("ì–‘ì‹") || cat.includes("íŒŒìŠ¤íƒ€") || cat.includes("í”¼ì")) selectedCategory = "ì–‘ì‹";

            const list = comments[selectedCategory];
            const randomComment = list[Math.floor(Math.random() * list.length)];
            
            document.getElementById('post-comment').value = randomComment;
        }

        async function submitComment(restaurant_id) {
            const user = localStorage.getItem('currentUser');
            const input = document.getElementById(`comment-input-${restaurant_id}`);
            const text = input.value.trim();
            if (!text) return;
            
            try {
                const res = await fetch(`${API_URL}/restaurants/${restaurant_id}/comment`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'user-id': user },
                    body: JSON.stringify({ text: text })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    input.value = '';
                    renderComments(restaurant_id, data.comments);
                }
            } catch(e) {}
        }

        function renderComments(restaurant_id, comments) {
            const listEl = document.getElementById(`comment-list-${restaurant_id}`);
            if (!listEl) return;
            
            if (!comments || comments.length === 0) {
                listEl.innerHTML = `<div style="color:var(--text-sub); font-size:12px; text-align:center;">${currentLang==='ko'?'ì²« ë°©ëª…ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”.':'Leave the first comment.'}</div>`;
                return;
            }
            
            let html = '';
            comments.forEach(function(c) {
                html += `
                <div class="comment-item">
                    <b style="color:var(--text-main); font-weight:700;">${c.user}</b> 
                    <span style="color:var(--text-sub); margin-left:4px;">${c.text}</span>
                </div>`;
            });
            listEl.innerHTML = html;
            listEl.scrollTop = listEl.scrollHeight;
        }

        async function handleLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            if (!u || !p) return alert(currentLang === 'ko' ? "ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”." : "Please enter details.");
            
            try {
                const res = await fetch(`${API_URL}/login`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({username: u, password: p}) 
                });
                const data = await res.json();
                
                if (res.ok) { 
                    localStorage.setItem('currentUser', data.username); 
                    followingList = data.following || []; 
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    initApp(); 
                } else { 
                    alert(data.detail); 
                }
            } catch(e) { 
                alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); 
            }
        }

        async function handleSignup() {
            const u = document.getElementById('login-user').value; 
            const p = document.getElementById('login-pass').value;
            if (!u || !p) return alert("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            
            try {
                const res = await fetch(`${API_URL}/signup`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({username: u, password: p}) 
                });
                alert((await res.json()).message);
            } catch (e) {}
        }

        function handleLogout() { 
            localStorage.removeItem('currentUser'); 
            location.reload(); 
        }

        function initApp() { 
            const user = localStorage.getItem('currentUser'); 
            if (user) { 
                document.getElementById('login-section').style.display = 'none'; 
                document.getElementById('main-content').style.display = 'block'; 
                switchTab('home'); 
                fetchNotifications(); // ğŸŒŸ ë¡œê·¸ì¸ ì‹œ ìƒˆ ì•Œë¦¼ í™•ì¸
            } else {
                document.getElementById('login-section').style.display = 'flex';
                document.getElementById('main-content').style.display = 'none';
            }
        }

        function openEditProfileModal() {
            document.getElementById('edit-nickname-input').value = document.getElementById('display-profile-name').innerText;
            document.getElementById('edit-philosophy-input').value = currentProfilePhilosophy;
            document.getElementById('edit-dna-input').value = currentProfileTags.join(', ');
            document.getElementById('edit-personal-info').value = currentProfilePersonalInfo;
            
            document.getElementById('edit-profile-modal').style.display = 'flex';
        }

        function closeEditProfileModal() {
            document.getElementById('edit-profile-modal').style.display = 'none';
        }

        function submitProfileEdit() {
            const newName = document.getElementById('edit-nickname-input').value.trim();
            if (!newName) {
                alert(currentLang === 'ko' ? "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." : "Please enter a name.");
                return;
            }
            
            const rawTags = document.getElementById('edit-dna-input').value.split(',');
            const tagsArray = rawTags.map(t => t.trim()).filter(t => t !== "");
            
            document.getElementById('display-profile-name').innerText = newName;
            
            fetch(`${API_URL}/user/update-profile`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'user-id': localStorage.getItem('currentUser') },
                body: JSON.stringify({ 
                    nickname: newName, 
                    personal_info: document.getElementById('edit-personal-info').value,
                    philosophy: document.getElementById('edit-philosophy-input').value.trim(),
                    taste_tags: tagsArray
                })
            });
            
            alert(currentLang === 'ko' ? "í”„ë¡œí•„ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨" : "Profile successfully updated! âœ¨");
            closeEditProfileModal();
            fetchGuideView(localStorage.getItem('currentUser')); 
        }

        window.onload = function() { 
            if (typeof kakao !== 'undefined' && kakao.maps) {
                kakao.maps.load(function() {
                    console.log("Kakao Map Ready");
                }); 
            }
            
            const splash = document.getElementById('splash-screen');
            setTimeout(function() {
                fetchUserProfiles(); 
                
                if (splash) { 
                    splash.style.opacity = '0'; 
                    setTimeout(function() { 
                        splash.style.display = 'none'; 
                        initApp(); 
                    }, 800); 
                } else { 
                    initApp(); 
                }
            }, 1800);
        };
    </script>
</body>
</html>
